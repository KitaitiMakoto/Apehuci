<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta name=description content="北市真の日記"><meta content="width=device-width,initial-scale=1.0" name=viewport><title>アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:description content="北市真の日記"><meta name=og:title content="アペフチ"><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"><meta name=robots content="noindex,follow"></head><body class="page page_2 page_2_index"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed condenses effects=waterfall slot=header><app-toolbar></app-toolbar><app-toolbar sticky><h1 class=site-title><a href="../../">アペフチ</a></h1></app-toolbar></app-header><article><paper-card elevation=2><a href="../../2016/12/24.html"><h1>アドカレ #コルクおすすめ2016 24日目 センター試験直前に、三田紀房『ドラゴン桜』後半</h1><time pubdate>2016-12-24</time></a><ul class=tags><li><a href="../../tags/.html" rel=tag>まんが</a></li></ul><p>アドベントカレンダー「<a href="http://www.adventar.org/calendars/1885">年末年始おすすめ作品　BY.CORK Advent Calendar 2016</a>」の24日目です。</p><p>さて、アドベントカレンダー、クリスマスイブ担当という大役を仰せつかってしまったが（単に人がいなかっただけだが……くそっ、リア充どもめ）、実のところ、この日に相応しい作品が思い付かない。ほぼ唯一の持ちネタである今敏の『東京ゴッドファーザーズ』は、21日担当のまつおかさんに取られてしまった。</p><blockquote class=twitter-tweet data-lang=ja><p lang=ja dir=ltr>冬休みにみたい作品①東京ゴッドファーザーズ<br/>3人のホームレスの主人公たちに訪れる、クリスマスの日の奇跡。いくつもの奇跡が重なって展開されるストーリーの運びと様々なドラマがみどころ！人間くさい描写や数々な愛のかたちに、あたたかい気持ちになれます。<a href="https://twitter.com/hashtag/%E3%82%B3%E3%83%AB%E3%82%AF%E3%81%8A%E3%81%99%E3%81%99%E3%82%812016?src=hash">#コルクおすすめ2016</a><a href="https://t.co/jR5FmtH78Y">pic.twitter.com/jR5FmtH78Y</a></p>&mdash; まつおか ゆう (@108mlps) <a href="https://twitter.com/108mlps/status/811511915780288512">2016年12月21日</a></blockquote><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script><p>ディケンズの『<a href="http://www1.bbiq.jp/kareha/trans/html/christmas_carol,_a_(katokt).html">クリスマスキャロル</a>』も定番で外れが無いと思うのだが、そう言えば、半分くらいまで読んで止まっているのだった。日本に寄せて恋愛ものを選ぶとしても、僕が好きな恋愛ものジャンルは浮気・不倫なので、こんな日に相応しくない（いや、ある意味、リアルで、相応しいかも知れんが……）。</p><p>ということでクリスマスイブっぽいのは諦めました。アドベントカレンダーの趣旨に戻って、年末年始におすすめする物を選びます。</p><h2 id=section>三田紀房『ドラゴン桜』</h2><p><a class=magnet-viewer-embed data-orientation=landscape data-spread=auto href="https://magnet.vc/v/a8zvd3s">ドラゴン桜 (1)</a><script src="https://magnet.vc/embed_js" defer=defer></script></p><p>年末年始特に意識すると言えば、センター試験だ。僕は塾の先生から、休憩を取ることの大切さ、取るタイミングについて教えてもらって、守っていた。年末年始はきちんと休んだし、試験の前日も勉強は一切せず、のんびり、気になっていた本を読んでいた（その代わり他の日は頑張って勉強していて、特に嫌いな英語は、このままやってたら気が狂いそうだと自分で感じていた……）。大工の祖父が家の車庫にバスケットゴールを取り付けてくれたので、毎日、休憩がてら、ひたすらシュートしていた（そのお陰で、文科系部活のくせに、体育のバスケットボールでめっちゃ得点してた）。</p><p>このやり方が他の人にも合うかはもちろん分からないが、「この時期にはもうメンタル面が非常に大きなウェイトを占める」「メンタルは身体の影響を強く受ける」「なので休憩などを上手に（好きなだけ、ではない）取ることがとても大事」という点については衆目の一致が見られるんではないかと思う（未確認）。</p><p>その時期のドラマが、三田紀房の『ドラゴン桜』で描かれている。テレビ版は観ていないのと、この作品について誰かと話したこともないので、世間一般のイメージは分からないけれど、僕は「一見破天荒な受験テクニックを色々紹介しているまんが」という印象で記憶していた。ところが、コルクに入社するにあたって読み直してみたら（作者の三田紀房さんのエージェントをしています）、後半に入ると、精神面をどう受験に向けていいコンディションに持っていくかという話がメインだった。心や気持ちの問題だし、自分が通過してきたことで感情移入もしやすく、共感さるシーンが多い。</p><p>特に好きなのが、二人いる主人公の一人、矢島が、父親の車に乗るところ。父親のことを嫌っておりほとんど話さない矢島だけど、先生のアドバイスもあって、少し心を開きかけ、でもまた悶着あって忌避感を覚えていた頃、たまたま、家を出るタイミングが父親とかぶる。車に乗れ、送って行くと言う父親。黙って乗る矢島。そして、降りるまで、一言も話さない。「降り際に何か一言くらい言うのかな」と思って読んでいたけれど、どちらも何も発さない。コミュニケーションのないまま、車のシーンは終わる。ここでものすごく「そうだよね！」という気持ちになり、その気持ちが何なのか分からないせいで、今に至るまで記憶に残っているのだ。</p><p>こういう、言葉にならない気持ちを抱かせるシーンが後半には色々と出てくるのでぜひ、これから受験する人、受験したことある人に読んでほしい。ただ、そこに至るまで10巻くらいを費やしていて、上に三巻までの試し読みを貼りはしたけど、正直、前半は飛ばして10巻、11巻くらいから読むのが、（年末年始のタイミングでは）いいのではないかと思ってる。</p><p>最後に、自社のことなので宣伝。三田紀房さんの公式サイトはこちら。『ドラゴン桜』にちなんで受験に関する記事なんかも載っています。</p><p>三田紀房公式サイト - <a href="http://mitanorifusa.com/">http://mitanorifusa.com/</a></p><p>明日の担当は<a href="https://twitter.com/marimo_cork">中山マリモ</a>さん、アドカレの予告には「ラブ・マスターX／安野モヨコ」と書いてあって、ほう……。</p></paper-card></article><article><paper-card elevation=2><a href="../../2016/12/21.html"><h1>Railsでの検索機能にgroonga-client-railsを使う（後編）</h1><time pubdate>2016-12-21</time></a><ul class=tags><li><a href="../../tags/ruby-on-rails.html" rel=tag>Ruby on Rails</a></li><li><a href="../../tags/groonga.html" rel=tag>Groonga</a></li></ul><p>アドベントカレンダー「<a href="http://qiita.com/advent-calendar/2016/groonga">Groonga Advent Calendar 2016</a>」の21日目です、書いているのは25日ですが……済みません</p><p>前回の<a href="18.html">Railsでの検索機能にgroonga-client-railsを使う（前編）</a>では、<a href="https://github.com/ranguba/groonga-client-rails">groonga-client-rails</a> gemを使って</p><ul><li>Groongaのデータベースを作ること</li><li>Railsのモデル操作とGroongaデータベースの同期を取ること</li></ul><p>をやりました。</p><p>後編の今日は、Groongaデータベースを使って、Railsアプリに検索機能を付けてみようと思います。</p><p>引き続きアプリケーションのリポジトリーをGitHubに置いています：<a href="https://github.com/KitaitiMakoto/groonga-client-rails-sample">KitaitiMakoto/groonga-client-rails-sample</a></p><h2 id=heading-2016-12-21-table-of-contents>目次</h2><ol><li><a href="#heading-2016-12-21-adding-route">ルーティングの追加</a></li><li><a href="#heading-2016-12-21-adding-search-action">検索アクションの追加</a></li><li><a href="#heading-2016-12-21-showing-search-result">検索結果の表示</a></li><li><a href="#heading-2016-12-21-adding-search-form">検索フォームの作成</a></li><li><a href="#heading-2016-12-21-highlighting-query">検索語のハイライト</a></li><li><a href="#heading-2016-12-21-advanced-search">高度な検索（カラムの指定、並び替え、ページネーション）</a></li></ol><h2 id=heading-2016-12-21-adding-route>ルーティングの追加</h2><p>検索用のルーティングを追加します。</p><ul><li><code class=highlighter-rouge>posts?q=xxx</code>と既存のコレクションリソースを使ってクエリーで検索機能を呼び出す</li><li><code class=highlighter-rouge>posts/search</code>と検索専用のリソースを追加する</li></ul><p>の二通りあり、アプリケーション全体のデザインで選ぶべき物だと思いますが、ここでは後者にします。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="c1"># config/routes.rb</span>

<span class="n">resources</span> <span class="ss">:posts</span> <span class="k">do</span>
  <span class="n">collection</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:search</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><h2 id=heading-2016-12-21-adding-search-action>検索アクションの追加</h2><p><code class=highlighter-rouge>PostsController</code>に検索アクションを追加します。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="c1"># app/controllers/posts_controller.rb</span>

<span class="k">def</span> <span class="nf">search</span>
  <span class="n">searcher</span> <span class="o">=</span> <span class="no">PostsSearcher</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">query</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:q</span><span class="p">]</span>
  <span class="k">if</span> <span class="n">query</span><span class="p">.</span><span class="nf">blank?</span>
    <span class="n">redirect_to</span> <span class="ss">action: </span><span class="s2">"index"</span>
    <span class="k">return</span>
  <span class="k">end</span>
  <span class="vi">@posts</span> <span class="o">=</span> <span class="n">searcher</span><span class="p">.</span><span class="nf">search</span><span class="p">.</span>
             <span class="nf">query</span><span class="p">(</span><span class="n">query</span><span class="p">).</span>
             <span class="nf">result_set</span><span class="p">.</span><span class="nf">records</span>
<span class="k">end</span>
</code></pre></div><p>（モデルの代わりに）サーチャークラスをインスタンス化し、クエリーを組み立てていきます。</p><p>検索の開始には<code class=highlighter-rouge>#search</code>メソッドを呼び出します。これでクエリー組み立ての準備が整います（クエリーオブジェクトが返されます）。</p><p><code class=highlighter-rouge>query</code>メソッドに文字列を渡すことで、検索語を認識させます。</p><p><code class=highlighter-rouge>result_set</code>を呼ぶとリモートのGroongaサーバーにHTTPリクエストを送って検索結果を取得します。</p><p><code class=highlighter-rouge>records</code>によって、それをRubyのオブジェクトに変換して返します。</p><h2 id=heading-2016-12-21-showing-search-result>検索結果の表示</h2><p>検索結果を表示します。<code class=highlighter-rouge>app/views/posts/index.html.erb</code>を<code class=highlighter-rouge>app/views/posts/search.html.erb</code>にコピーし、ActiveModel依存の所を書き換えます。</p><div class="language-erb highlighter-rouge"><pre class=highlight><code><span class="c">&lt;!-- app/views/posts/search.html.erb --&gt;</span>

<span class="nt">&lt;h1&gt;</span>Posts<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;table&gt;</span>
  <span class="nt">&lt;thead&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;th&gt;</span>Title<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;th&gt;</span>Body<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;th</span> <span class="na">colspan=</span><span class="s">"3"</span><span class="nt">&gt;&lt;/th&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/thead&gt;</span>

  <span class="nt">&lt;tbody&gt;</span>
    <span class="cp">&lt;%</span> <span class="vi">@posts</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="p">.</span><span class="nf">title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="p">.</span><span class="nf">body</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Show'</span><span class="p">,</span> <span class="n">post_path</span><span class="p">(</span><span class="n">extract_id</span><span class="p">(</span><span class="n">post</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Edit'</span><span class="p">,</span> <span class="n">edit_post_path</span><span class="p">(</span><span class="n">extract_id</span><span class="p">(</span><span class="n">post</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Destroy'</span><span class="p">,</span> <span class="n">post_path</span><span class="p">(</span><span class="n">extract_id</span><span class="p">(</span><span class="n">post</span><span class="p">)),</span> <span class="ss">method: :delete</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">confirm: </span><span class="s1">'Are you sure?'</span> <span class="p">}</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;/tr&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/tbody&gt;</span>
<span class="nt">&lt;/table&gt;</span>

<span class="nt">&lt;br&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'New Post'</span><span class="p">,</span> <span class="n">new_post_path</span> <span class="cp">%&gt;</span>
</code></pre></div><p><code class=highlighter-rouge>extract_id</code>は、レコードデータからIDを取り出すヘルパーです。これも自分で定義します。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="k">module</span> <span class="nn">PostsHelper</span>
  <span class="k">def</span> <span class="nf">extract_id</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
    <span class="n">post</span><span class="p">[</span><span class="s2">"_key"</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s2">"-"</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>Groongaでは、<code class=highlighter-rouge>_key</code>というカラムによって、レコードを一意に特定するのですが、groonga-client-rails（のデフォルト）では、「モデル名-連番」となる（<code class=highlighter-rouge>Post-1</code>）ので、そこからAcitiveRecordのIDに変換しています。</p><p>検索フォームはありませんが、これで一応機能はできました。http://localhost:3000/posts/search?q=Qiita などにアクセスすると、検索結果が見られると思います。</p><h2 id=heading-2016-12-21-adding-search-form>検索フォームの作成</h2><p>次にフォームです。<code class=highlighter-rouge>/posts/search</code>に<code class=highlighter-rouge>q</code>クエリー付きでGETアクセスを投げるだけなので簡単です。</p><div class="language-erb highlighter-rouge"><pre class=highlight><code><span class="c">&lt;!-- app/views/posts/_search_form.html.erb --&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_tag</span><span class="p">(</span><span class="n">search_posts_path</span><span class="p">,</span> <span class="ss">method: </span><span class="s2">"get"</span><span class="p">)</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">search</span> <span class="na">name=</span><span class="s">q</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:q</span><span class="p">]</span> <span class="cp">%&gt;</span><span class="s">"</span> <span class="na">required</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">submit_tag</span><span class="p">(</span><span class="s2">"Search"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div><p>これをそれぞれのテンプレートファイルに埋め込んでやります（省略）。</p><h2 id=heading-2016-12-21-highlighting-query>検索語のハイライト</h2><p>ただ、せっかくだから、検索語が分かりやすくなっていてほしいですよね。また、メモの全文をここで表示してしまうと、長過ぎるという場合もあると思います。両方をいっぺんに解決できる方法として、Groongaの<code class=highlighter-rouge>snippet_html</code>関数があります（<a href="http://groonga.org/ja/docs/reference/functions/snippet_html.html">7.14.17. snippet_html</a>）。</p><p>これは検索語の周辺数十文字（スニペット）を返してくれる関数です。更に、検索語を<code class=highlighter-rouge>&lt;span class="keyword"&gt;...&lt;/span&gt;</code>でマークアップしてくれます（HTML）。</p><p><code class=highlighter-rouge>snippet_html</code>を使うには、Groongaから取得するカラムにこれを指定します。groonga-client-railsはデフォルトで、モデルで設定したカラムを取得してくれます（なので<code class=highlighter-rouge>title</code>と<code class=highlighter-rouge>body</code>が取れていた）。これをカスタマイズするには、クエリーに<code class=highlighter-rouge>output_columns</code>というパラメーターを追加する必要があります（<a href="http://groonga.org/ja/docs/reference/commands/select.html#output-columns">7.3.54.4.4.1. output_columns</a>）。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="c1"># app/controllers/posts_controller.rb</span>

  <span class="vi">@posts</span> <span class="o">=</span> <span class="n">searcher</span><span class="p">.</span><span class="nf">search</span><span class="p">.</span>
             <span class="nf">query</span><span class="p">(</span><span class="n">query</span><span class="p">).</span>
             <span class="nf">output_columns</span><span class="p">(</span><span class="s1">'_key,title,snippet_html(body)'</span><span class="p">).</span>
             <span class="nf">result_set</span><span class="p">.</span><span class="nf">records</span>
</code></pre></div><p>これで、「<code class=highlighter-rouge>body</code>カラムでの検索結果にはスニペットを取得する」という意味になります。</p><p>これに合わせてビューも変えなくてはいけません。</p><div class="language-erb highlighter-rouge"><pre class=highlight><code>        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span><span class="o">=</span> <span class="n">post</span><span class="p">.</span><span class="nf">snippet_html</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"&lt;br&gt;"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
</code></pre></div><p>HTMLを埋め込むので<code class=highlighter-rouge>=</code>を<code class=highlighter-rouge>==</code>にしています。また、結果は配列になっているので（一つのメモの離れた所に検索語がある場合、それぞれの周辺を取得します）改行で接続します。</p><p>先述の通り、検索語はマークアップされるので、スタイリングしましょう。</p><div class="language-css highlighter-rouge"><pre class=highlight><code><span class="c">/* app/assets/stylesheets/posts.scss */</span>

<span class="nc">.keyword</span> <span class="p">{</span>
  <span class="nl">font-weight</span><span class="p">:</span> <span class="nb">bolder</span><span class="p">;</span>
  <span class="nl">color</span><span class="p">:</span> <span class="no">red</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>これで、検索語が赤い太字になりました。</p><p>何とか見られる結果になったんではないでしょうか。 <img src="https://gyazo.com/2cc4ffc1487555bbd51fe768f6c7fcac.png" alt=""/></p><h2 id=heading-2016-12-21-advanced-search>高度な検索（カラムの指定、並び替え、ページネーション）</h2><p>Groongaでは、検索の際に様々な条件を付け加えたり、結果を加工したりできます。機能の詳細はドキュメント（<a href="http://groonga.org/ja/docs/reference/commands/select.html">7.3.54. select</a>）に譲りますが、ここでは以下の三つに対応してみましょう。</p><dl><dt>match_columns</dt><dd>検索に使用するカラムを試定。例えば「検索語がタイトルに含まれる場合のみ表示する」など。</dd><dt>sortby</dt><dd>指定したカラムで並び替える。</dd><dt>paginate</dt><dd>検索結果が多過ぎる場合にページネーションします。</dd></dl><p>と言っても簡単で、クエリーオブジェクトから、それぞれのメソッドを呼び出すだけです。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="c1"># app/controllers/posts_controller.rb</span>

  <span class="vi">@posts</span> <span class="o">=</span> <span class="n">searcher</span><span class="p">.</span><span class="nf">search</span><span class="p">.</span>
             <span class="nf">query</span><span class="p">(</span><span class="n">query</span><span class="p">).</span>
             <span class="nf">output_columns</span><span class="p">(</span><span class="s1">'_key,title,snippet_html(body)'</span><span class="p">)</span>
  <span class="p">[</span><span class="ss">:match_columns</span><span class="p">,</span> <span class="ss">:sortby</span><span class="p">,</span> <span class="ss">:paginate</span><span class="p">].</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">param</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">].</span><span class="nf">present?</span>
      <span class="vi">@posts</span> <span class="o">=</span> <span class="vi">@posts</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="vi">@posts</span> <span class="o">=</span> <span class="vi">@posts</span><span class="p">.</span><span class="nf">result_set</span><span class="p">.</span><span class="nf">records</span>
</code></pre></div><p>これにフォームを対応させれば出来上がりです。</p><p>例えば、タイトルで並び替えした場合はこうなります。 <img src="https://gyazo.com/969feded70e51520aab4962369291908.png" alt=""/></p><p>並び順を逆にするには、カラム名の前にマイナス記号（<code class=highlighter-rouge>-</code>）を付けます。 <img src="https://gyazo.com/b117f1fc42863df60684437bcc2298c5.png" alt=""/></p><p>どうでしたか、groonga-client-railsは、無理にActiveModel風にしない所が気に入っていたりします……と言っている間に、開発者の<a href="https://github.com/kou">@kou</a>さんがよりちゃんとした記事を書いていました、締め切り破って済みませんでした……。</p><p>» <a href="http://www.clear-code.com/blog/2016/12/22.html">Ruby on RailsでMySQL・PostgreSQL・SQLite3とGroongaを使って日本語全文検索を実現する方法</a></p></paper-card></article><article><paper-card elevation=2><a href="../../2016/12/18.html"><h1>Railsでの検索機能にgroonga-client-railsを使う（前編）</h1><time pubdate>2016-12-18</time></a><ul class=tags><li><a href="../../tags/ruby-on-rails.html" rel=tag>Ruby on Rails</a></li><li><a href="../../tags/groonga.html" rel=tag>Groonga</a></li></ul><p>今日の日記は<a href="http://qiita.com/advent-calendar/2016/groonga">Groonga Advent Calendar 2016</a>の18日目です。</p><p>今日はRailsアプリケーションに検索機能を付けるのに、groonga-client-rails gemを使う方法を、サンプルアプリケーションを作りながら紹介したいと思います。長くなったので……というか、準備と書く時間の見積もりを誤ったので、前後編に分けます。前編の今日はインストールからRailsのモデルと検索機能を結び付ける（言い回しが分かりにくいと思いますがあとで分かります）まで紹介し、後編では検索用のUIを作ろうと思います。</p><p>以下の環境で動作確認をしています。</p><ul><li>OS … OS X El Capitan 10.11.6</li><li>Ruby … 2.3.3</li><li>Groonga … 6.1.1</li><li>Ruby on Rails … 5.0.0.1</li><li>groonga-client-rails … 0.9.4</li></ul><h2 id=heading-2016-12-18-table-of-contents>目次</h2><ol><li><a href="#heading-2016-12-18-groonga-client-rails">groonga-client-railsとは</a></li><li><a href="#heading-2016-12-18-about-sample-app">サンプルアプリケーションについて</a></li><li><a href="#heading-2016-12-18-installing-active-groonga-rails">インストール</a></li><li><a href="#heading-2016-12-18-scaffolding">基本機能の作成</a></li><li><a href="#heading-2016-12-18-tie-app-and-search-feature">検索機能との結び付け</a><ol><li><a href="#heading-2016-12-18-booing-groonga">Groongaの起動</a></li><li><a href="#heading-2016-12-18-creating-searcher">サーチャークラスの作成</a></li><li><a href="#heading-2016-12-18-tie-model-and-searcher">モデルクラスとサーチャークラスとの結び付け</a></li><li><a href="#heading-2016-12-18-synchronizing-data">データの同期</a></li></ol></li><li><a href="#heading-2016-12-18-appendix-searching">おまけ - 検索して遊ぶ</a></li></ol><h2 id=heading-2016-12-18-groonga-client-rails>groonga-client-railsとは</h2><p><a href="https://github.com/ranguba/groonga-client-rails">groonga-client-rails</a>は、<a href="http://rubyonrails.org/">Ruby on Rails</a>に検索用の機能を提供するgemです。バックエンドの検索エンジンに<a href="http://groonga.org/ja/">Groonga</a>を使っています。以前、RailsにGroongaの検索機能を提供するgemとして<a href="https://github.com/ranguba/activegroonga">ActiveGroonga</a>を紹介しましたが（<a href="http://qiita.com/KitaitiMakoto/items/e518a51a804896f9f062">RailsでActiveGroongaを使う</a>）、groonga-client-railsはこれとは別アプローチのgemです。</p><p>ActiveGroonga（が内部で使っている<a href="http://ranguba.org/rroonga/ja/">Rroonga</a>）はローカルのファイルシステムにGroongaのデータベースを作成し、そこにC API経由でアクセスします。このため、インストール時にCのコンパイルが走り、RailsサーバーとGroongaデータベースは同じマシン上に存在する必要がありました。スケールアウトさせる際にはGroongaデータベースの同期が課題にもなります。</p><p>groonga-client-railsが使うGroongaはリモートサーバーです。GroongaはC API経由でアクセスするほかに、HTTPサーバーとして動作し、HTTPクライアントでアクセスしてデータの投入と検索を行うこともできます（GQTPというGroonga独自のプロトコルも使えます）。この用途に向けた<a href="https://github.com/ranguba/groonga-client">groonga-client</a>というgemがあり、それをRailsで使いやすくしたのがgroonga-client-railsです。</p><p>groonga-client-railsでは、<a href="http://guides.rubyonrails.org/active_job_basics.html">ActiveJob</a>の<code class=highlighter-rouge>XxxJob</code>、<a href="https://github.com/carrierwaveuploader/carrierwave">CarrierWave</a>の<code class=highlighter-rouge>XxxUploader</code>のような<code class=highlighter-rouge>XxxSearcher</code>というサーチャークラスを作って検索エンジンへのアクセスを抽象化します。サーチャーの作り方は後述しますが、モデルクラス一つと対応付けられ、モデルの（RDBMSやMongoDBなどへの）保存・更新・削除とGroongaの対応テーブルとの同期を取ったり、対応テーブルからの検索用APIを提供したりします。うまくインターフェイスを揃えればElsticsearchとかも同じクラスで扱えるかも？</p><h2 id=heading-2016-12-18-about-sample-app>サンプルアプリケーションについて</h2><p>サンプルとして、SQLite3のpostsテーブルにメモを入れたり読んだりするだけの簡単なRailsアプリケーションを使って、groonga-client-railsを導入していきます。</p><p>ソースコードはこちら： <a href="https://github.com/KitaitiMakoto/groonga-client-rails-sample">KitaitiMakoto/groonga-client-rails-sample</a></p><p>上で「groonga-client-railsが使うGroongaはリモートサーバーです。」と書きましたが、今回はGroongaもRailsも同じローカルマシンで動かして、127.0.0.1でHTTPでアクセスさせようと思います。</p><p>なお、アプリケーション作成においては<a href="https://github.com/ranguba/groonga-client-rails/tree/master/test/apps">groonga-client-railsのテストディレクトリー</a>を大いに参考しました。ほぼまんまです。</p><h2 id=heading-2016-12-18-installing-active-groonga-rails>インストール</h2><p>Groongaのインストールは公式サイトのドキュメント（<a href="http://groonga.org/ja/docs/install.html">2. インストール</a>）を見ながらやってください。日本語を扱うと思うので、MeCabトークナイザーもインストールしておくといいと思います（これもドキュメントに記載があります）。</p><p>OS XであればHomebrewでインストールできます：</p><div class=highlighter-rouge><pre class=highlight><code>% brew install groonga --with-mecab
% brew install mecab-ipadic
</code></pre></div><p>groonga-client-railsのインストールは、いつも通りGemfileに</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="n">gem</span> <span class="s1">'groonga-client-rails'</span>
</code></pre></div><p>と書いて</p><div class=highlighter-rouge><pre class=highlight><code>% bundle install --path=vendor/bundle
</code></pre></div><p>です。</p><p>軽く確認しておきましょう。</p><div class=highlighter-rouge><pre class=highlight><code>% ./bin/rails --help | grep groonga
 groonga:sync                       # Synchronize Groonga database with model data
</code></pre></div><p>タスクが追加されていますね。後で実際に使ってみます。</p><h2 id=heading-2016-12-18-scaffolding>基本機能の作成</h2><p>postsを読み書きするための土台を作ります。</p><div class=highlighter-rouge><pre class=highlight><code>% ./bin/rails generate scaffold post title:string body:text
Expected string default value for '--jbuilder'; got true (boolean)
      invoke  active_record
      create    db/migrate/20161217142208_create_posts.rb
      create    app/models/post.rb
      invoke    test_unit
      create      test/models/post_test.rb
      create      test/fixtures/posts.yml
      invoke  resource_route
       route    resources :posts
      invoke  scaffold_controller
      create    app/controllers/posts_controller.rb
      invoke    erb
      create      app/views/posts
      create      app/views/posts/index.html.erb
      create      app/views/posts/edit.html.erb
      create      app/views/posts/show.html.erb
      create      app/views/posts/new.html.erb
      create      app/views/posts/_form.html.erb
      invoke    test_unit
      create      test/controllers/posts_controller_test.rb
      invoke    helper
      create      app/helpers/posts_helper.rb
      invoke      test_unit
      invoke    jbuilder
      create      app/views/posts/index.json.jbuilder
      create      app/views/posts/show.json.jbuilder
      create      app/views/posts/_post.json.jbuilder
      invoke  assets
      invoke    coffee
      create      app/assets/javascripts/posts.coffee
      invoke    scss
      create      app/assets/stylesheets/posts.scss
      invoke  scss
      create    app/assets/stylesheets/scaffolds.scss
Generate posts scaffold
</code></pre></div><p>追加されたファイルを見てみます。</p><div class=highlighter-rouge><pre class=highlight><code>% git status
On branch master
Changes not staged for commit:
  (use "git add &lt;file&gt;..." to update what will be committed)
  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)

	modified:   config/routes.rb

Untracked files:
  (use "git add &lt;file&gt;..." to include in what will be committed)

	app/assets/javascripts/posts.coffee
	app/assets/stylesheets/posts.scss
	app/assets/stylesheets/scaffolds.scss
	app/controllers/posts_controller.rb
	app/helpers/posts_helper.rb
	app/models/post.rb
	app/views/posts/
	config/groonga_client.yml
	db/migrate/
	test/controllers/posts_controller_test.rb
	test/fixtures/posts.yml
	test/models/post_test.rb

no changes added to commit (use "git add" and/or "git commit -a")
</code></pre></div><p><code class=highlighter-rouge>config/groonga_client.yml</code>というファイルが出来ていますね（ジェネレーターのアウトプットには出て来ないので、見逃しそうでした）。中身はこうです。</p><div class="language-yaml highlighter-rouge"><pre class=highlight><code><span class="s">default</span><span class="pi">:</span> <span class="nl">&amp;default</span>
  <span class="s">protocol</span><span class="pi">:</span> <span class="s">http</span>
  <span class="c1"># protocol: https</span>
  <span class="s">host</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
  <span class="s">port</span><span class="pi">:</span> <span class="s">10041</span>
  <span class="c1"># user: alice</span>
  <span class="c1"># password: secret</span>
  <span class="s">read_timeout</span><span class="pi">:</span> <span class="s">-1</span>
  <span class="c1"># read_timeout: 3</span>
  <span class="s">backend</span><span class="pi">:</span> <span class="s">synchronous</span>

<span class="s">development</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*default</span>

<span class="s">test</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*default</span>
  <span class="s">port</span><span class="pi">:</span> <span class="s">20041</span>

<span class="s">production</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*default</span>
  <span class="s">host</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
  <span class="s">read_timeout</span><span class="pi">:</span> <span class="s">10</span>
</code></pre></div><p>何となく分かると思います。10041番ポートは、GroongaのHTTPサーバーを起動する時のデフォルトポートです。</p><p>Groongaについては一先ず置いておいて、RDB（SQLite3）の作成とマイグレーションをします。</p><div class=highlighter-rouge><pre class=highlight><code>% ./bin/rails db:migrate
== 20161217142208 CreatePosts: migrating ======================================
-- create_table(:posts)
   -&gt; 0.0014s
== 20161217142208 CreatePosts: migrated (0.0015s) =============================
</code></pre></div><p>http://localhost:3000/posts にアクセスすると、アプリケーションが動いているのが確認できると思います。</p><p style="overflow: auto; border: solid 1px lightgray;"><img alt="入力画面" src="https://gyazo.com/fcdf0c0bcc926d745705d71855430643.png" style="float: left; box-sizing: border-box; width: 50%; border-right: dashed 1px lightgray;"/><img alt="入力結果" src="https://gyazo.com/96b03a960a84f5c92564cc2a23211e51.png" style="width: 50%;"/></p><h2 id=heading-2016-12-18-tie-app-and-search-feature>検索機能との結び付け</h2><h3 id=heading-2016-12-18-booing-groonga>Groongaの起動</h3><p>サンプルアプリと検索機能を結び付ける前に、まずGroongaを起動しておきましょう。</p><div class=highlighter-rouge><pre class=highlight><code>% groonga --protocol http -s -n db/groonga.db
</code></pre></div><p><code class=highlighter-rouge>-n</code>は「新しくデータベースを作る」というオプションで、Groongaデータベースがまだない時に一度だけ指定します。二度目以降は不要なので</p><div class=highlighter-rouge><pre class=highlight><code>% groonga --protocol http -s db/groonga.db
</code></pre></div><p>として起動します。</p><p>終了させるには<kbd><kbd>Ctrl</kbd>+<kbd>C</kbd></kbd>でSIGINTを送ります（デーモンモードなどについてはドキュメントを見てください）。</p><p><code class=highlighter-rouge>db/groonga.db</code> は指定したパス（及びそれをプリフィクスとしたパス）にデータベースファイルを作成するという意味です。Railsのdbディレクトリーを指定しています。</p><p>サーバーモードのGroongaは、検索用のAPIの他に人間用の管理インターフェイスも持っています。http://localhost:10041/ にアクセスしてみてください。</p><p><img src="https://gyazo.com/6af787d2595fc2ea9e17b9da53f442b0.png" alt="Groonga管理画面"/></p><p>まだテーブルの作成すらしていないので、左側の「List of table」欄には何もありません。</p><h3 id=heading-2016-12-18-creating-searcher>サーチャークラスの作成</h3><p>RailsアプリとGroongaとの結び付けをするサーチャークラスを作成します。サーチャークラスはモデルクラス一つにつき一つまで作成することができます<sup id="fnref:1"><a href="#fn:1" class=footnote>1</a></sup>。不要なモデルについては、当然作る必要はありません。</p><p>ここでは<code class=highlighter-rouge>Post</code>モデルしかないのでこれに対応するクラスを作成するのですが、他の種類のクラスの例に漏れず、まず<code class=highlighter-rouge>app/searchers/application_searcher.rb</code>ファイルに<code class=highlighter-rouge>ApplicationSearcher</code>クラスを作りましょう。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="k">class</span> <span class="nc">ApplicationSearcher</span> <span class="o">&lt;</span> <span class="no">Groonga</span><span class="o">::</span><span class="no">Client</span><span class="o">::</span><span class="no">Searcher</span>
<span class="k">end</span>
</code></pre></div><p>次に<code class=highlighter-rouge>PostsSearcher</code>クラスを<code class=highlighter-rouge>app/searchers/posts_searcher.rb</code>に作ります。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="k">class</span> <span class="nc">PostsSearcher</span> <span class="o">&lt;</span> <span class="no">ApplicationSearcher</span>
  <span class="n">schema</span><span class="p">.</span><span class="nf">column</span> <span class="ss">:title</span><span class="p">,</span> <span class="p">{</span>
    <span class="ss">type: </span><span class="s2">"ShortText"</span><span class="p">,</span>
    <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span>
    <span class="ss">index_type: :full_text_search</span>
  <span class="p">}</span>
  <span class="n">schema</span><span class="p">.</span><span class="nf">column</span> <span class="ss">:body</span><span class="p">,</span> <span class="p">{</span>
    <span class="ss">type: </span><span class="s2">"Text"</span><span class="p">,</span>
    <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span>
    <span class="ss">index_type: :full_text_search</span>
  <span class="p">}</span>
  <span class="n">schema</span><span class="p">.</span><span class="nf">column</span> <span class="ss">:updated_at</span><span class="p">,</span> <span class="p">{</span>
    <span class="ss">type: </span><span class="s2">"Time"</span><span class="p">,</span>
    <span class="ss">index: </span><span class="kp">true</span>
  <span class="p">}</span>
<span class="k">end</span>
</code></pre></div><p>何となく分かると思いますが、<code class=highlighter-rouge>schema.column</code>メソッドの第一引数（<code class=highlighter-rouge>:title</code>、<code class=highlighter-rouge>:body</code>、<code class=highlighter-rouge>:updated_at</code>）は、Groonga上の検索条件や結果に使うカラムです（Groongaもカラムとレコードでデータを管理する、テーブル型のデータベースです）。このカラムに検索語が含まれているかとか、範囲内に収まっているかとかで検索することになります。これからGroongaのテーブル上に作成するカラム名なので、RDBMSのカラム名とは違っていてもいいのですが、同じにしておく方が分かりやすいでしょう。</p><p>第二引数でそのカラムの性質を定義します。<code class=highlighter-rouge>type</code>はGroongaのデータ型をします。大体分かると思うので、このまま進めましょう。実際に使う時には公式ドキュメント（<a href="http://groonga.org/ja/docs/reference/types.html">7.4. データ型</a>）を参照してください。</p><p><code class=highlighter-rouge>index</code>はインデックスを張るかどうかで、RDBMSと同様、張れば検索やソートが速くなるし、張らなければストレージやメモリーを節約できます。検索エンジンを導入するという時点で、殆どのカラムに<code class=highlighter-rouge>true</code>を指定することになると思います。「検索結果表示には使うけど、検索条件には使わない」という付随的な情報のカラムでだけ<code class=highlighter-rouge>false</code>にしておきます。</p><p><code class=highlighter-rouge>index_type</code>は、<strong>全文</strong>検索に使うカラムでだけ<code class=highlighter-rouge>:full_text_search</code>を指定します。それ以外の場合は無くて構いません。例えば<code class=highlighter-rouge>:updated_at</code>（日時）は範囲指定に使うことはあっても全文検索には使わないので、ここでも指定されていません。</p><p>他に<code class=highlighter-rouge>vector</code>を<code class=highlighter-rouge>true</code>か<code class=highlighter-rouge>false</code>で指定することができるようで、Groongaのベクター型に対応すると思われます。ベクター型についても詳細はドキュメントを参照してください。「投稿に複数タグを付けられる場合の、タグ」など、配列のように複数の値が入るカラムをベクターにします（この日記のタグもベクターとしてGroonga上のカラムにしています）。</p><p>本来、Groongaのテーブルではもっと細かなチューニングができますが、groonga-client-railsでは（今の所）ライブラリーのおすすめ設定を使うことになります。</p><h3 id=heading-2016-12-18-tie-model-and-searcher>モデルクラスとサーチャークラスとの結び付け</h3><p>次に、<code class=highlighter-rouge>Post</code>モデルに設定を書いて<code class=highlighter-rouge>PostsSearcher</code>と結び付けます。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">searcher</span> <span class="o">=</span> <span class="no">PostsSearcher</span><span class="p">.</span><span class="nf">source</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
  <span class="n">searcher</span><span class="p">.</span><span class="nf">title</span> <span class="o">=</span> <span class="ss">:title</span>
  <span class="n">searcher</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="sr">/&lt;.*?&gt;/</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">searcher</span><span class="p">.</span><span class="nf">updated_at</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre></div><p>この設定をすることでモデルクラスの<code class=highlighter-rouge>after_create</code>、<code class=highlighter-rouge>after_update</code>、<code class=highlighter-rouge>after_destroy</code>フックにコールバックが登録されて、リモートのGroongaサーバーと同期が取れるようになります（なので、これらのフックさえあれば<code class=highlighter-rouge>ActiveRecord</code>以外のクラスでも結び付けられます）。</p><p>ここで<code class=highlighter-rouge>searcher</code>の属性ライター（<code class=highlighter-rouge>title=</code>、<code class=highlighter-rouge>body=</code>、<code class=highlighter-rouge>updated_at=</code>）は、Groongaデータベース側のカラム名を意味しています。右辺には</p><ul><li><code class=highlighter-rouge>Symbol</code></li><li><code class=highlighter-rouge>TrueClass</code></li><li><code class=highlighter-rouge>NilClass</code></li><li><code class=highlighter-rouge>Proc</code>など<code class=highlighter-rouge>#call</code>メソッドを持つオブジェクト</li></ul><p>のいずれかを指定できます。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="n">searcher</span><span class="p">.</span><span class="nf">updated_at</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre></div><p>のように<code class=highlighter-rouge>TrueClass</code>の場合は、モデルクラス（<code class=highlighter-rouge>Post</code>、<code class=highlighter-rouge>posts</code>テーブル）の、左辺と同名の属性・カラム（<code class=highlighter-rouge>updated_at</code>）の値を取得して、その値をGroongaデータベースと同期します。なので実は</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="n">searcher</span><span class="p">.</span><span class="nf">title</span> <span class="o">=</span> <span class="ss">:title</span>
</code></pre></div><p>も</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="n">searcher</span><span class="p">.</span><span class="nf">title</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre></div><p>で構いません。</p><p><code class=highlighter-rouge>Symbol</code>は、「RDBMSのカラム名とGroongaデータベースでのカラム名が違う」といった場合に活きます。</p><p><code class=highlighter-rouge>Proc</code>の場合は見れば分かると思います。<code class=highlighter-rouge>#call</code>の戻り値がGroongaデータベースの該当カラムに挿入されます。ここではHTMLタグっぽい文字列を削除しています。</p><p>最後に<code class=highlighter-rouge>nil</code>の場合は、そのカラムはGroongaデータベースに入りません。「始めは使っていたけど後から使わなくなったカラム」なんかで使うんでしょうかね。</p><h3 id=heading-2016-12-18-synchronizing-data>データの同期</h3><p>さて、これでRDBMS（SQLite3）とGroongaとでデータの同期が取れるようになりました—これからのデータについては。</p><p>この時点ではRailsを再起動したりしても既存のデータが同期されません。既存データを一括同期するためには、groonga-client-railsが提供するRakeタスクを使います。</p><div class=highlighter-rouge><pre class=highlight><code>% ./bin/rails groonga:sync
</code></pre></div><p>これを実行してGroonga管理画面（http://localhost:10041/）にアクセスし「List table」をクリックすると、<code class=highlighter-rouge>posts</code>など今定義したテーブルが出来ているのが分かります。</p><p><img src="https://gyazo.com/2a7c4aeec6463385d813995dba71d185.png" alt="既存のデータがGroongaに同期されてpostsテーブルなどが作成されている"/></p><p><code class=highlighter-rouge>posts</code>の「Detail」ボタンを押すと、既存のレコードが同期されているのが分かります。</p><p>通常のモデルの操作でデータが同期されるのも見ておきましょう。Railsのscaffoldで出来たUIで、データを追加します。</p><p><img src="https://gyazo.com/7263c673910e5c30d519c93a5cd36c7b.png" alt="Railsアプリでレコードを追加する"/></p><p>管理画面を見ると、Groongaにも対応するデータが入っています。</p><p><img src="https://gyazo.com/24979865cd7687e14bcd2f1601633382.png" alt="追加したデータがGroongaに同期されている"/></p><h2 id=heading-2016-12-18-appendix-searching>おまけ - 検索して遊ぶ</h2><p>今日はここまで。次回は検索用のUIを導入しようと思います。</p><p>が、効果を実感しにくい、地道な作業ばかりだったので、少しだけ遊んでみましょう。今日の作業分で、コンソールで検索ができるようになっています。</p><div class=highlighter-rouge><pre class=highlight><code>% ./bin/rails console
</code></pre></div><p>検索では<code class=highlighter-rouge>PostsSearcher#search</code>メソッドから開始して（<code class=highlighter-rouge>where</code>のように）検索クエリーを組み立て、<code class=highlighter-rouge>result_set</code>でGroongaへアクセスして結果を取得します。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="n">searcher</span> <span class="o">=</span> <span class="no">PostsSearcher</span><span class="p">.</span><span class="nf">new</span>
<span class="n">searcher</span><span class="p">.</span><span class="nf">search</span><span class="p">.</span><span class="nf">result_set</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Groonga::Client::Searcher::Select::ResultSet:0x007fd7c4b0f7e0 @response=#&lt;Groonga::Client::Response::Select:0x007fd7c4b1d318 @command=#&lt;Groonga::Command::Select:0x007fd7c4adf388 @command_name="select", @arguments={:table=&gt;"posts", :match_columns=&gt;"title, body"}, @original_format=nil, @original_source=nil, @path_prefix="/d/", @slices={}, @drilldowns=[], @labeled_drilldowns={}&gt;, @header=[0, 1481988639.462895, 0.0001811981201171875], @body=[[[2], [["_id", "UInt32"], ["_key", "ShortText"], ["body", "Text"], ["title", "ShortText"], ["updated_at", "Time"]], [1, "Post-2", "Railsで検索機能を追加する選択肢の一つに、ActiveGroongaで、ActiveRecordのように追加する方法がありますが、これはローカルのデータベースファイルにアクセスするため、スケーラビリティ等に不安がありました。groonga-client-railsなら、リモートのGroongaサーバーにHTTPやGQTPでアクセスできるので、スケーラビリティや保守性をDBやアプリケーションサーバーと別々に考えることができます。", "groonga-client-railsについて", 1481954320.0], [2, "Post-3", "ActiveGroongaは「SQLite3でActiveRecordを使う」のに似ています。詳しくは過去のQiitaの記事などを見てください。", "ActiveGroongaについて", 1481955601.0]]], @n_hits=2, @records=[{"_id"=&gt;1, "_key"=&gt;"Post-2", "body"=&gt;"Railsで検索機能を追加する選択肢の一つに、ActiveGroongaで、ActiveRecordのように追加する方法がありますが、これはローカルのデータベースファイルにアクセスするため、スケーラビリティ等に不安がありました。groonga-client-railsなら、リモートのGroongaサーバーにHTTPやGQTPでアクセスできるので、スケーラビリティや保守性をDBやアプリケーションサーバーと別々に考えることができます。", "title"=&gt;"groonga-client-railsについて", "updated_at"=&gt;2016-12-17 14:58:40 +0900}, {"_id"=&gt;2, "_key"=&gt;"Post-3", "body"=&gt;"ActiveGroongaは「SQLite3でActiveRecordを使う」のに似ています。詳しくは過去のQiitaの記事などを見てください。", "title"=&gt;"ActiveGroongaについて", "updated_at"=&gt;2016-12-17 15:20:01 +0900}], @slices={}, @drilldowns=[], @raw="[[0,1481988639.462895,0.0001811981201171875],[[[2],[[\"_id\",\"UInt32\"],[\"_key\",\"ShortText\"],[\"body\",\"Text\"],[\"title\",\"ShortText\"],[\"updated_at\",\"Time\"]],[1,\"Post-2\",\"Railsで検索機能を追加する選択肢の一つに、ActiveGroongaで、ActiveRecordのように追加する方法がありますが、これはローカルのデータベースファイルにアクセスするため、スケーラビリティ等に不安がありました。groonga-client-railsなら、リモートのGroongaサーバーにHTTPやGQTPでアクセスできるので、スケーラビリティや保守性をDBやアプリケーションサーバーと別々に考えることができます。\",\"groonga-client-railsについて\",1481954320.0],[2,\"Post-3\",\"ActiveGroongaは「SQLite3でActiveRecordを使う」のに似ています。詳しくは過去のQiitaの記事などを見てください。\",\"ActiveGroongaについて\",1481955601.0]]]]"&gt;&gt;</span>
<span class="n">searcher</span><span class="p">.</span><span class="nf">search</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="s1">'Qiita'</span><span class="p">).</span><span class="nf">result_set</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Groonga::Client::Searcher::Select::ResultSet:0x007fd7c66d14b0 @response=#&lt;Groonga::Client::Response::Select:0x007fd7c66d1f00 @command=#&lt;Groonga::Command::Select:0x007fd7c40cb400 @command_name="select", @arguments={:table=&gt;"posts", :match_columns=&gt;"title, body", :query=&gt;"Qiita"}, @original_format=nil, @original_source=nil, @path_prefix="/d/", @slices={}, @drilldowns=[], @labeled_drilldowns={}&gt;, @header=[0, 1481988733.769218, 0.1913049221038818], @body=[[[1], [["_id", "UInt32"], ["_key", "ShortText"], ["body", "Text"], ["title", "ShortText"], ["updated_at", "Time"]], [2, "Post-3", "ActiveGroongaは「SQLite3でActiveRecordを使う」のに似ています。詳しくは過去のQiitaの記事などを見てください。", "ActiveGroongaについて", 1481955601.0]]], @n_hits=1, @records=[{"_id"=&gt;2, "_key"=&gt;"Post-3", "body"=&gt;"ActiveGroongaは「SQLite3でActiveRecordを使う」のに似ています。詳しくは過去のQiitaの記事などを見てください。", "title"=&gt;"ActiveGroongaについて", "updated_at"=&gt;2016-12-17 15:20:01 +0900}], @slices={}, @drilldowns=[], @raw="[[0,1481988733.769218,0.1913049221038818],[[[1],[[\"_id\",\"UInt32\"],[\"_key\",\"ShortText\"],[\"body\",\"Text\"],[\"title\",\"ShortText\"],[\"updated_at\",\"Time\"]],[2,\"Post-3\",\"ActiveGroongaは「SQLite3でActiveRecordを使う」のに似ています。詳しくは過去のQiitaの記事などを見てください。\",\"ActiveGroongaについて\",1481955601.0]]]]"&gt;&gt;</span>
</code></pre></div><p>後編ではこれを使って検索UIを組み立てます。</p><p>追記。</p><p>後編を書きました：<a href="21.html">Railsでの検索機能にgroonga-client-railsを使う（後編）</a></p><div class=footnotes><ol><li id="fn:1"><p>正確には二つ以上作れますが、あまり意味がないと思います。&nbsp;<a href="#fnref:1" class=reversefootnote>&#8617;</a></p></li></ol></div></paper-card></article><footer><ul><li class=next><a href="../../" rel=next><paper-button raised>前3日分</paper-button></a></li><li class=prev><a href="../3/" rel=prev><paper-button raised>次3日分</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></app-header-layout></main><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>