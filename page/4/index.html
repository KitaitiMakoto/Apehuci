<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta name=description content="北市真の日記"><meta content="width=device-width,initial-scale=1.0" name=viewport><title>アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:description content="北市真の日記"><meta name=og:title content="アペフチ"><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"><meta name=robots content="noindex,follow"></head><body class="page page_4 page_4_index"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed condenses effects=waterfall slot=header><app-toolbar></app-toolbar><app-toolbar sticky><h1 class=site-title><a href="../../">アペフチ</a></h1></app-toolbar></app-header><article><paper-card elevation=2><a href="../../2016/08/26.html"><h1>全文検索とスコアリングの仕組み</h1><time pubdate>2016-08-26</time></a><ul class=tags><li><a href="../../tags/.html" rel=tag>全文検索</a></li><li><a href="../../tags/groonga.html" rel=tag>Groonga</a></li></ul><p>久し振りに<a href="https://groonga.doorkeeper.jp/events/48368">Groongaで学ぶ全文検索 2016-08-26</a>@<a href="http://www.eli-sys.jp/">イーライセンスシステムズ</a>に参加してきた。</p><p>今日は、全文検索がどういう物かよく分かっていないという人が複数人いたことから、全文検索の仕組みと、スコアリングについて話をしてもらった。</p><h2 id=section>全文検索の仕組み</h2><p>ホテルデータベースを考える。ホテルのある場所、種類（ホテルか旅館か）、泊数や日付、説明があって、それぞれで絞り込みができる。このうち、説明が全文検索（テキスト検索）の対象になる。</p><p>ある言葉（「軽井沢」）で検索する時に、全ホテルを順番に見て、それぞれに検索語が含まれているかを調べる方法は、非常に時間が掛かる。耐えられる時間内に検索結果が返ってこない。そこで、検索結果を速く返すための準備をすることになる。この準備をしたデータのことをインデックスと呼ぶ。</p><p>インデックスというのは、日本語では索引で、考え方は本の末尾にある索引と同じ。本の方の索引は、専門用語などの「言葉」と、その言葉が出てくる「ページのリスト」を並べた物だ。全文検索エンジンのインデックスも同様で、キーワードと、そのキーワードを含んでいる文書（のIDなど）のペアを並べた物になっている。検索語がこのインデックスに載っていると、検索するのが速い。但し、インデックスに載っていない検索語は、検索できなくなる。そこで、インデックスのキーに載っている単語を増やすのがコツになる。</p><p>元々の説明文などからこのキーを作る方法は二種類ある。一つは、説明を日本語として解釈して分割し、分割結果をキーにする方法。形態素解析と呼ばれる。</p><p>もう一つは単純に決めた文字数で区切ること。「軽井沢に行こう」という説明文だったら、「軽井」「井沢」「沢に」「に行」「行こ」「う」と区切ることができる。この時、「軽井沢」で検索すると、どこにもこれと同じキーはないのでヒットしない。そこで、検索語の方も同じように区切って「軽井」「井沢」とする。それから「説明文に『軽井』を含んでいるホテル一覧」と「『井沢』を含んでいるホテル一覧」を取得し、その共通部分を取ると、「軽井沢」を含むホテル情報が手に入る。正確には、「『軽井沢』を含む<strong>可能性のある</strong>ホテル情報一覧」が手に入る。「井沢さんと軽井さんが経営しています」という文書もヒットするからだ。それを防ぐため、共通部分を取る時に、「キーワードの順番と離れ具合を見て、この順番で隣り合っているような説明文のホテル一覧」を取得するようにする。すると「説明文に『軽井沢』を含んでいるホテル一覧」になる。</p><h2 id=section-1>スコアリング</h2><p>なぜスコアをつけるのか、という話を最初にした。それは、検索結果一覧の中のそれぞれで、ユーザーの欲しそう度合いが違うから。欲しそうな度合いの大きい物を先に提示して、そうでない物を後に提示すると、ユーザーが本当に欲しかった物をよりうまく提供できるだろうという考え方による。この欲しそう度合いを決める際に、エリアなどの項目をどれくらい重視するかというのを数値にした物のことを「重み」と呼んで、重みを決めることを「重み付け」と言う。検索スコアをつける際、それぞれの重みを考慮したスコアをつけることになる。</p><p>スコアリングの際には、確実さと重要さの二つを考えて行う。</p><p>確実さというのは、「軽井沢」で検索した時に、説明文で「軽井沢にほど近い」となっているホテルよりも、エリアがズバリ「軽井沢」となっている方が重くなるようにスコアをつけること。</p><p>重要さというのは、仮に説明文にタイトルと本文があった時に、タイトルの方が大事だろうと考えて、タイトルにヒットした場合により高いスコアをつけること。</p></paper-card></article><article><paper-card elevation=2><a href="../../2016/07/17.html"><h1>Farewell to Firefox OS</h1><time pubdate>2016-07-17</time></a><ul class=tags><li><a href="../../tags/firefox-os.html" rel=tag>Firefox OS</a></li><li><a href="../../tags/android.html" rel=tag>Android</a></li></ul><p>携帯を買い換えた。</p><p>これまでFirefox OSの<a href="http://au-fx.kddi.com/">Fx0</a>を使っていたが、諸々の事情で、と言うかタブレットのNexus 7が充電できなくなってしまって、さすがに携帯端末がFirefox OSしかないのは不便が大きすぎるのでAndroid携帯に変えた。本当はNexusにしたかったけど、auにはFirefox OSを出してもらった義理を（一方的に）感じているので、一回はauを選びたかった。その中で有効な選択肢はGalaxy S7 edgeとHTC 10だったが何となくでGalaxyにした。</p><p>正直Galayx S7 edgeもHTP 10も大き過ぎるので、多少は小さいHTC 10にしようかなあとは思っていたのだが、店頭で見てみるとどちらも変わらないのでGalaxyにしたのだった。</p><p>それはそれとして、タブレットをどうしようかすごい迷ってて、Nexus 7は最高だったと思う。Nexus 9は大き過ぎる。iPad miniは有力候補だけどちょっとした不便を解消したいと思って簡単なアプリ作ってもストア申請めんどいなあ、だったらAndroidの方がまだ自由かなあとか、ASUSのAndroidタブレット大きさ的にはいいけど最新のOSに追従してほしいなあとか、なんかいい感じのところがない。一月くらいGalaxyとくらしてみて決めようと思う。早速BookLive!アプリでまんが読んでみたところやっぱちょっと画面小さいので、何かは買うと思うが。</p></paper-card></article><article><paper-card elevation=2><a href="../../2016/06/11.html"><h1>Fluentd設定ファイルのシンタックスハイライト</h1><time pubdate>2016-06-11</time></a><ul class=tags><li><a href="../../tags/ruby.html" rel=tag>Ruby</a></li><li><a href="../../tags/rouge.html" rel=tag>Rouge</a></li><li><a href="../../tags/fluentd.html" rel=tag>Fluentd</a></li></ul><p><a href="http://rouge.jneen.net/">Rouge</a>というRuby製のシンタックスハイライト用ライブラリーがあって、それのFluentd設定ファイル用の追加レクサー（トークナイザー）を作ってみた。</p><p><a href="https://github.com/KitaitiMakoto/rouge-lexers-fluentd">https://github.com/KitaitiMakoto/rouge-lexers-fluentd</a></p><p>始めはApache用のレクサーを使ってみたんだけどうまくいかなかった。<code class=highlighter-rouge>&lt;Directory&gt;</code>とかのキーワードがホワイトリスト形式だったり（これはサブクラス作ることで簡単に解決できたけど）、やっぱりFluentd独自の構文に対応したくなったりしてきたので、自分で書いたのだった。</p><p>使ってみると、こんな感じ。</p><div class="language-fluentd highlighter-rouge"><pre class=highlight><code><span class="c"># Receive events from 24224/tcp</span>
<span class="c"># This is used by log forwarding and the fluent-cat command</span>
<span class="p">&lt;</span><span class="nl">source</span><span class="p">&gt;
</span>  <span class="nb">@type</span> <span class="ss">forward</span>
  <span class="nc">port</span> <span class="ss">24224</span>
<span class="p">&lt;/</span><span class="nl">source</span><span class="p">&gt;
</span>
<span class="c"># http://this.host:9880/myapp.access?json={"event":"data"}</span>
<span class="p">&lt;</span><span class="nl">source</span><span class="p">&gt;
</span>  <span class="nb">@type</span> <span class="ss">http</span>
  <span class="nc">port</span> <span class="ss">9880</span>
<span class="p">&lt;/</span><span class="nl">source</span><span class="p">&gt;
</span>
<span class="c"># Match events tagged with "myapp.access" and</span>
<span class="c"># store them to /var/log/fluent/access.%Y-%m-%d</span>
<span class="c"># Of course, you can control how you partition your data</span>
<span class="c"># with the time_slice_format option.</span>
<span class="p">&lt;</span><span class="nl">match</span><span class="sr"> myapp.access</span><span class="p">&gt;
</span>  <span class="nb">@type</span> <span class="ss">file</span>
  <span class="nc">path</span> <span class="ss">/var/log/fluent/access</span>
<span class="p">&lt;/</span><span class="nl">match</span><span class="p">&gt;
</span></code></pre></div><p>Rougeはターミナル向けにもフォーマットできる。 <img src="https://gyazo.com/89808bd1f93c33658cc632253980677f.png" alt="シンタックスハイライトのターミナルアウトプット"/></p><p>READMEに書いた通りまだやることは残っているけど、取り敢えず最低限の用はなすと思う。具体的には、『<a href="https://gihyo.jp/dp/ebook/2014/978-4-7741-6698-8">サーバ／インフラエンジニア養成読本 ログ収集〜可視化編</a>』のシンタックスハイライトをできる程度には使える。</p><p><img src="https://gyazo.com/9db066f8005d35bba48e0196917bf1ec.png" alt="サーバ／インフラエンジニア養成読本 ログ収集〜可視化編でのシンタックスハイライト"/></p><div class=booklog_html><table><tr><td class=booklog_html_image><a href="http://www.amazon.co.jp/%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%8B%E3%82%A2%E9%A4%8A%E6%88%90%E8%AA%AD%E6%9C%AC-%E3%83%AD%E3%82%B0%E5%8F%8E%E9%9B%86%7E%E5%8F%AF%E8%A6%96%E5%8C%96%E7%B7%A8-%E7%8F%BE%E5%A0%B4%E4%B8%BB%E5%B0%8E%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E5%88%86%E6%9E%90%E7%92%B0%E5%A2%83%E3%82%92%E6%A7%8B%E7%AF%89-Software-Design/dp/4774169838%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4774169838" target=_blank><img src="http://ecx.images-amazon.com/images/I/51lSb2Ie7WL._SL160_.jpg" width=105 height=150 style="border:0;border-radius:0;"/></a></td><td class=booklog_html_info style="padding-left:20px;"><div class=booklog_html_title style="margin-bottom:10px;font-size:14px;font-weight:bold;"><a href="http://www.amazon.co.jp/%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%8B%E3%82%A2%E9%A4%8A%E6%88%90%E8%AA%AD%E6%9C%AC-%E3%83%AD%E3%82%B0%E5%8F%8E%E9%9B%86%7E%E5%8F%AF%E8%A6%96%E5%8C%96%E7%B7%A8-%E7%8F%BE%E5%A0%B4%E4%B8%BB%E5%B0%8E%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E5%88%86%E6%9E%90%E7%92%B0%E5%A2%83%E3%82%92%E6%A7%8B%E7%AF%89-Software-Design/dp/4774169838%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4774169838" target=_blank>サーバ/インフラエンジニア養成読本 ログ収集~可視化編 [現場主導のデータ分析環境を構築!] (Software Design plus)</a></div><div style="margin-bottom:10px;"><div class=booklog_html_author style="margin-bottom:15px;font-size:12px;;line-height:1.2em">著者 : <a href="http://booklog.jp/author/%E9%88%B4%E6%9C%A8%E5%81%A5%E5%A4%AA" target=_blank>鈴木健太</a></div><div class=booklog_html_manufacturer style="margin-bottom:5px;font-size:12px;;line-height:1.2em">技術評論社</div><div class=booklog_html_release style="font-size:12px;;line-height:1.2em">発売日 : 2014-08-08</div></div><div class=booklog_html_link_amazon><a href="http://booklog.jp/item/1/4774169838" style="font-size:12px;" target=_blank>ブクログでレビューを見る»</a></div></td></tr></table></div></paper-card></article><footer><ul><li class=next><a href="../3/" rel=next><paper-button raised>前3日分</paper-button></a></li><li class=prev><a href="../5/" rel=prev><paper-button raised>次3日分</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></app-header-layout></main><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>