<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta name=description content="北市真の日記"><meta content="width=device-width,initial-scale=1.0" name=viewport><title>アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:description content="北市真の日記"><meta name=og:title content="アペフチ"><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"><meta name=robots content="noindex,follow"></head><body class="page page_5 page_5_index"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed condenses effects=waterfall slot=header><app-toolbar></app-toolbar><app-toolbar sticky><h1 class=site-title><a href="../../">アペフチ</a></h1></app-toolbar></app-header><article><paper-card elevation=2><a href="../../2016/05/20.html"><h1>Groonga悩み相談「類似文書検索で検索結果が少ないからより多くヒットするようにパラメーター調整したい」</h1><time pubdate>2016-05-20</time></a><ul class=tags><li><a href="../../tags/groonga.html" rel=tag>Groonga</a></li><li><a href="../../tags/.html" rel=tag>類似文書検索</a></li></ul><p><a href="https://groonga.doorkeeper.jp/events/43780">Groongaで学ぶ全文検索 2016-05-20</a>に行って来た。</p><p>今日の話題は「類似文書検索」。</p><p>参加者の一人が、今作っているサービスでMroonga（Groongaの機能をMySQL経由で使うストレージエンジン）を使っていて、その類似文書検索のパラメーター調整の相談があるということで、類似文書検索が話題に選ばれた。</p><p>まだ世に出ていないサービスなので、以降はその物ではなくて僕が適当に変換した話を書く。</p><h2 id=section>サービス概要（フェイク）</h2><p>話をブログに例えると、はてなダイアリー（はてなブログではない）のような物。</p><p>まず、普通にブログ記事を書ける。</p><p>そして、（最近の人は知らないかも知れないけど）「おとなり日記」という機能があって、自分の記事と似ている記事一覧が、コメントの所に表示される（今はないかも？）。</p><p>勿論、はてなダイアリーには他にも色々な機能があるが、今日の話に必要なのはこの二つ。</p><h2 id=section-1>やりたいことと直面している課題</h2><p>やりたいのは、日記を書いた時に、おとなり日記のように、似た記事を探してきて、見せること。</p><p>そこの所を、Mroongaの類似文書検索の機能を使って実装したのだが、ヒットする類似文書が少なすぎるので、もっと増やしたい。そのために、今はMroongaが「似ているといえば似ているが、この特徴を似ていると言ってしまうと、およそ全ての日記がお互いに似ていることになってしまう、つまり何も言っていないに等しい」と判断して切り捨てている特徴を、復活させたい、そのためのパラメーターがあるのであれば知りたい、ということだった。もう少し具体的に言うと、ほぼ全日記に含まれるような言葉は、検索時に省かれているが、それを復活させたいということ。</p><p>なお、そうするとノイズが増えることは理解していて、ただ、全体の件数が少ない今のフェイズに限っては復活させたいということだった。増えてきたら、そういう「どの日記にも含まれているキーワード」は検索語に含まないように調整するとのこと。</p><h2 id=groonga>Groongaの類似文書検索</h2><p>類似文書検索を知らない参加者もいたので、まずはその説明から行われた。</p><p>いつものように入力と出力を考えると、入力は（今書いたばかりの）日記で、出力はその日記と似ている日記。こうした入出力を実現するためにシステムはこうなっているとよい。というか、Groongaの類似文書検索はこうなっている。</p><h3 id=section-2>1. 入力の文書から特徴となる語（＝特徴語）を抜き出す</h3><p>例えば「私はRubyができます。」という日記を書いたとする。この時、「は」とか「私」とかは、非常に多くの日記にも含まれる。「ぼくはPythonができます。」という日記を誰かが書いていたとしたら、そこにも「は」が含まれる。</p><p>一方で「Ruby」は（Rubyistのための開発日誌サービスでもない限り）あまり出てこない。同様に、別の人の日記の「Python」もあまりなさそう。こうした「他の文書には入っていないけど、この文書（を含む小数の文書）には入っている」という語が、この文書の特徴語になる。</p><h3 id=or>2. 特徴語でOR検索する</h3><p>さっきは違うと書いたけど、仮に、「私」と「Ruby」が、先の日記の特徴語だとしよう。似た日記を探す際には、まずその二つの語でOR検索する。すると、今日の日記の特徴語が含まれる記事がヒットする。これは、「特徴」が同じなので、似ていると言えるだろう。</p><p>これで類似文書が選べたことになる。</p><p>但し、特徴語が上手に選ばれていれば、だ。</p><h2 id=section-3>特徴語の妥当な抽出方法</h2><p>日記から特徴語を抜き出す時は、日本語として自然な単語やそれに類する物（≒形態素）を抜き出すのがよい。</p><p>何らかの語を抜き出す方法として、文字数を決めて、その文字数単位で切り出すことも出来る。例えば二文字と決めると、「ぼく」「くは」「はP」「Py」「yt」「th」「ho」「on」「nが」「がで」「でき」「きま」「ます」「す。」と14の語（？）を抽出できる。しかし、さっき言ったようにOR検索した時、「『がで』という文字列が含まれている日記はにている」という判断をされても、困ってしまう。</p><p>全文検索ではこうした区切り方（n-gram）もありなのだが、類似文書検索の場合は、形態素による分割一択になる。</p><h2 id=section-4>課題の見直し</h2><p>さて、ここで課題に戻ろう。</p><ol><li>おとなり日記の数が少なすぎる（のでサービス内回遊ができない）。</li><li>それは、特徴語を選ぶ時の基準が厳しくて、検索に使われる特徴語が少ないからのように思われる</li><li>なので、「私」や「は」といった通常使わないような語も特徴語として類似文書検索に使うようなパラメーター（など何らかの方法）を知りたい</li></ol><p>ということだった。結論は「そのようなパラメーターはない」だった（Mroongaには。Groongaにはある）。</p><p>だが、そもそも、課題は、そういうことではないのでは？　という疑問が呈される。以下「再現率」と「適合率」という言葉を使う。勉強会ではこれらの言葉も説明もあったのだが、実はこの勉強会の2015年11月6日の回でそのことをやっていたので、ここでは端折る。以下の勉強会ページの下に過去の勉強会レポートがまとまっているので、該当日の所を探して読まれたい。</p><p><a href="https://groonga.doorkeeper.jp/events/43780">https://groonga.doorkeeper.jp/events/43780</a></p><p>課題を言い換えると「再現率を増やしたい」ということになる。しかし再現率と適合率はトレードオフの関係にあるので、再現率を増やすと適合率が下がる、つまりノイズが増えて、ユーザーが使わなくなりそうである。</p><p>ただ、そもそも、たくさんヒットした時に、全部見る人はいない（ような文脈が多い）。大体、最初の数件しか見ないので、ヒットする件数が多いか少ないかというよりも、どの日記が上に来ているのか、という方が重要になる。つまり、検索結果のスコアリングが大事だということだ。スコアリングはMroongaで色々と調整できるので、そこで頑張るのがよいということになる。</p><p>また、検索結果の中にユーザーが望む物がなかった時のフォローを入れておくというのも最近よくやられている（らしい）。例えば、今Googleで「ズートピア」を検索すると、ページ下部で次のように関連キーワードが案内される。 <img src="https://gyazo.com/0fd02873157e651e6fe240e7aad68bf3.png" alt="「ズートピア」検索結果画面の下部にある関連キーワード"/><br/> ページ下部まで見たということは望みの検索結果が得られなかったと判断して、「もしかしてこういう検索をしたかったのでは？」と提案しているわけだ。</p><p>ウェブページの全文検索ではなく、ツイートやチャットだと、新しい方が探したいことが多いだろうから、投稿日時を使ってスコアリングするというのもある。日記にお気に入り機能があれば、お気に入りが多い物のスコアを上げてもいい。</p><p>このように、文書その物以外のメタデータを使って、よりユーザーの望みそうな物に高い検索スコアを与え、上位に表示させるというのが最近のはやりらしい。</p></paper-card></article><article><paper-card elevation=2><a href="../../2016/05/17.html"><h1>パンチの空いた本</h1><time pubdate>2016-05-17</time></a><ul class=tags><li><a href="../../tags/.html" rel=tag>本</a></li></ul><p>本なんて、パンチ穴を開けた紙の束で売ればいいのではないだろうか。</p><p>みんな「マイバインダー」を持って、そこに本を挟むようにすれば、一冊という単位に縛られず、バインダーの厚さが許す限りは、何冊持ち歩いてもよい。仕切りのカードを挟んで、そこから後ろに、お気に入りの本のお気に入りのページを集めた物を常設しておいてもよい。小説のお気に入りの場面、まんがのコマ、詩、ビジネス格言集、参考書のテスト範囲……。</p><p>本屋では、本ごとの専用のバインダーを置いてそこで売る。買う時はレジに運んで、店員が中から紙の束だけ外し、客に渡す。当然、ファンは、タイトルや表紙絵、写真が入ったそのバインダーを欲しがるだろうから、マーチャンダイズとして売ればいい。まんがの原画やアニメのセル画のように、プレミアを付けて、プレゼントにしてもよい（そして転売される）。</p><p>バインダーの方も、専用デザイナーが生まれて気に入った物を買うようになったり、好きな写真家の写真入りにしたり、イラストレーターの一点物を大事にしていたり、iPhoneケースのように方々で作って売られるようになるだろう。</p><p>どうして、こういう形の売り方がされてこなかったのだろうか。</p></paper-card></article><article><paper-card elevation=2><a href="../../2016/05/11.html"><h1>Robust Annotation（安定したアノテーション）</h1><time pubdate>2016-05-11</time></a><ul class=tags><li><a href="../../tags/web-annotation.html" rel=tag>Web Annotation</a></li><li><a href="../../tags/robust-links.html" rel=tag>Robust Links</a></li></ul><p>ウェブページにアノテーションを付ける時、ページの更新に対してアノテーションの指し示す場所はどうしたらいいのだろうという悩みがある。Robust Linksのやり方と同じにアノテーション作成日時を記録し、その時点でのウェブページをInternet Archive上のページなどとして参照しておけばいいのだと思い至った。そこから、欠けたピースはやはり「DOMの差分計算」になりそうだとも思った。</p><h2 id=section>アノテーション</h2><p>ウェブページのある部分を大事だと思ってハイライトしたり、そこに自分の疑問点や思い付きを書き込んでおきたいことがある。前者は栞として後で参照するのに使ったり、はてなスターのように（はてなスターを使ったことがないので推測だ）「いいことを書いてあると思う」ということを書いた人、そのページを読む人に伝えるために使ったりする。後者はあまり見ないかも知れないが、例えばはてなブックマークはページ全体に対するコメントと見做せるだろう。「<a href="../04/10.html">日記のコメント用にHypothes.isを埋め込んでみた</a>」に書いたようなまさにそのためのツールもあるにはある。ウェブページを離れれば、Kindleで日々やっていることとして想像しやすい人も多いと思う。</p><p>この二つを「アノテーション（注釈）」と定義して、その（プログラムで扱うための）表現方法ややり取りのためのプロトコルを、W3Cがワーキンググループを立ち上げて策定している（<a href="https://www.w3.org/annotation/">W3C Web Annotation Working Group</a>。<a href="https://twitter.com/kzakza">kzakza</a>さんの<a href="http://code.kzakza.com/2014/08/w3c-web-annotation-working-group/">W3C Web Annotation Working Group 紹介</a>も読まれたい）。これをWeb Annotationと呼ぶ（これ、とか言ったが、どこのことを呼ぶんだかはっきりとは考えていない）。策定中でまだ変わるだろうし、本題でもないので詳細は気にしないでいいのだが、JSON（JSON-LD）でこのように書く（フォーマットを定めた<a href="https://www.w3.org/TR/annotation-model/">Web Annotation Data Model</a>仕様の<a href="https://www.w3.org/TR/annotation-model/#complete-example">Complete Example</a>から抜粋）。</p><div class="language-json highlighter-rouge"><pre class=highlight><code><span class="p">{</span><span class="w">
  </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
  </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Annotation"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"motivation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"commenting"</span><span class="p">,</span><span class="w">
  </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
  </span><span class="nt">"created"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-10-13T13:00:00Z"</span><span class="p">,</span><span class="w">
  </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
  </span><span class="nt">"generated"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-10-14T15:13:28Z"</span><span class="p">,</span><span class="w">
  </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
  </span><span class="nt">"body"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TextualBody"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tagging"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"love"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Choice"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"members"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TextualBody"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"describing"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"I really love this particular bit of text in this XML. No really."</span><span class="p">,</span><span class="w">
          </span><span class="nt">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text/plain"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"language"</span><span class="p">:</span><span class="w"> </span><span class="s2">"en"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"creator"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://example.org/user1"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nt">"target"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SpecificResource"</span><span class="p">,</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
    </span><span class="nt">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://example.com/document1"</span><span class="p">,</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
    </span><span class="nt">"selector"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"List"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"members"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FragmentSelector"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"xpointer(/doc/body/section[2]/para[1])"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div><p>何となく分かると思う。「http://example.com/document1のページの<code class=highlighter-rouge>/doc/body/section[2]/para[1]</code>というXPointerで表現されるパラグラフ（サンプルがHTMLだったらもっと都合がよかった……。その場合はCSSセレクターを使うことになるだろう）に対して、『I really love this particular bit of text in this XML. No really.』というコメントを付けている」ことになる。</p><p>さて、当然の悩みとして、「http://example.com/document1が更新されて、コメントの対象が無くなってしまったら、または内容が変わってしまったらどうなるのだろう」というのが生まれる（Kindleはどうなるんだっけ？　全部消える？）。</p><p>解決として、Robust Linksと同じ方法を取るのはどうか、と思い至った。</p><h2 id=robust-links>Robust Links</h2><p>ウェブページはどれも、内容が変わり得るし、無くなってしまうことだってある。こういう性質を持つ、もっと言うとより「強く」持つ物を、僕等はよく知っている。コードだ。日記でソースコードリーディングや実装解説をしていてGitHub上のソースコードの特定の行へのリンクを張る時、<code class=highlighter-rouge>master</code>ブランチのURLを使ったりはしない。「その時点でのコミット」を指す、ハッシュダイジェスト入りのURLを使う。</p><p>Robust Link（安定したリンク）はこのアイディアをどのページヘのリンクにも適用したようなものだ。普段使う<code class=highlighter-rouge>&lt;a&gt;</code>要素を強化して、リンク切れに強くする。そのアイディアはおおよそ次の通り。</p><ol><li>普通の方法で<code class=highlighter-rouge>&lt;a&gt;</code>要素を使ってリンクを作る（<code class=highlighter-rouge>&lt;a href="https://github.com/mementoweb/robustlinks"&gt;mementoweb/robustlinks&lt;/a&gt;</code>）</li><li>その時点でのスナップショットへのURLを、<code class=highlighter-rouge>data-versionurl</code>属性として付加する（<code class=highlighter-rouge>data-versionurl="https://github.com/mementoweb/robustlinks/commit/314640710584fcf91b0af64112714edd9ca4cb32"</code>）</li><li>リンクを作成した日を、<code class=highlighter-rouge>data-versiondate</code>属性として付加する（<code class=highlighter-rouge>data-versiondate="2016-05-11"</code>）</li></ol><p>結果こうなる：</p><div class="language-html highlighter-rouge"><pre class=highlight><code><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://github.com/mementoweb/robustlinks"</span>
   <span class="na">data-versionurl=</span><span class="s">"https://github.com/mementoweb/robustlinks/commit/314640710584fcf91b0af64112714edd9ca4cb32"</span>
   <span class="na">data-versiondate=</span><span class="s">"2016-05-11"</span><span class="nt">&gt;</span>mementoweb/robustlinks<span class="nt">&lt;/a&gt;</span>
</code></pre></div><p>これによって「このリンクは2016年5月11日に作られたmemento/robustlinksへのリンクで、その時点でのこのページ（リポジトリー）は<code class=highlighter-rouge>https://github.com/mementoweb/robustlinks/commit/314640710584fcf91b0af64112714edd9ca4cb32</code>を見れば再現できる」と見做すのだ。（細かくは色々あるので、プロジェクトのサイトを参照されたい、特に「こんな面倒なマークアップをしないといけないなんて、正気か？」と感じた人：<a href="http://robustlinks.mementoweb.org/">Robust Links</a>）。実際これで問題はなくて、この例のようにGitHubであれば僕達には馴染み深いし、そうでなくても<a href="https://archive.org/index.php">Internet Archve</a>のようなアーカイブサイト（魚拓サイト？）をポイントしておけば、（理想的には）リンク時点の物を再現できる。記事内に作ったリンクがある時切れてしまっても、これによって記事執筆時点でのリンク先を見て、記事内容を理解することができるわけだ（そして、そういうリンクを追加するJavaScriptライブラリーをRobust Linksプロジェクトは提供している）。</p><h2 id=robust-annotation>Robust Annotation</h2><p>この方法、アノテーションにも応用できることは、ここまで読めば、すぐに分かるだろう。「アノテーションの対象を示す物」はリンクに他ならない。さっきのWeb Annotationのサンプルの<code class=highlighter-rouge>target</code>オブジェクトに注目し、例えば次のように<code class=highlighter-rouge>versionurl</code>プロパティを足してやればよい。</p><div class="language-json highlighter-rouge"><pre class=highlight><code><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
  </span><span class="s2">"created"</span><span class="err">:</span><span class="w"> </span><span class="s2">"2015-10-13T13:00:00Z"</span><span class="err">,</span><span class="w">
  </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
  </span><span class="s2">"generated"</span><span class="err">:</span><span class="w"> </span><span class="s2">"2015-10-14T15:13:28Z"</span><span class="err">,</span><span class="w">
  </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
  </span><span class="s2">"target"</span><span class="err">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SpecificResource"</span><span class="p">,</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
    </span><span class="nt">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://example.com/document1"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"versionurl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://web.archive.org/web/20151001135202/http://example.com/document1"</span><span class="p">,</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
    </span><span class="nt">"selector"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"List"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"members"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FragmentSelector"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"xpointer(/doc/body/section[2]/para[1])"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
</span></code></pre></div><p>これで、「たとえ対象ページが大きく変更されていても、少なくとも2015年10月13日時点でのhttp://example.com/document1に対するコメントとしては意味を理解できる」ということになる。元々Web Annotation Data Modelで<code class=highlighter-rouge>created</code>や<code class=highlighter-rouge>generated</code>、サンプルにはないが<code class=highlighter-rouge>modified</code>が定義されているので、Robust Linksの<code class=highlighter-rouge>data-versiondate</code>に相当する物は追加しなくてもよい。</p><h2 id=section-1>アノテーションの更新</h2><p>なるほど「古い」アノテーションを、コンテクスト込みで理解できるようになった。だがこれが嬉しいのは、そのページのコンテンツに深い興味を持っている人と、そのページを取り巻く環境に興味を持っている人くらいなのではないかと思う。言い方を変えると、大多数のライトな読者は、そんな「ちょっとした違い」でしかないところまで探求しないだろうと思う。それより、最新のページを見ている時に、古いバージョンへのアノテーションも含めた色々なアノテーションが見られたほうが楽しくはないだろうか。それを実現するにはどうしたらいいだろうか。</p><p>まず、最新のページに、全てのアノテーションを表示すること。これは、当然ながら、記事の一部が削除されたり、追加されてアノテーションしていた部分の位置が変わった時に対応できない。</p><p>全てのアノテーションについて、それが指し示している「バージョン」を調べ、各バージョンのウェブページを集める。それぞれについて、最新のページとの差分を求める。その差分によって、アノテーションの対象が消えているか、場所が移動しているか、内容が変更されているかを判断できれば、いいはずだ。変更については意味の理解も必要だから簡単にはいかないが、削除と位置変更くらいなら簡単なはずだ（もちろん、前後の文脈を視野に入れたアノテーションであれば、離れたパラグラフの削除などのせいで意味を持たなくなることはあるが）。</p><p>例を出そう。こんなHTML断片があったとする。バージョン1と呼ぼう。</p><div class="language-html highlighter-rouge"><pre class=highlight><code><span class="nt">&lt;p&gt;&lt;span&gt;</span>こんにちは。<span class="nt">&lt;/span&gt;&lt;span&gt;</span>お元気ですか。<span class="nt">&lt;/span&gt;&lt;span&gt;</span>わたしは元気です。<span class="nt">&lt;/span&gt;&lt;/p&gt;</span>
</code></pre></div><p>これに対して、こんな三つのアノテーションがあったとする（Web Annotation Data Modelの記法ではなく、CSSセレクターと日本語のかぎかっこを使う）。</p><dl><dt>アノテーション1</dt><dd>バージョン1の<code class=highlighter-rouge>*:nth-child(n) &gt; *:nth-child(1)</code>（<code class=highlighter-rouge>&lt;span&gt;こんにちは。&lt;/span&gt;</code>）に対して「普通の挨拶」というコメント</dd><dt>アノテーション2</dt><dd>バージョン1の<code class=highlighter-rouge>*:nth-child(n) &gt; *:nth-child(2)</code>（<code class=highlighter-rouge>&lt;span&gt;お元気ですか。&lt;/span&gt;</code>）に対して「珍しい挨拶」というコメント</dd><dt>アノテーション3</dt><dd>バージョン1の<code class=highlighter-rouge>*:nth-child(n) &gt; *:nth-child(3)</code>（<code class=highlighter-rouge>&lt;span&gt;わたしは元気です。&lt;/span&gt;</code>）に対して「つまらない挨拶」というコメント</dd></dl><p>このページは何か理由があって編集され、こんなバージョン2になったとする。</p><div class="language-html highlighter-rouge"><pre class=highlight><code><span class="nt">&lt;p&gt;&lt;span&gt;</span>お元気ですか。<span class="nt">&lt;/span&gt;&lt;span&gt;</span>わたしは元気です。<span class="nt">&lt;/span&gt;&lt;/p&gt;</span>
</code></pre></div><p>「こんにちは。」は平凡すぎて恥ずかしくなったのかも知れない。それはさておき、先の二つのアノテーションは <strong>バージョン1に対する物</strong> なので、最新であるバージョン2のどこに対してコメントしているかは自明ではない。もし何も処理をせず、そのままバージョン2に対する物として適用してしまうと、<code class=highlighter-rouge>&lt;span&gt;お元気ですか。&lt;/span&gt;</code>に対して、「普通の挨拶」というコメントが表示されてしまう。「珍しい挨拶」としてコメントしたはずなのに。明らかに、アノテーション作成者の意図を捻じ曲げてしまっている。</p><p>これを是正するためには、何らかの処理を施して次のようになってほしい（名前にプライム記号「′」を付けた）。</p><dl><dt>アノテーション1′</dt><dd>（なし）</dd><dt>アノテーション2′</dt><dd>バージョン2の<code class=highlighter-rouge>*:nth-child(n) &gt; *:nth-child(1)</code>に対して「珍しい挨拶」というコメント</dd><dt>アノテーション3′</dt><dd>バージョン2の<code class=highlighter-rouge>*:nth-child(n) &gt; *:nth-child(2)</code>に対して「つまらない挨拶」というコメント</dd></dl><p><code class=highlighter-rouge>nth-child(2)</code>だった所が<code class=highlighter-rouge>nth-child(1)</code>に、<code class=highlighter-rouge>nth-child(3)</code>だった所が<code class=highlighter-rouge>nth-child(2)</code>に変わっている。</p><p>これを実現するためには何が分かるといいだろうか。「<code class=highlighter-rouge>*:nth-child(n)</code>（<code class=highlighter-rouge>&lt;p&gt;</code>要素）の<code class=highlighter-rouge>1</code>番目の子要素が無くなった」ということが分かればいいはずだ。すると、<code class=highlighter-rouge>1</code>番目より後だった要素の<code class=highlighter-rouge>nth-child()</code>の中を一つ減らせばいいということが分かる。単純な引き算だ。</p><p>ではそうしたHTMLの変更をどうやって知ればいいだろうか。二つあると思う。</p><p>一つは、HTMLを編集する時に、同時にこうした「どのような操作か」という情報も作り出すこと。テキストエディターのようにユーザーが直接（？）テキストを編集してしまうタイプのアプリケーションでは無理そうだが、ユーザーの操作と結果の生成の間にギャップが大きくて、何らかのフックを掛けやすそうなWYSIWYGエディターではそれが可能かも知れない。</p><p>もう一つは、二つのHTMLを比べて「差分」を抽出すること。テキストファイルに対する<code class=highlighter-rouge>diff</code>コマンドのような物だ。ここではHTMLなので、DOMツリーの差分ということになる。僕はこちらに期待している。</p><p>というわけで、「バージョン」間のDOMツリーの差分を計算することができれば、古めのアノテーションのうち、最新版でも有効なものを（ある程度）抽出して適用させることができる、つまり対象ページの履歴を見るだけで「アノテーションの更新」を実現できるのではないか、と思っているわけだ。</p><p>実はこの話は前にもしたことがあって、「<a href="../01/02.html">EPUB書籍に正誤表を反映する（Rubyスクリプトで）、またはEPUBのパッチプログラムの試み</a>」の「追記」に言及がある。また、こうした関心とは無関係に、フロントエンドエンジニアの<a href="https://twitter.com/kitak">@kitak</a>さんから「アプリケーション開発やデバッグの簡単のためにDOMツリーの差分を表示するツールが欲しい」という声を聞いたこともあって、今、DOMツリーの差分計算は、結構、ニーズがあるのではないかと思っている。</p><p>なお、補足だが、アノテーションを必ずCSSセレクターなどのDOM構造を前提とした方法で行わなければいけないわけではない。Web Annotation Data Modelでも、「先頭から何文字目か」でアノテーションを付ける方法も提供している。しかし、そうした「位置情報」を使っている時に、場所の移動を計算するのは、HTMLの場合はだいぶ大変だと思う。</p></paper-card></article><footer><ul><li class=next><a href="../4/" rel=next><paper-button raised>前3日分</paper-button></a></li><li class=prev><a href="../6/" rel=prev><paper-button raised>次3日分</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></app-header-layout></main><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>