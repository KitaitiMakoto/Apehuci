<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta name=description content="北市真の日記"><meta content="width=device-width,initial-scale=1.0" name=viewport><title>アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:description content="北市真の日記"><meta name=og:title content="アペフチ"><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"><meta name=robots content="noindex,follow"></head><body class="page page_8 page_8_index"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed condenses effects=waterfall slot=header><app-toolbar></app-toolbar><app-toolbar sticky><h1 class=site-title><a href="../../">アペフチ</a></h1></app-toolbar></app-header><article><paper-card elevation=2><a href="../../2016/03/14.html"><h1>SQLアンチパターン@Sendagaya.rb #141</h1><time pubdate>2016-03-14</time></a><ul class=tags><li><a href="../../tags/sql.html" rel=tag>SQL</a></li><li><a href="../../tags/ruby.html" rel=tag>Ruby</a></li></ul><p><a href="https://sendagayarb.doorkeeper.jp/events/40813">Sendagaya.rb #141</a>で<a href="http://www.lanches.co.jp/">株式会社ランチェスター</a>に行って来た。今回は『<a href="https://www.oreilly.co.jp/books/9784873115894/">SQLアンチパターン</a>』に関連して相談したいことがあるという参加者がいたので、その話を前半（というか殆ど）やって、後半は『<a href="https://www.oreilly.co.jp/books/9784873117430/">メタプログラミングRuby</a>』を読んだ。</p><h2 id=sql>SQLアンチパターン</h2><div class=booklog_html><table><tr><td class=booklog_html_image><a href="http://www.amazon.co.jp/SQL%E3%82%A2%E3%83%B3%E3%83%81%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3-Bill-Karwin/dp/4873115892%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4873115892" target=_blank><img src="http://ecx.images-amazon.com/images/I/41qHKrFZi0L._SL160_.jpg" width=117 height=150 style="border:0;border-radius:0;"/></a></td><td class=booklog_html_info style="padding-left:20px;"><div class=booklog_html_title style="margin-bottom:10px;font-size:14px;font-weight:bold;"><a href="http://www.amazon.co.jp/SQL%E3%82%A2%E3%83%B3%E3%83%81%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3-Bill-Karwin/dp/4873115892%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4873115892" target=_blank>SQLアンチパターン</a></div><div style="margin-bottom:10px;"><div class=booklog_html_author style="margin-bottom:15px;font-size:12px;;line-height:1.2em">著者 : <a href="http://booklog.jp/author/Bill+Karwin" target=_blank>Bill Karwin</a></div><div class=booklog_html_manufacturer style="margin-bottom:5px;font-size:12px;;line-height:1.2em">オライリージャパン</div><div class=booklog_html_release style="font-size:12px;;line-height:1.2em">発売日 : 2013-01-26</div></div><div class=booklog_html_link_amazon><a href="http://booklog.jp/item/1/4873115892" style="font-size:12px;" target=_blank>ブクログでレビューを見る»</a></div></td></tr></table></div><p>僕はこの本を持っていないから具体的なことはあまり分からないけれど、「ポリモーフィック関連はよくない」と言っている箇所があって、ちょうど自分で作っている物でもポリモーフィック関連を使っている所があって、それで相談に来たということらしかった。本の該当箇所を説明してもらったり、<a href="https://twitter.com/tkawa">@tkawa</a>さんが電子版を持っていたのでプロジェクターで映して見せてもらったりしながら話を聞いていると、基本的には外部キー制約が使えなくなることが問題のようで、これの解決方法として交差テーブル（だっけ？）という考え方と単一テーブル継承という考え方を紹介していた。</p><p>ポリモーフィック関連はよくない、しかしではどうしたらいいだろうか、この本で提示されている解決策もあまりいいようには思われない、ということで、その人の扱っている具体的なテーブル構造なんかを教えてもらいながらみんなでああだこうだと言っていた。一般的な正解がないタイプの問題だし、ウェブのサービスだと将来要件が変わることは容易に想像できる、それも今の段階ではどう変わるか想像できないタイプの変わり方をするものだから、正解を探すのはますます難しい。<a href="https://twitter.com/iR3">@iR3</a>さんが、長年の経験からためになるアドバイスをするなどしていた。<a href="http://fukajun.org/">fukajun</a>さんもいいこと言ったり、もっと言いたいことありそうだった（前にもテーブル設計の時に言いたいこと残してそうだったのを思い出すに、RDBMS得意そう）のだけど、残念ながら体調不良でidobataによるテキストチャットでの参加だったものだから、勿体無い感じなってしまった。勿体無い。</p><p>こういうのって、誰かに相談できる、話し相手がいることその物が価値だったりするものだなあという感覚を思い出した。</p><h2 id=ruby>メタプログラミングRuby</h2><p>最後三十分くらいで『メタプログラミングRuby 第2版』を読んだ。今回は主に<code class=highlighter-rouge>method_missing</code>の所だ。「<code class=highlighter-rouge>method_missing</code>を定義する時は一緒に<code class=highlighter-rouge>respond_to_missing?</code>も定義しましょう」というのがポイント。</p><p>あと、ついエイリアスメソッドチェインという言葉を使ってしまって「それ何？」って聞かれたのだけど、2016年なんだし、ほぼ説明を要するような言葉は封印していくべきだと感じた。</p><p>次回は<a href="http://rubyonrails.org/doctrine/">The Rails Doctrine</a>（多分、<a href="http://postd.cc/rails-doctrine/">日本語訳</a>のほう）を読みながらおしゃべりする予定：<br/><a href="https://sendagayarb.doorkeeper.jp/events/41208">https://sendagayarb.doorkeeper.jp/events/41208</a></p></paper-card></article><article><paper-card elevation=2><a href="../../2016/03/11.html"><h1>Groongaの類似文書検索</h1><time pubdate>2016-03-11</time></a><ul class=tags><li><a href="../../tags/groonga.html" rel=tag>Groonga</a></li><li><a href="../../tags/mroonga.html" rel=tag>Mroonga</a></li><li><a href="../../tags/.html" rel=tag>全文検索</a></li><li><a href="../../tags/.html" rel=tag>類似文書検索</a></li></ul><p><a href="https://groonga.doorkeeper.jp/events/40088">Groongaで学ぶ全文検索 2016-03-11</a>に行って来た。</p><p>今日は、実際のユースケースに沿った話をしようということで、参加者のすごい具体的な業務の話をして、それにGroongaを入れる時にどういうふうにすればいいか、どこに注意すればいいかといった話をした。書けなさすぎるので、Mroongaを使ってウェブ日記に類似記事機能を入れるという喩え話にして書く。</p><p>この日記は、実際には静的HTMLをGitHub Pagesでホストしているが、仮に、MySQLに記事データを入れてそこからデータを引っ張って表示しているとしよう。その記事テーブルにはこんなカラムがあるだろう。</p><ul><li>URL（パス）</li><li>タイトル</li><li>タグ</li><li>本文</li></ul><p>各記事の末尾に、その記事に関連する記事一覧を出したいとする。</p><h2 id=section>関連記事の分類</h2><p>読者に読むべき記事を提示する際、状況を二つに分けられる。</p><ul><li>読者が、自分が読みたい物を自覚している（「Groongaの記事を読みたい」）</li><li>読者は自分が読みたいタイプの記事を自覚していない（「この人の文体は気持ちがいい。次に何を読もう」</li></ul><p>前者の読者に対しては、テキストフィールドを使ったいわゆる検索機能を提供すればよい。</p><p>後者の読者には、記事の提供側（個人日記なので、僕のことだ）が何らかの基準で読むといいだろう記事を提示する。提示のアプローチは更にこう分類できる。</p><ul><li>全ユーザーに共通の記事を提示する <ul><li>僕がおすすめしたい記事一覧を出す</li><li>日記の全記事中、人気のある記事一覧を出す（例えばPVを使って）</li><li>今読んでいる記事に似た記事一覧を出す</li></ul></li><li>読者ごとにパーソナライズしたおすすめなどを提示する（例えばクッキーを使って。今日はこの話はしない）</li></ul><h2 id=section-1>類似文書検索を行う方法</h2><p>このうち「今読んでいる記事に似た記事一覧を出す」というのは類似文書検索と呼ばれる一般的な検索方法を使うと可能で、Groonga（Mroonga）にはその機能が備わっているので、ここではそれを使う時の方法と注意点を述べる。</p><p>まず、検索エンジンの用意だが、Mroongaを使えば簡単だ。MroongaはMySQLに組み込んで使えるストレージエンジンで、Groongaを使った検索機能などを提供する。Mroongaで日記テーブルを作って記事の表示や検索をさせることができるが、記事追加といったデータを扱うマスターデータベースはInnoDBにし、MySQLのレプリケーション機能を使って作るレプリカをMroongaにする、ということができる。するとInnoDBの堅牢さやトランザクション機能にあやかりながらGroongaの高速検索機能を使える。データはレプリケーション機能を使って勝手に入ってくるので、自分で同期の仕組みを作る必要もない。</p><p>こうしておくと、記事を表示する時にレプリカであるMroongaから類似文書検索機能を使って似た記事一覧を出すことができる。Mroongaで類似文書検索をするには、SQLで</p><div class="language-sql highlighter-rouge"><pre class=highlight><code><span class="p">...</span> <span class="k">MATCH</span><span class="p">(</span><span class="err">本文</span><span class="p">)</span> <span class="n">AGAINST</span><span class="p">(</span><span class="err">今見ている記事の本文</span> <span class="k">IN</span> <span class="k">NATURAL</span> <span class="k">LANGUAGE</span> <span class="k">MODE</span><span class="p">)</span> <span class="p">...</span>
</code></pre></div><p>と書く。<code class=highlighter-rouge>AGAINST</code>に記事の本文を与えることと、モードを<code class=highlighter-rouge>NATURAL LANGUAGE MODE</code>にすることがポイントだ（ここで「<code class=highlighter-rouge>NATURAL LANGUAGE MODE</code>にすると類似文書検索になる」というのはMroongaがそうしてあるということで、MySQL一般のことではない）。</p><p>それから、トークナイザーに、MeCabを使うことも重要だ。N-gramだと精度の著しく低い結果になってしまう。どうしてか。それを説明するには類似文書検索の概要を説明する必要がある。（時間があったら書く -&gt; なかった）</p><h2 id=mroonga>Mroongaでの類似文書検索の注意点</h2><p>今見ている記事の本文を使って類似文書検索をし、似ている記事の上位n件を表示すると、そこに今見ている記事その物が入ることが非常に多い（当たり前だ）。なので、条件句でそれを除くようにしておく。</p><p>「似ている」ということの精度を高めるために、本文以外の情報を使うとよい。例えば、タグが共通している記事<del>はスコアを上げる</del><ins>のみを提示する</ins>など（Groongaではできるのだが、Mroongaではスコアをどうこうというのはできないらしい）。</p><h2 id=section-2>その他の記事提示方法</h2><p>始めの分類の「読者が、自分が読みたい物を自覚している」という状況のため、検索エリアを設けたとする。検索語を入れている<strong>途中で</strong>、この日記の中で見つかりそうな単語を補完して提示すると、<strong>見栄えがいい</strong>し、検索しても無駄そうなキーワードも早めに分かってよい。</p><p>Mroongaの最新リリースで、これ（<del>サジェスト</del><ins>補完</ins>機能）を実現する機能が入った。ただ、MroongaはなるべくMySQLのユーザーが自然に使えることを重視している（上の<code class=highlighter-rouge>NATRUAL LANGUAGE MODE</code>など、既存のMySQLの物をうまくGroongaに当てはめて使っている）が、この機能はそうはいかないので、強引にGroongaのフル機能を使えるようにする。Groongaの機能を自由に使うには</p><div class="language-sql highlighter-rouge"><pre class=highlight><code><span class="p">...</span> <span class="k">MATCH</span><span class="p">(...)</span> <span class="n">AGAINST</span><span class="p">(</span><span class="s1">'*SS title:@"..." &amp;&amp; point &gt;= 100'</span> <span class="k">IN</span> <span class="n">BOOLEAN</span> <span class="k">MODE</span><span class="p">)</span> <span class="p">...</span>
</code></pre></div><p>と、<code class=highlighter-rouge>AGAINST</code>の中を<code class=highlighter-rouge>*SS</code>で始める。これを使ってGroongaのprefix_rk_search(prefix romaji kana search)関数を使うと、上の<del>サジェスト</del><ins>補完</ins>機能を実現できる。prefix_rk_searchはGroongaには以前のバージョンからあったので、「Mroongaの最新のリリースで<del>サジェスト</del><ins>補完</ins>機能を実現する機能が入った」のではなく、「Groongaのフル機能を使えるようにするプラグマ（<code class=highlighter-rouge>*SS</code>のこと）が入った」というのが正しい。</p><p>この<code class=highlighter-rouge>prefix_rk_search()</code>は、ローマ字やかなを使って、<strong>漢字が入っているカラムに対して</strong>前方一致検索ができる、という機能だ（だいぶ雑な説明。詳細はドキュメントを読まれたい：<a href="http://groonga.org/ja/docs/reference/operations/prefix_rk_search.html">http://groonga.org/ja/docs/reference/operations/prefix_rk_search.html</a>）。</p><p>ただ、これは通常の検索と違い、検索キーワード入力が終わる前に何度もリクエストを投げるのでそこには注意が必要だ。検索専用サーバーを立てるなどの対応が必要になるかも知れない。</p><p>ユーザーの入力を楽にするまた一つの方法として、やはり最新のリリースで、曖昧検索も入った。この日記では「Groonga」というキーワードをよく使っているので、検索すると何件か記事がヒットする。検索時に「Groonag」と綴り間違いをしてしまうかも知れない（僕はこの間違いをよくする。本当によくする）。それでも「Groonga」で検索した時の結果を出してしまう機能が曖昧検索だ。これの詳細は開発者のブログ記事を参照されたし：<a href="http://blog.createfield.com/entry/2016/02/28/014432">http://blog.createfield.com/entry/2016/02/28/014432</a></p></paper-card></article><article><paper-card elevation=2><a href="../../2016/02/29.html"><h1>Sendagaya.rb #139</h1><time pubdate>2016-02-29</time></a><ul class=tags><li><a href="../../tags/ruby.html" rel=tag>Ruby</a></li></ul><p>今日も<a href="https://sendagayarb.doorkeeper.jp/events/39806">Sendagaya.rb #139</a>@<a href="http://www.lanches.co.jp/company">株式会社ランチェスター</a>に参加して来た。『<a href="https://www.oreilly.co.jp/books/9784873117430/">メタプログラミングRuby 第2版</a>』を少し読んだ後、参加者の持ち込んだ相談事の話をしたりした。</p><h2 id=ruby-methodmissing>メタプログラミングRuby method_missing</h2><p>今日は「3.3 method_missing」から。</p><p><a href="http://docs.ruby-lang.org/ja/2.3.0/method/Hash/i/default.html">Hash#default</a>なんてあったんだ、とか、引数なんて取れたんだ、と話していたが、本筋は問題なく読み進んでいた。</p><h2 id=section>相談事</h2><p>その後は参加者の一人が持ち込んだ相談について話した。ただ、業務と直結していてここに書いていいか分からないので割愛。面白い話だったし、実際やってみてどうなったか、後日ぜひ聞きたい。</p><h2 id=sendagayarb-kpt>Sendagaya.rb KPT</h2><p>次回は第140回というまことに切りのいい数値なので、<a href="http://fukajun.org/">fukajun</a>さんの発案で、KPTをやることになった。多分、飲みながら。</p></paper-card></article><footer><ul><li class=next><a href="../7/" rel=next><paper-button raised>前3日分</paper-button></a></li><li class=prev><a href="../9/" rel=prev><paper-button raised>次3日分</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></app-header-layout></main><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>