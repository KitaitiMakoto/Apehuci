<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta name=description content="北市真の日記"><meta content="width=device-width,initial-scale=1.0" name=viewport><title>アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:description content="北市真の日記"><meta name=og:title content="アペフチ"><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"><meta name=robots content="noindex,follow"></head><body class="page page_15 page_15_index"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed condenses effects=waterfall slot=header><app-toolbar></app-toolbar><app-toolbar sticky><h1 class=site-title><a href="../../">アペフチ</a></h1></app-toolbar></app-header><article><paper-card elevation=2><a href="../../2015/12/26.html"><h1>Middleman Web Components</h1><time pubdate>2015-12-26</time></a><ul class=tags><li><a href="../../tags/middleman.html" rel=tag>Middleman</a></li><li><a href="../../tags/web.html" rel=tag>Webコンポーネント</a></li></ul><p>何度か書いたように、この日記はPolymerで作っている、つまりウェブコンポーネントを使っている。そこで、一般的に使いそうな機能をMiddleman拡張として書いていたのだが、今日RubyGemとしてリリースした。<a href="http://www.rubydoc.info/gems/middleman-web_components">Middleman Web Components</a>だ。</p><p>もちろんまだまだ足りないことは多いんだろうと思うが、自分の日記を触りながら拡張していきたいと思う。</p></paper-card></article><article><paper-card elevation=2><a href="../../2015/12/25.html"><h1>Middleman Blogの類似記事をGroongaを使ってリストアップするRubyGemを作った</h1><time pubdate>2015-12-25</time></a><ul class=tags><li><a href="../../tags/groonga.html" rel=tag>Groonga</a></li><li><a href="../../tags/middleman.html" rel=tag>Middleman</a></li></ul><p>この日記は<a href="http://qiita.com/advent-calendar/2015/groonga">Groonga Advent Calendar 2015</a>の21日目の記事です。今日は25日です。大幅に遅れてしまって、本当に申し訳ありません。</p><p>Middlemanでブログの類似記事一覧を作る拡張に<a href="https://github.com/ngs/middleman-blog-similar">Middleman-Blog-Similar</a>がある。類似判定のアルゴリズムを選べたりといい所もあるのだがこれは今のMiddleman v4に対応していない。それにGroonga Advent CalendarのネタとしてもGroongaが使いたかったので、Groongaの類似文書検索機能を使って同様のことをやってみた。</p><p><a href="https://github.com/KitaitiMakoto/middleman-blog-similar-groonga">https://github.com/KitaitiMakoto/middleman-blog-similar-groonga</a></p><p>使うには<code class=highlighter-rouge>middleman-blog-similar-groonga</code>をインストールし、<code class=highlighter-rouge>config.rb</code>で</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="n">activate</span> <span class="ss">:blog_similar_groonga</span>
</code></pre></div><p>と追記する。</p><p>拡張を有効化するとブログ記事向けのレイアウトで<code class=highlighter-rouge>similar_articles</code>というヘルパーが使えるようになる。ここでイテレートされるオブジェクトには</p><ul><li><code class=highlighter-rouge>key.key</code>（パス）</li><li><code class=highlighter-rouge>title</code></li><li><code class=highlighter-rouge>path</code></li><li><code class=highlighter-rouge>body</code>（タグを取り除いたもの）</li></ul><p>の属性があって、わざわざ他記事の<code class=highlighter-rouge>BlogArticles</code>オブジェクトまで辿らなくても済むようになっている。類似記事のタイトルを表示しつつリンクにしたいだけなら充分だろう。</p><div class="language-erb highlighter-rouge"><pre class=highlight><code><span class="nt">&lt;section&gt;</span>
  <span class="nt">&lt;h2&gt;</span>類似記事<span class="nt">&lt;/h2&gt;</span>
  <span class="nt">&lt;ul&gt;</span>
  <span class="cp">&lt;%</span> <span class="n">similar_articles</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">article</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">article</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">article</span><span class="p">.</span><span class="nf">key</span><span class="p">.</span><span class="nf">key</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/section&gt;</span>
</code></pre></div><p>として使うことができる。</p><p>今は本文での類似しか見ていないが、タイトルやタグを使ったほうが人間の感覚に合うだろうから、改善を続けていきたい。</p><p>名前は似ているがMiddleman-Blog-Similarとは全く互換性が無いので注意すること。</p></paper-card></article><article><paper-card elevation=2><a href="../../2015/12/18.html"><h1>ドリルダウン（ファセット検索）の仕組み</h1><time pubdate>2015-12-18</time></a><ul class=tags><li><a href="../../tags/groonga.html" rel=tag>Groonga</a></li><li><a href="../../tags/.html" rel=tag>全文検索</a></li></ul><p><a href="https://groonga.doorkeeper.jp/events/35021">Groongaで学ぶ全文検索 2015-12-18</a>に行って来た。今日のお題はドリルダウン（ファセット検索）。</p><h2 id=section>ドリルダウン</h2><p>ある検索語で検索した時に、検索結果をさらに絞り込む<ins>と何件になるかなどの集計をする（発表した時に間違いを指摘してもらった。ドリルダウンは絞り込みではなく集計）</ins>ことを、予め（検索時に同時に）Groongaがやっておいてくれる、という機能だ。例えば<a href="http://docs.ruby-lang.org/ja/search/">るりまサーチ</a>で、「call」を検索した場合、callを含むページのほか、画面左にインスタンスメソッドが何件あるか、特異メソッドは何件あるか……といった結果も表示されている。これは、「callを含み、かつインスタンスメソッドのページ」は何件あるか、という数になっている。</p><p>このように、検索結果に対して、既に（与えられた）キーで集計した結果を返すのがドリルダウン。まず、既に分類が終わっているので、検索結果を絞り込む作業が簡単に（クリックするだけで）できる。また、0件の時はそのことが分かるので、不要な絞りこみ作業をユーザーがわざわざする必要がない。というように、ドリルダウンは全文検索を補助する機能だ。全文検索とは関係ない文脈では集計機能ということになる。</p><p>ドリルダウンを高速にするために、Groongaのデータ構造が活きている。RDBMSは行指向のテーブル型データベースだから、ストレージ上、一行のデータが複数カラム分、まとまった場所に置かれるようになっている。あるカラムに関する集計（インスタンスメソッドは何件で、特異メソッドは何件で……）をする場合には各行をループさせて、その中で注目しているカラムの場所まで移動して、内容に応じて集計結果を更新する必要がある。</p><p>Groongaは列指向データベースだから、ストレージ上、あるカラムのデータがまとまった場所に置かれている。だから集計する場合には一箇所からデータをまとめて取って来て数えたりしていけばよい。</p><p>集計に関してはこうなっていて、全文検索では更に「検索結果の中で」のそういった集計を行うことになるが、特別なことはない。一旦全文検索を行ってレコードを取得する。その中で更に集計する。ヒットしなかったレコード分はスキップして集計するのでややもったいないが、列指向でのやり方よりは効率がいい。</p><h2 id=section-1>多段ドリルダウン</h2><p>多段ドリルダウンはどうやっているのかも聞いた。本のデータベースがあった時に、雑誌 -&gt; プログラミングというように下位分類を持つようなやつだ（こうじゃないタイプの「多段ドリルダウン」も考えられるそうだが思い出せないとのこと）。</p><p>Groongaにはキーを二個使ってドリルダウンができる機能があるそうだ。列指向データベースなので大分類カラム（「雑誌」）、小分類カラム（「プログラミング」）のデータはそれぞれの場所にまとまって置かれているが、ドリルダウンする時に、それぞれから同じレコードの物を取り出してペアにしてまとめることができるのだ。</p><p>例えば、何かで検索して結果セットが得られた後に、ドリルダウン結果を大分類と小分類のペアである[雑誌,プログラミング]、[ハードカバー,小説]……の集まりというデータとみなして作ることができる。つまり「大分類が雑誌で小分類がプログラミング」というレコード（本）が何件あるか、という結果を作ることができる。</p><p>この結果を使えば、大分類＋小分類での絞り込みをサポートすることができる。が、これだけだと大分類のみでの絞り込み結果を出さない。その結果も勿論欲しいので、更に大分類カラムのみの集計もする……ということはしないで、Groongaは頑張って、あるカラムの一回のスキャンで色んな結果用の処理を行うようになっているらしい（ということは、インデックスを調べる前の計画を頑張っているということかな？<ins>-&gt; 別に頑張ると言うほど大変なことではなかった</ins>）。</p><p>また、この話は（Groongaでは）二個に限らず、n個に一般化できるらしい。</p><h2 id=section-2>ユーザー定義の集約関数</h2><p>参加者から「平均、最大値……」といった予め用意された関数以外の、ユーザーが定義した関数は使えるのか、という質問がでた。結論は「できない」。</p><p>一つはいいインターフェイスがないから。もう一つは、そういう機能を入れると遅くなってしまうから。</p><h2 id=section-3>ドリルダウン結果のデータ構造</h2><p>ドリルダウンの結果はハッシュテーブルになっている。</p><p>分類カラムの集計処理中、「雑誌」という物を見付けた場合、 「雑誌」が、ドリルダウン結果に既にあるかどうかを素早く知る必要があるからだ。なければ結果データに「雑誌」を加えて「1件」というデータにすることになるし、あれば既存の値をインクリメントする必要がある。</p><p>ハッシュのキーはカラムの値その物だとして、バリューの方は、Groongaでは「バリュー」という物になっているらしい。配列とかではない。どんなデータでもよい長さの決まったバイト列で、それを使用する機能の方で適宜解釈して使う、とのこと。</p><p>このバリューの方は、ここまでの話だと合計や最大値などになるので、単独の数値でよさそう。だがもっと別の物を入れてもよくて、実際、全文検索結果レコードの内容を入れると便利になる。ドリルダウン結果に加えて、より詳細な結果を同時に見せられるからだ。例えばGoogle検索でたまに、サイトの下位ページが出ることがあるが、そういった情報を出すために検索結果データの内容を使うことができる。</p></paper-card></article><footer><ul><li class=next><a href="../14/" rel=next><paper-button raised>前3日分</paper-button></a></li><li class=prev><a href="../16/" rel=prev><paper-button raised>次3日分</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></app-header-layout></main><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>