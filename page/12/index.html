<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta name=description content="北市真の日記"><meta content="width=device-width,initial-scale=1.0" name=viewport><title>アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:description content="北市真の日記"><meta name=og:title content="アペフチ"><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"><meta name=robots content="noindex,follow"></head><body class="page page_12 page_12_index"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed condenses effects=waterfall slot=header><app-toolbar></app-toolbar><app-toolbar sticky><h1 class=site-title><a href="../../">アペフチ</a></h1></app-toolbar></app-header><article><paper-card elevation=2><a href="../../2016/01/25.html"><h1>『メタプログラミングRuby 第2版』@Sendagaya.rb #134</h1><time pubdate>2016-01-25</time></a><ul class=tags><li><a href="../../tags/ruby.html" rel=tag>Ruby</a></li></ul><p><a href="https://sendagayarb.doorkeeper.jp/events/38134">Sendagaya.rb #134</a>に参加して『メタプログラミングRuby』の読書会をして来た。今日は初参加、それも「最近Ruby始めたばかりで……」とか「プログラミングを始めたばかりで……」という人がすごく多かった。何があったんだろう？</p><p>先週に引き続き『<a href="https://www.oreilly.co.jp/books/9784873117430/">メタプログラミングRuby 第2版</a>』を読んだ。</p><div class=booklog_html><table><tr><td class=booklog_html_image><a href="http://www.amazon.co.jp/%E3%83%A1%E3%82%BF%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0Ruby-%E7%AC%AC2%E7%89%88-Paolo-Perrotta/dp/4873117437%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4873117437" target=_blank><img src="http://ecx.images-amazon.com/images/I/5102wwx0VzL._SL160_.jpg" width=117 height=150 style="border:0;border-radius:0;"/></a></td><td class=booklog_html_info style="padding-left:20px;"><div class=booklog_html_title style="margin-bottom:10px;font-size:14px;font-weight:bold;"><a href="http://www.amazon.co.jp/%E3%83%A1%E3%82%BF%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0Ruby-%E7%AC%AC2%E7%89%88-Paolo-Perrotta/dp/4873117437%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4873117437" target=_blank>メタプログラミングRuby 第2版</a></div><div style="margin-bottom:10px;"><div class=booklog_html_author style="margin-bottom:15px;font-size:12px;;line-height:1.2em">著者 : <a href="http://booklog.jp/author/Paolo+Perrotta" target=_blank>Paolo Perrotta</a></div><div class=booklog_html_manufacturer style="margin-bottom:5px;font-size:12px;;line-height:1.2em">オライリージャパン</div><div class=booklog_html_release style="font-size:12px;;line-height:1.2em">発売日 : 2015-10-10</div></div><div class=booklog_html_link_amazon><a href="http://booklog.jp/item/1/4873117437" style="font-size:12px;" target=_blank>ブクログでレビューを見る»</a></div></td></tr></table></div><p>「2.2.5 ネームスペースを使う」から15分みんなで黙読して、その後に気になることなどを話した。この「気になること」が盛り上がって、今日は他のことはしなかった。結構知らないことが書いてあって（第1版読んだはずなんだけど殆ど憶えてない……）面白い。</p><p>例えばコラムで<a href="http://docs.ruby-lang.org/ja/2.3.0/method/Kernel/m/load.html">load</a>に触れていた。普通<code class=highlighter-rouge>load</code>は呼ぶ度にスクリプトが実行されるので、定数定義があると再定義の警告が表示されてしまう。ところが第二引数に<code class=highlighter-rouge>true</code>を渡して</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="nb">load</span><span class="p">(</span><span class="s1">'defining-constants.rb'</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
</code></pre></div><p>と呼ぶと、この警告が避けられる。なぜかというと、「第二引数に<code class=highlighter-rouge>true</code>を渡すと、無名モジュールが作成され、スクリプトはその中で実行されるから」だと本では説明されている。「なるほどそうなのか、第二引数のこと知らなかった、勉強になったなあ」と、僕はあっさり流していたが、参加者から「無名モジュールってなんですか」っていう声が上がってそう言えば、知らないな、と思った。無名クラス（匿名クラス）はたまに使うのでそこからの類推と、文脈と合わせて勝手にイメージを作って納得していたが、知らない。ということで、デスクトップをプロジェクターで映していた<a href="http://fukajun.org/">fukajun</a>さんがターミナルを出して、動かしてくれる。みんなで「こういうことかな」「じゃあこういう時はこうなるのかな」などと言っていると、それも全部実行してくれる。こうしてみんなで無名モジュール（anonymous module。僕は匿名モジュールと呼びたい）の理解を深めた。（<ins>翻訳の角さんから、無名、匿名についてこんなコメントを頂いた。<a href="https://twitter.com/kdmsnr/status/691839083266641920">https://twitter.com/kdmsnr/status/691839083266641920</a>。うーんなるほど、勉強になる……。</ins>）</p><p>その後<code class=highlighter-rouge>Class</code>のクラスは？　<code class=highlighter-rouge>Module</code>のクラスは？　<code class=highlighter-rouge>Module</code>のスーパークラスは？　みたいな話が出ていて、Ruby始めたばかりの人がぴんとこないということだったのでその解説をしたりもした（<a href="https://twitter.com/tkawa">tkawa</a>さんが）。</p><p><a href="http://docs.ruby-lang.org/ja/2.3.0/method/Module/i/prepend.html">prepend</a>は第1版にはなかったこともあってかなり盛り上がった。次の記事を見て老害がノスタルジーに浸りながら<code class=highlighter-rouge>alias_method_chain</code>の仕組みを解説したりもした。<br/><a href="http://www.techscore.com/blog/2013/01/22/ruby2-0%E3%81%AEmodule-prepend%E3%81%AF%E5%A6%82%E4%BD%95%E3%81%AB%E3%81%97%E3%81%A6alias_method_chain%E3%82%92%E6%92%B2%E6%BB%85%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B%EF%BC%81%EF%BC%9F/">Ruby2.0のModule#prependは如何にしてalias_method_chainを撲滅するのか！？</a></p><p>本に戻って、文中、<code class=highlighter-rouge>prepend</code>に関して、こういう風に動作を説明してくれる。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="k">module</span> <span class="nn">M1</span><span class="p">;</span> <span class="k">end</span>

<span class="k">module</span> <span class="nn">M2</span>
  <span class="kp">include</span> <span class="no">M1</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">M3</span>
  <span class="n">prepend</span> <span class="no">M1</span>
  <span class="kp">include</span> <span class="no">M2</span>
<span class="k">end</span>

<span class="no">M3</span><span class="p">.</span><span class="nf">ancestors</span> <span class="c1"># =&gt; [M1, M3, M2]</span>
</code></pre></div><p><code class=highlighter-rouge>prepend</code>した<code class=highlighter-rouge>M1</code>が<code class=highlighter-rouge>M3</code>の<strong>前</strong>に差し込まれて、<code class=highlighter-rouge>include</code>した<code class=highlighter-rouge>M2</code>が<strong>後</strong>に置かれている。一度継承ツリーに入ったモジュールは二度は入らない。説明の通りだ。では、</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="k">module</span> <span class="nn">M3</span>
  <span class="kp">include</span> <span class="no">M2</span>
  <span class="n">prepend</span> <span class="no">M1</span>
<span class="k">end</span>
</code></pre></div><p>と順番を変えたら、<code class=highlighter-rouge>M3.ancestors</code>はどうなるだろうか。実行せずに答えられるだろうか？　その答えに、どのくらい確信を持てるだろうか？　これも、各々推測を述べた後、「fukajunターミナル」で実行して、回答を得たりした。</p><p>こういう、一人で本を読んでいるだけだと見逃しがちなことも、誰かが気付いて声を上げてくれるので読書会中々いいです。ただ（と言っても別に悪いとは思ってないけど）、このやり方は時間は掛かる。ので今日のSendagaya.rbはここで終わった。</p><p>次回は</p><ul><li>『メタプログラミングRuby』引き続き</li><li><a href="http://rubyonrails.org/doctrine/">The Rails Doctrine</a>を読んで何か話す</li><li><a href="https://blog.heroku.com/archives/2016/1/22/rails-5-beta-upgrade">Upgrading to Rails 5 Beta - The Hard Way</a>を読んでRails 5へのアップグレードの辛さを感じる</li></ul><p>なんかがいいですかねえ、って話をしていたけど、来週その場で決まることでしょう。</p><p>ちなみに、今回は開催前日にDoorkeeperのイベントが作成されたけど、次回分はその日のうちに作成されていたので、もう申し込める：<br/><a href="https://sendagayarb.doorkeeper.jp/events/38208">https://sendagayarb.doorkeeper.jp/events/38208</a></p></paper-card></article><article><paper-card elevation=2><a href="../../2016/01/24.html"><h1>Droongaのインストーラーを直した</h1><time pubdate>2016-01-24</time></a><ul class=tags><li><a href="../../tags/droonga.html" rel=tag>Droonga</a></li></ul><p><a href="http://droonga.org/ja/">Droonga</a>は、しばらく<a href="http://droonga.org/ja/install/">マニュアル</a>通りにインストールできない状態だったので、インストーラーを直してプルリクエストを送った。</p><ul><li><a href="https://github.com/droonga/droonga-engine/pull/39">https://github.com/droonga/droonga-engine/pull/39</a></li><li><a href="https://github.com/droonga/droonga-http-server/pull/13">https://github.com/droonga/droonga-http-server/pull/13</a></li></ul><p>（マージしてもらった後に問題に気付いて追加でちょいちょいパッチを投げてもいる）</p><p>マージされたものの、今はまだ修正版がリリースはされていないので、それぞれこういう風に<code class=highlighter-rouge>VERSION</code>環境変数を指定してインストールする必要がある。</p><div class=highlighter-rouge><pre class=highlight><code># curl https://raw.githubusercontent.com/droonga/droonga-engine/master/install.sh | \
    VERSION=master bash
# curl https://raw.githubusercontent.com/droonga/droonga-http-server/master/install.sh | \
    VERSION=master bash
</code></pre></div><p>リリースされたら<code class=highlighter-rouge>VERSION=master</code>はなくてもインストールできるようになる。</p><p>また、マニュアルでは<code class=highlighter-rouge>service</code>コマンドでDroongaの二つのプロセスを管理しているけど、今回のパッチで<a href="http://freedesktop.org/wiki/Software/systemd/">systemd</a>を使うようになったので、今マニュアルを直しているところ。来週中にはパッチを送れるはず。</p><p>マニュアル通りに入れられないこと自体は認識していて、ワークアラウンド入りの<a href="http://itamae.kitchen/">Itamae</a>レシピを作って使っていた（<a href="../../2015/12/05.html">DroongaをインストールするItamaeレシピ</a>）。後ろめたさがあった。スキル的には自分で直せるはずなのにそうしていないのは愚か、問題報告すらしていなかった。今回修正して、受け入れてもらって、喉の小骨がようやく取り除けた気分だ。</p><p>恥ずかしながらシェルスクリプトに不慣れで、プルリクエストを送ったあとで、色々指摘してもらいながら直していた。ありがとうございました。</p><p>systemdのunitファイルにも不安があるので、こうしたほうがいいよというのがあったらぜひ教えてほしい。</p><ul><li><a href="https://github.com/droonga/droonga-engine/blob/master/install/droonga-engine.service">droonga-engine.service</a></li><li><a href="https://github.com/droonga/droonga-http-server/blob/master/install/droonga-http-server.service">droonga-http-server.service</a></li></ul></paper-card></article><article><paper-card elevation=2><a href="../../2016/01/20.html"><h1>渋谷.rb[:20160120]</h1><time pubdate>2016-01-20</time></a><ul class=tags><li><a href="../../tags/ruby.html" rel=tag>Ruby</a></li><li><a href="../../tags/itamae.html" rel=tag>Itamae</a></li></ul><p>久し振りに<a href="https://shibuyarb.doorkeeper.jp/events/37064">渋谷.rb[:20160120]</a>に行って来た。初参加の人が半分近くいて、すごいなあと思った。</p><p>予め予告のあった<a href="https://docs.google.com/presentation/d/1RTUIJYJUCx_8MRj4hHx7uPbMOQSmCIF3Nobrttd1HfQ/edit">主人がExcel方眼紙に殺されてRubyを書き始めてから5ヶ月が過ぎました</a>っていう発表のほか、みんな何かしら話すことがあって、九時過ぎまで発表が続いていた。中でも<a href="https://github.com/yuku-t">yuku-t</a>さんの発表が印象に残っていて、最終的には<a href="https://github.com/yuku-t/duck_testing">duck_testing</a>っていうRubyGemの紹介と「いい感じにしてほしい」というお願いになったんだけど、このgemを作るに至る経緯の説明がよかった。</p><p>基本的には、型でチェックしたいという話。だから、各メソッドにはYARD向けのコメントで引数の型と戻り値の型を書いている。でも当然ながらYARDのコメントをRubyは見てくれないので、<a href="https://github.com/egonSchiele/contracts.ruby">contracts.ruby</a>の導入を検討した。でも、実装方法が危なっかしい（中では、古い人は知っているかも知れない、<a href="https://github.com/michaelfairley/method_decorators">MethodDecorators</a>を使っている）のと、本番でオフにできないので、やめた。YARDのコメントを読み取って自動で型に関するテストを生成し実行する、というgemを作ったとのこと。</p><p>YARDはコードの解析に<a href="http://docs.ruby-lang.org/ja/2.3.0/class/Ripper.html">Ripper</a>を使っていて、そのASTにプラグインからアクセスできるので、contarcts.ruby用のプラグインを書けばそこからドキュメントを自動生成できるはずだし、事実そういうYARDプラグインがあるらしい。でも既にYARD向けのコメントをたくさん書いていて、それを全部直して回るのは大変。さらに、YARDでドキュメントコメントを書いているgemは多いので、そこに一行足すだけで自動的にテスまでできるという物は、多くの人に役立つはずだ、という説明がされた。最後の、自分の問題を解決すると、より多くの人の問題も、労力無く解決できるという視点が素晴らしいなと思った。期待したい。</p><p>僕は先日の日記に書いた<a href="16.html">『nginx実践入門』をシンタックスハイライトする</a>の内容をデモしつつ、「コードからその言語を判定するところ、今は目視でやって設定をハードコードしていて辛いので、やってくれるgemを知っている人がいたら教えてください」という相談をしてきた。その後の夕食の時とかに聞くと、意外とこれが反響があって嬉しかった。もうちょっと抽象化してgemにしたいなという気持ちになってきた。</p><p>あと、渋谷.rbとは関係ないけど日記なので書くと、<a href="https://github.com/KitaitiMakoto/itamae-plugin-resource-security_context">itamae-plugin-resource-security_context</a>というItamaeプラグインをリリースした。今のところ<code class=highlighter-rouge>restorecon</code>をするだけだけど、仕事で必要になるに連れてほかのこともできるようにしていきたい。SELinux使っている人がもしいたら、一緒に開発していきましょう……。</p></paper-card></article><footer><ul><li class=next><a href="../11/" rel=next><paper-button raised>前3日分</paper-button></a></li><li class=prev><a href="../13/" rel=prev><paper-button raised>次3日分</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></app-header-layout></main><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>