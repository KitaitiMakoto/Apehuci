<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta name=description content="北市真の日記"><meta content="width=device-width,initial-scale=1.0" name=viewport><title>アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:description content="北市真の日記"><meta name=og:title content="アペフチ"><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"><meta name=robots content="noindex,follow"></head><body class="page page_13 page_13_index"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed condenses effects=waterfall slot=header><app-toolbar></app-toolbar><app-toolbar sticky><h1 class=site-title><a href="../../">アペフチ</a></h1></app-toolbar></app-header><article><paper-card elevation=2><a href="../../2016/01/18.html"><h1>Sendagaya.rb #133</h1><time pubdate>2016-01-18</time></a><ul class=tags><li><a href="../../tags/ruby.html" rel=tag>Ruby</a></li><li><a href="../../tags/ruby-on-rails.html" rel=tag>Ruby On Rails</a></li><li><a href="../../tags/action-cable.html" rel=tag>Action Cable</a></li></ul><p><a href="https://sendagayarb.doorkeeper.jp/events/37324">Sendagaya.rb #133</a>に行って来た。今日は、前半『<a href="https://www.oreilly.co.jp/books/9784873117430/">メタプログラミングRuby 第2版</a>』を読んで、後半は<a href="https://github.com/rails/rails/tree/master/actioncable">Action Cable</a>を読んだ。</p><h2 id=ruby-2>メタプログラミングRuby 第2版</h2><div class=booklog_html><table><tr><td class=booklog_html_image><a href="http://www.amazon.co.jp/%E3%83%A1%E3%82%BF%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0Ruby-%E7%AC%AC2%E7%89%88-Paolo-Perrotta/dp/4873117437%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4873117437" target=_blank><img src="http://ecx.images-amazon.com/images/I/5102wwx0VzL._SL160_.jpg" width=117 height=150 style="border:0;border-radius:0;"/></a></td><td class=booklog_html_info style="padding-left:20px;"><div class=booklog_html_title style="margin-bottom:10px;font-size:14px;font-weight:bold;"><a href="http://www.amazon.co.jp/%E3%83%A1%E3%82%BF%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0Ruby-%E7%AC%AC2%E7%89%88-Paolo-Perrotta/dp/4873117437%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4873117437" target=_blank>メタプログラミングRuby 第2版</a></div><div style="margin-bottom:10px;"><div class=booklog_html_author style="margin-bottom:15px;font-size:12px;;line-height:1.2em">著者 : <a href="http://booklog.jp/author/Paolo+Perrotta" target=_blank>Paolo Perrotta</a></div><div class=booklog_html_manufacturer style="margin-bottom:5px;font-size:12px;;line-height:1.2em">オライリージャパン</div><div class=booklog_html_release style="font-size:12px;;line-height:1.2em">発売日 : 2015-10-10</div></div><div class=booklog_html_link_amazon><a href="http://booklog.jp/item/1/4873117437" style="font-size:12px;" target=_blank>ブクログでレビューを見る»</a></div></td></tr></table></div><p><a href="http://fukajun.org/">fukajun</a>さんが「本を読むってどうやってやるんですかねえ？」って言ったけど誰も答えを持ち合わせていなかった。十五分みんな黙読し、その後気になったことを話すというスタイルになった。範囲は「2章 月曜日：オブジェクトモデル」の始めから「2.2.4 オブジェクトとクラスのまとめ」まで。みんなRubyを書けるので特に問題がなく、字が汚いとか</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="k">module</span> <span class="nn">Rake</span>
  <span class="k">class</span> <span class="nc">Task</span>
    <span class="c1"># ...</span>
</code></pre></div><p>を</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="k">class</span> <span class="nc">Rake</span><span class="o">::</span><span class="no">Task</span>
  <span class="c1"># ...</span>
</code></pre></div><p>って書いたら<a href="https://houndci.com/">HoundCI</a>に怒られるんだけどなんでだろう？　といったことを話していた。</p><p>次回は「2.2.5 ネームスペースを使う」から。毎週ちょっとずつは読むとのこと。</p><p>また、ここのところ本にシンタックスハイライトを入れるのをやっていたので、この本も帰ったらやろうと思っていたが、始めからハイライトされていた。 <a href="https://gyazo.com/bcd51dd81e50c33c4b8fe5d714ca8887"><img src="https://gyazo.com/bcd51dd81e50c33c4b8fe5d714ca8887.png" alt="『メタプログラミングRuby 第2版』は始めからシンタックスハイライトされている" style="max-width: 80%;"/></a></p><h2 id=action-cable>Action Cable</h2><p><code class=highlighter-rouge>ApplicationCable::Channel</code>のユーザー定義のメソッドのスタックトレースを遡って、どこから呼ばれるのかを見ていった。</p><p>fukajunさんがプロジェクターで映しながらエディターを開いてソースを追い掛け、みんなで横からああだこおだと言っていた。読んだのはだいたいこの辺。</p><ul><li><a href="https://github.com/rails/rails/blob/39f383bad01e52c217c9007b5e9d3b239fe6a808/actioncable/lib/action_cable/connection/subscriptions.rb">action_cable/connection/subscriptions.rb</a></li><li><a href="https://github.com/rails/rails/blob/39f383bad01e52c217c9007b5e9d3b239fe6a808/actioncable/lib/action_cable/connection/message_buffer.rb">action_cable/connection/message_buffer.rb</a></li><li><a href="https://github.com/rails/rails/blob/39f383bad01e52c217c9007b5e9d3b239fe6a808/actioncable/lib/action_cable/server/worker.rb">action_cable/server/worker.rb</a></li></ul><p>一度<a href="https://github.com/celluloid/celluloid">Celluloid</a>をやめて<a href="https://github.com/ruby-concurrency/concurrent-ruby">Concurrent Ruby</a>にしたところ（<a href="https://github.com/rails/rails/commit/3b7ccadfc1c8dfec61af898167e1300b17f5cf25">3b7ccad</a>）、それを巻き戻し（<a href="https://github.com/rails/rails/commit/d0393fccffc118a5de37654aa222774b66123393">d0393fc</a>）、更にまた巻き戻す（<a href="https://github.com/rails/rails/commit/01c320001bcce617196270f3d398d48a89a6ea2a">01c3200</a>）ということをしていて、この辺の扱い大変なんだなあという話をした。使いたいのはCelluloidの方であるようだ（<a href="https://github.com/rails/rails/pull/22977">#22977</a>）。</p><p>ここを読んだおかげで、<a href="http://necojackarc.hatenablog.com/entry/2015/12/20/043612">Rails5.0.0-beta1のActionCableを使って超簡易チャットを実装してみた</a>にある</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="k">class</span> <span class="nc">MessagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="no">ActionCable</span><span class="p">.</span><span class="nf">server</span><span class="p">.</span><span class="nf">broadcast</span> <span class="s2">"messages"</span><span class="p">,</span>
      <span class="ss">message: </span><span class="n">params</span><span class="p">[</span><span class="ss">:message</span><span class="p">][</span><span class="ss">:body</span><span class="p">],</span>
      <span class="ss">username: </span><span class="n">cookies</span><span class="p">.</span><span class="nf">signed</span><span class="p">[</span><span class="ss">:username</span><span class="p">]</span>

    <span class="n">head</span> <span class="ss">:ok</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>みたいなコードを見ても驚かずに「なるほど<code class=highlighter-rouge>ActionCable.server.broadcast</code>に渡している<code class=highlighter-rouge>"messages"</code>コマンドは別スレッドで実行されるからここはブロックせずに、即座にブラウザーに応答することができるんだな」と考えることができるようになった（でも、僕は気にならないけど、コントローラー内でこういうことするのに違和感を覚える人もいた）。</p><h2 id=electronrails-assetsjavascript>electron、rails-assets、JavaScript生態系</h2><p>なんかelectronが盛り上がってるらしく、夕食を頂きながら仕組みとかHTMLで作るのどうなの？　とか、rails-assetsとか派生してJavaScriptの開発環境って今どんな感じなの？　といった話をした。</p></paper-card></article><article><paper-card elevation=2><a href="../../2016/01/16.html"><h1>『nginx実践入門』をシンタックスハイライトする</h1><time pubdate>2016-01-16</time></a><ul class=tags><li><a href="../../tags/epub.html" rel=tag>EPUB</a></li><li><a href="../../tags/ruby.html" rel=tag>Ruby</a></li><li><a href="../../tags/nginx.html" rel=tag>Nginx</a></li></ul><p>『<a href="https://gihyo.jp/dp/ebook/2016/978-4-7741-7936-0">nginx実践入門</a>』を買った。</p><div class=booklog_html><table><tr><td class=booklog_html_image><a href="http://www.amazon.co.jp/nginx%E5%AE%9F%E8%B7%B5%E5%85%A5%E9%96%80-WEB-DB-PRESS-plus-%E4%B9%85%E4%BF%9D/dp/4774178667%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4774178667" target=_blank><img src="http://ecx.images-amazon.com/images/I/511NShYrT8L._SL160_.jpg" width=105 height=150 style="border:0;border-radius:0;"/></a></td><td class=booklog_html_info style="padding-left:20px;"><div class=booklog_html_title style="margin-bottom:10px;font-size:14px;font-weight:bold;"><a href="http://www.amazon.co.jp/nginx%E5%AE%9F%E8%B7%B5%E5%85%A5%E9%96%80-WEB-DB-PRESS-plus-%E4%B9%85%E4%BF%9D/dp/4774178667%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4774178667" target=_blank>nginx実践入門 (WEB+DB PRESS plus)</a></div><div style="margin-bottom:10px;"><div class=booklog_html_author style="margin-bottom:15px;font-size:12px;;line-height:1.2em">著者 : <a href="http://booklog.jp/author/%E4%B9%85%E4%BF%9D%E9%81%94%E5%BD%A6" target=_blank>久保達彦</a></div><div class=booklog_html_manufacturer style="margin-bottom:5px;font-size:12px;;line-height:1.2em">技術評論社</div><div class=booklog_html_release style="font-size:12px;;line-height:1.2em">発売日 : 2016-01-16</div></div><div class=booklog_html_link_amazon><a href="http://booklog.jp/item/1/4774178667" style="font-size:12px;" target=_blank>ブクログでレビューを見る»</a></div></td></tr></table></div><p>早速設定ファイルの所などをシンタックスハイライトした。 <a href="https://gyazo.com/7fa685b4b5ff7ab226c72794b5a89d4b"><img src="https://gyazo.com/7fa685b4b5ff7ab226c72794b5a89d4b.png" alt="Nginxの設定ファイルがシンタックスハイライトされている" style="max-width: 60%;"/></a></p><p>以下の手順で再現可能。本のEPUBファイルが<code class=highlighter-rouge>path/to/nginx実践入門.epub</code>にあるものとする。</p><div class=highlighter-rouge><pre class=highlight><code>$ gem install epub-parser -v '&gt;= 0.2.4'
$ gem install epub-maker -v 0.0.3
$ gem install rouge rouge-lexers-docker
$ git clone https://gist.github.com/0779a34fd74bae96468f.git rougify-gdp-book
$ cd rougify-gdp-book
$ ruby rougify-gdp-book.rb path/to/nginx実践入門.epub
</code></pre></div><p>EPUBファイルを<strong>上書きする</strong>ので注意すること。</p><p>『<a href="https://gihyo.jp/dp/ebook/2015/978-4-7741-7879-0">APIデザインケーススタディ</a>』（<a href="03.html">『APIデザインケーススタディ』を、ソースコードのシンタックスハイライトしながら読む</a>）とか『<a href="https://gihyo.jp/dp/ebook/2015/978-4-7741-7464-8">Dockerエキスパート養成読本</a>』（<a href="http://apehuci-kitaitimakoto.sqale.jp/apehuci/?date=20150705">Dockerエキスパート養成読本を、ソースコードのシンタックスハイライトしながら読む</a>）とか、EPUBファイルに後から手を加えてシンタックスハイライトしているけど、別にこれがそれほどいいことだとは思っていない。こういうことができるように、DRMなしのEPUBを売ってくれている技術評論社には感謝しているが、できれば本を作る時にハイライトを入れてくれるのが一番いいと思っている。</p><h2 id=section>追記</h2><p>こんなコメントを貰った。</p><blockquote class=twitter-tweet lang=ja><p lang=ja dir=ltr>“できれば本を作る時にハイライトを入れてくれるのが一番いいと思っている” モノクロ端末や誤認識を考えると入れるのに二の足を踏むのはあるかも / “『nginx実践入門』をシンタックスハイライトする” <a href="https://t.co/xvneTcDdwf">https://t.co/xvneTcDdwf</a></p>&mdash; masayoshi takahashi (@takahashim) <a href="https://twitter.com/takahashim/status/688686509696811009">2016, 1月 17</a></blockquote><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script><p>なるほど、確かに。色の区別がつきにくい人もいるし、白黒のままのほうがよさそうだ。切り替えられるように作るべきかは、悩ましいところ。</p></paper-card></article><article><paper-card elevation=2><a href="../../2016/01/15.html"><h1>Groongaの運用（データの守り方）</h1><time pubdate>2016-01-15</time></a><ul class=tags><li><a href="../../tags/groonga.html" rel=tag>Groonga</a></li><li><a href="../../tags/mysql.html" rel=tag>MySQL</a></li><li><a href="../../tags/postgresql.html" rel=tag>PostgreSQL</a></li></ul><p><a href="https://groonga.doorkeeper.jp/events/36432">Groongaで学ぶ全文検索 2016-01-15</a>に参加して来た。今日のテーマは運用、その中でもデータの守り方。</p><h2 id=rdbms>RDBMSでのデータの守り方</h2><p>Groongaの話の前に、ファイルとRDBMSでのデータの守り方の話をしてもらった。</p><p>ファイルにデータを書き込むとデータが永続化する。書き込みの時に、途中で何らかの理由で中断が起きると途中までしか書き込まれない。「Hello」と書き込むつもりだったのに「Hel」までしか書き込まれていない、といったことが起こる。これはデータが守られていない状態だと言える。不測の事態のせいでおかしなデータを持つことになってしまっている。</p><p>RDBMSでは、こういった「おかしなデータ」が存在しないように、トランザクションを使うようになっている。トランザクションを使うと、場合によってはデータが書き込まれていないことがあるが、途中まで書き込まれているというおかしな状態になるのは防ぐことができる。</p><p>RDBMSがこうして頑張っていても、ストレージデバイスが壊れるとデータは失われてしまう。これを防ぐのは「運用」の仕事になる。</p><p>データ消失を防ぐためには、何らかの方法でコピーを取る。コピーがあればあるだけ、それら全部が同時に壊れる可能性は低くなるので、データは守られる。ただ、お金が掛かったり帯域を使用したりするというトレードオフがある。</p><h2 id=groonga>Groongaでのデータの守り方</h2><p>ここまでがデータを守る運用の一般的な話で、ここから全文検索エンジン、特にGroonga族の話。</p><p>全文検索エンジンはトランザクションに対応している物は少なく、Groongaも対応していない。こうした時におかしなデータという状態を防ぐには大きく分けて二つの方法がある。</p><p>一つはデータベースのデータのバックアップを取っておいて、データ損失が起こったら、バックアップ時点へ巻き戻す方法。この場合、バックアップ時点から障害時点までの間に新しく作られたデータは失われ、更新されたデータは更新前の物に戻る。</p><p>二つ目は、Groongaでデータがおかしな状態になったり失われたりするのを防ぐのは諦めて、マスターデータの方が失われないよう仕組みを整える方法。マスターデータがあれば、いつでもGroongaのインデックスを復旧できる。Groongaの運用では、こちらのほうが現実的。マスターデータの守り方は色々あるので、データの性質やシステムの条件などで適切な物を選ぶ。RDBMS上のデータをマスターとしたり、ファイルとして保存したり、クラウド上のデータストアに置いたり。</p><h2 id=section>復旧に掛かる時間</h2><p>復旧することでデータを元に戻せるが、これに時間が掛かると、ダウンタイムがそれだけ長くなってしまう。上の二つ目、マスターデータを頑張って守る方法は、Groongaの復旧では一から全てのデータを入れ直すので、最も時間がかかる。</p><p>一つ目の方法の時間の掛かり方は、バックアップ時点から障害時点までの間のデータの扱い次第。そこのデータを諦めるなら、バックアップが（コピーなどするだけで）そのまま使えるので復旧は速い。バックアップ時点から障害時点までは、コピーではなくて差分バックアップを取っておくようにする方法もある。この場合は、バックアップ時点までの復旧は速く、そこから差分バックアップの内容を適用する部分では時間が掛かる。</p><p>また、一つ目の方法、コピーを取る方法のバリエーションとして、レプリケーションもある。レプリケーションは概ねリアルタイムに全データをバックアップ取れるが、デザイン上の問題やネットワーク遅延、マスターとレプリカ間の性能の違いなどで遅延はある。</p><h2 id=groonga-1>Groongaでのバックアップ</h2><p>Groongaにはトランザクションがないので、書き込み中に処理が止まるとデータがおかしなことになってしまう（ことがある）。マスターデータを用意して復旧に備えるのが現実的な運用になる。この時、前述の通り復旧に時間が掛かってしまうことになるが、普段サービスしている時は一つ一つ順にデータを書き込んでいるような物でも、まとめて一度に書き込めるモードがあって、これを使うとより速く復旧できる。また、そもそもGroongaは書き込み性能が高いので、RDBMSに比べると復旧は速い。</p><p>Groonga族のMroonga、PGroongaでのバックアップは、それぞれのRDBMSの仕組みに乗るのがよい。それぞれトランザクションやレプリケーションがある。</p><p>また、MySQLの場合、InnoDBのレプリケーション先としてMroongaを選ぶことができる。こうすると、（データが守られやすい）InnoDBをマスターデータとして考えることができる。</p><p>PostgreSQLにもレプリケーションの仕組みはあるが、MySQLのレプリケーションの仕組みとはだいぶ違う。MySQLではINSERTなどの命令をレプリケーションに流すので、その命令をGroongaの物として読み替えることができた。PostgreSQLはファイルパスやファイル内のバイトオフセットなど物理的な位置を流してレプリケーションに使うので、この情報をGroongaのインデックス更新のために読み替えることができない。そこで、復旧の際には、PostgreSQLにREINDEXを書けてGroongaのインデックスを作り直すことになる。</p><h2 id=section-1>レプリケーションではまりがちな罠</h2><p>また、全文検索エンジンに限らないがレプリケーションの運用について大事なことは、システムのキャパシティを考える時にレプリカを含んではいけないということだ。マスターとレプリカを含めた台数でちょうどさばけているようなシステムは、レプリカが一台落ちただけで、システム全体が検索をさばき切れなくなって、落ちたりする。</p><p>レプリカは遊んでいるように見えるのでつい使いたくなるが使ってはいけない。正確には、レプリカを入れてちょうど検索を捌けるというようなプランニング、運用をしてはいけない。</p><h2 id=section-2>その他</h2><p>気になったので聞いてみた。マスターDBでSSDを使うのはありなのか？　実際SSDで運用している人がいた。のでありなんだろうなあ。</p><p>Groongaのデータをコピーやdumpコマンドによってバックアップ取る際、中途半端な状態のコピーになってしまうことはないのか？　ある。のでシステムから切り離してバックアップするとか、バックアップ専用にテーブルを作ってバックアップ取ったら消すとか、工夫して運用する必要がある。</p></paper-card></article><footer><ul><li class=next><a href="../12/" rel=next><paper-button raised>前3日分</paper-button></a></li><li class=prev><a href="../14/" rel=prev><paper-button raised>次3日分</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></app-header-layout></main><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>