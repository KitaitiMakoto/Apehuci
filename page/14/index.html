<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta name=description content="北市真の日記"><meta content="width=device-width,initial-scale=1.0" name=viewport><title>アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:description content="北市真の日記"><meta name=og:title content="アペフチ"><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"><meta name=robots content="noindex,follow"></head><body class="page page_14 page_14_index"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed condenses effects=waterfall slot=header><app-toolbar></app-toolbar><app-toolbar sticky><h1 class=site-title><a href="../../">アペフチ</a></h1></app-toolbar></app-header><article><paper-card elevation=2><a href="../../2016/01/03.html"><h1>『APIデザインケーススタディ』を、ソースコードのシンタックスハイライトしながら読む</h1><time pubdate>2016-01-03</time></a><ul class=tags><li><a href="../../tags/epub.html" rel=tag>EPUB</a></li><li><a href="../../tags/ruby.html" rel=tag>Ruby</a></li></ul><p>昨日（<a href="02.html">EPUB書籍に正誤表を反映する（Rubyスクリプトで）、またはEPUBのパッチプログラムの試み</a>）に引き続き「ちゃんと正誤表を公表してくれる著者と、DRMをかけない素のEPUBファイルを配信してくれる出版社があればこそ」シリーズの第二弾（第三弾は多分無い）。</p><p>以前<a href="http://apehuci-kitaitimakoto.sqale.jp/apehuci/?date=20150705">Dockerエキスパート養成読本を、ソースコードのシンタックスハイライトしながら読む</a>という日記を書いたが、その時のスクリプトを修正して、『APIデザインケーススタディ』にも対応させた。</p><div class=booklog_html><table><tr><td class=booklog_html_image><a href="http://www.amazon.co.jp/API%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%82%B1%E3%83%BC%E3%82%B9%E3%82%B9%E3%82%BF%E3%83%87%E3%82%A3-%7ERuby%E3%81%AE%E5%AE%9F%E4%BE%8B%E3%81%8B%E3%82%89%E5%AD%A6%E3%81%B6%E3%80%82%E5%95%8F%E9%A1%8C%E3%81%AB%E5%8D%B3%E3%81%97%E3%81%9F%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%81%A8%E6%99%AE%E9%81%8D%E3%81%AE%E8%80%83%E3%81%88%E6%96%B9-WEB-PRESS-plus/dp/4774178020%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4774178020" target=_blank><img src="http://ecx.images-amazon.com/images/I/514Ve4nSUZL._SL160_.jpg" width=105 height=150 style="border:0;border-radius:0;"/></a></td><td class=booklog_html_info style="padding-left:20px;"><div class=booklog_html_title style="margin-bottom:10px;font-size:14px;font-weight:bold;"><a href="http://www.amazon.co.jp/API%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%82%B1%E3%83%BC%E3%82%B9%E3%82%B9%E3%82%BF%E3%83%87%E3%82%A3-%7ERuby%E3%81%AE%E5%AE%9F%E4%BE%8B%E3%81%8B%E3%82%89%E5%AD%A6%E3%81%B6%E3%80%82%E5%95%8F%E9%A1%8C%E3%81%AB%E5%8D%B3%E3%81%97%E3%81%9F%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%81%A8%E6%99%AE%E9%81%8D%E3%81%AE%E8%80%83%E3%81%88%E6%96%B9-WEB-PRESS-plus/dp/4774178020%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4774178020" target=_blank>APIデザインケーススタディ ~Rubyの実例から学ぶ。問題に即したデザインと普遍の考え方 (WEB+DB PRESS plus)</a></div><div style="margin-bottom:10px;"><div class=booklog_html_author style="margin-bottom:15px;font-size:12px;;line-height:1.2em">著者 : <a href="http://booklog.jp/author/%E7%94%B0%E4%B8%AD%E5%93%B2" target=_blank>田中哲</a></div><div class=booklog_html_manufacturer style="margin-bottom:5px;font-size:12px;;line-height:1.2em">技術評論社</div><div class=booklog_html_release style="font-size:12px;;line-height:1.2em">発売日 : 2015-12-16</div></div><div class=booklog_html_link_amazon><a href="http://booklog.jp/item/1/4774178020" style="font-size:12px;" target=_blank>ブクログでレビューを見る»</a></div></td></tr></table></div><p>元々の本は（PDF版から類推するに）ソースコードの所も白黒のようだけど、こうしてハイライトして読むことができるようになる。</p><figure><a href="https://gyazo.com/ed5d038aace704a0fcea8313dddf3fb9" target=gyazo><img src="//gyazo.com/ed5d038aace704a0fcea8313dddf3fb9.png" alt="Rubyのコードがシンタックスハイライトされている" style="max-width: 50%;"/></a><a href="https://gyazo.com/5bf04bb00b3537f488e4811ceab3f826" target=gyazo><img src="//gyazo.com/5bf04bb00b3537f488e4811ceab3f826.png" alt="PythonやPerlも含めソースコードがシンタックスハイライトされている" style="max-width: 50%;"/></a></figure><p>スクリプトは前と同じ所に置いてある：<br/><a href="https://gist.github.com/KitaitiMakoto/0779a34fd74bae96468f">https://gist.github.com/KitaitiMakoto/0779a34fd74bae96468f</a></p><p>クローンなりダウンロードなりして</p><div class=highlighter-rouge><pre class=highlight><code>$ ruby rougify-gdp-book.rb path/to/api-design.epub
</code></pre></div><p>と実行すればよい。</p><p>これで、ようやく本を読む準備が整った。</p><blockquote><p>ともあれ、<strong>こんなことができるのも、ちゃんと正誤表を公表してくれる著者と、DRMをかけない素のEPUBファイルを配信してくれる出版社があればこそ</strong>。感謝したい。</p></blockquote><p>（<a href="http://sho.tdiary.net/20151222.html"><cite>EPUB書籍に正誤表を反映する</cite></a>）</p><p>である。</p><hr/><p>スクリプトの修正にあたって、プログラミング言語の推測に苦労した（ハイライトに使っている<a href="http://rouge.jneen.net/">Rouge</a>はshebangを見るくらいしかしてくれない）。主な方法は、「そのソースコードが含まれる節の見出し（<code class=highlighter-rouge>h2</code>や<code class=highlighter-rouge>h3</code>）と言語の対応表を作る」ということになった。「見出しにシステムコールという語が含まれていればCだろう」という具合である。</p><p>これも中々うまい法則を見付けられず、結局一つ一つの見出しと<code class=highlighter-rouge>code</code>要素を見て手作業で対応表を作った。途中、「こんなのは人間の仕事ではない！」と思って<a href="https://github.com/github/linguist">github-linguist</a>の使用も検討したが、Gitリポジトリー全体でなく個別のテキストに対して使う方法がすぐに分からなかったのでやめた。</p><p>技評の方で<code class=highlighter-rouge>&lt;code&gt;</code>要素の<code class=highlighter-rouge>class</code>属性や<code class=highlighter-rouge>data-*</code>属性で言語名を書いておいてくれると、一番楽なんだけどなあ。</p><hr/><p>ところで、確認中に、EPUB版の索引が全然機能しないことに気付いたんだけど、これも本文へのリンクにするスクリプトを配ったら喜ばれるものだろうか……。</p></paper-card></article><article><paper-card elevation=2><a href="../../2016/01/02.html"><h1>EPUB書籍に正誤表を反映する（Rubyスクリプトで）、またはEPUBのパッチプログラムの試み</h1><time pubdate>2016-01-02</time></a><ul class=tags><li><a href="../../tags/epub.html" rel=tag>EPUB</a></li><li><a href="../../tags/ruby.html" rel=tag>Ruby</a></li></ul><p>田中哲さんの『<a href="https://gihyo.jp/dp/ebook/2015/978-4-7741-7879-0">APIデザインケーススタディ</a>』を買ったので、前『<a href="http://gihyo.jp/book/2015/978-4-7741-7441-9">Dockerエキスパート養成読本</a>』でやったように（<a href="http://apehuci-kitaitimakoto.sqale.jp/apehuci/?date=20150705">Dockerエキスパート養成読本を、ソースコードのシンタックスハイライトしながら読む</a>）ソースコードの部分をシンタックスハイライトしようとしたところで、ただただしさんの「<a href="http://sho.tdiary.net/20151222.html">EPUB書籍に正誤表を反映する</a>」という日記を読んだ。本の<a href="https://github.com/akr/api-design-case-study-book">正誤表</a>を見ながらEPUBファイルの中身を直接書き換えることで、誤りを正した状態で読み始められるようにする、という内容だ。</p><p>これは素晴らしい、ぜひ真似しよう、と思って、スクリプトを書いた：<br/><a href="https://gist.github.com/KitaitiMakoto/7b2286b61a0bafcc5926">https://gist.github.com/KitaitiMakoto/7b2286b61a0bafcc5926</a></p><p>必要なのは</p><ul><li>『<a href="https://gihyo.jp/dp/ebook/2015/978-4-7741-7879-0">APIデザインケーススタディ</a>』のEPUBファイル（<code class=highlighter-rouge>path/to/book.epub</code>にあることにする）</li><li>Ruby</li><li>幾つかのRubyGem：<code class=highlighter-rouge>$ gem install nokogiri-xml-range epub-parser epub-maker</code></li><li>Gistにある<code class=highlighter-rouge>reflect-errata-api-design.rb</code>のファイル</li></ul><p>で、全て揃ったら</p><div class=highlighter-rouge><pre class=highlight><code>$ ruby reflect-errata-api-design.rb path/to/book.epub
</code></pre></div><p>と実行すると正誤表を反映してくれる。</p><figure><a href="https://gyazo.com/10bc38f6f2acb88d2217b3d36c1c4e62" target=gyazo><img alt="正誤表適用前" src="//gyazo.com/10bc38f6f2acb88d2217b3d36c1c4e62.png" style="width: 50%;"/></a><a href="https://gyazo.com/5bd09585adc98a282ea30b000cc8e101" target=gyazo><img alt="正誤表適用前" src="//gyazo.com/5bd09585adc98a282ea30b000cc8e101.png" style="width: 50%;"/></a><figcaption>「w<strong style="color: red;">ir</strong>te」だった所が「w<strong style="color: red;">ri</strong>te」と修正されている</figcaption></figure><p>大掛かりである。上記の手順だけで充分大掛かりなのに、このスクリプトを書くには数時間を要している。今回程度の数、内容なら、たださんの日記にあるように、エディターを使って手作業で反映させるのが一番手間がないだろう。</p><p>ちなみに</p><blockquote><p>正誤表はページ数指定なので、HTMLファイルを特定するのにPDF版を参照してページ数から章番号を突き止めるしかないのがやや面倒</p></blockquote><p>とのことで、EPUBでの対応箇所を探す多分一番簡単な方法は</p><ol><li>EPUBファイルを展開する<br/><code class=highlighter-rouge>$ unzip path/to/book.epub -d api-design</code></li><li><code class=highlighter-rouge>grep</code>やThe Silver Searcher（<code class=highlighter-rouge>ag</code>）、The Platinum Searcher（<code class=highlighter-rouge>pt</code>）で展開したディレクトリーを探す<br/><code class=highlighter-rouge>$ ag wirte api-design</code><br/><code class=highlighter-rouge>$ ag をを api-design</code><br/> :</li></ol><p>ではなかろうかと思う（検索機能付きのパソコン向けEPUBリーダーってある？）。</p><h2 id=gem>使っているgemの紹介</h2><p>さてこのスクリプト、これまで色々準備してたことのプチ決算な趣があるので、少し自慢話にお付き合い願いたい。動かすのに必要なgemを三つ挙げたが、全て僕が作ったgemで、こんなこともあろうかと準備してきた物々なのである。</p><h3 id=epub-parsercfi>EPUB ParserのCFI実装</h3><p>前からずっと<a href="http://www.rubydoc.info/gems/epub-parser/0.2.4/file/docs/Home.markdown">EPUB Parser</a>という、EPUBファイルの中身を調べるgemを作っていた。このgemが扱っているEPUB 3仕様には<a href="http://www.idpf.org/epub/linking/cfi/epub-cfi.html">EPUB CFI</a>という補足的な仕様がある。「本の中のある一点（一文字）」や「ある場所からある場所まで」といった範囲を指定するための記法を定義した仕様だ。</p><div class=highlighter-rouge><pre class=highlight><code>epubcfi(/6/36!/4/2/16/5,:25,:27)
</code></pre></div><p>のようなちょっと目を疑う読みにくさの記法なのでずっと敬遠してきたのだが、ちょうど今回の「EPUBパッチ」のような時に使えるかと、数か月前に重い腰を上げて実装したのだった。</p><p>正確にはパッチで終わるのでなく、差分アップデートをやってみたいと思っている。対象もEPUBじゃなくてDOMにしたい、つまりウェブページも対象にしたい。ただ、まずは（要素の省略などが許されているHTMLでなく）必ずXHTMLを使うことになっているEPUBからと思っているし、EPUBでこれができると、Kindleのようなプラットフォームで、本につけたハイライトやメモ書きを保持したまま本の内容をアップデートできるはずだ。電子書籍のいいところに、配信側が気軽にアップデートできることがあるが、そのたびにメモ書きが消えてしまうのは避けたい。また、まんがなんか特にそうだが、不要な所も含めた本全体をアップデートしていると転送料ももったいないしユーザーも長く待たされる。差分アップデートならこれが避けられる。</p><p>そんな思惑で実装していたCFIの機能が、今回役に立った。Gistにあるスクリプトの</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="no">ERRATA</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span><span class="ss">target: </span><span class="s1">'/6/36!/4/2/16/5,:25,:27'</span><span class="p">,</span> <span class="ss">operation: :replace</span><span class="p">,</span> <span class="ss">replace: </span><span class="s1">'ri'</span><span class="p">},</span>
  <span class="p">{</span><span class="ss">target: </span><span class="s1">'/6/36!/4/2/18/7,:33,:35'</span><span class="p">,</span> <span class="ss">operation: :replace</span><span class="p">,</span> <span class="ss">replace: </span><span class="s1">'ri'</span><span class="p">},</span>
  <span class="p">{</span><span class="ss">target: </span><span class="s1">'/6/46!/4/2/70/6/1,:0,:4'</span><span class="p">,</span> <span class="ss">operation: :replace</span><span class="p">,</span> <span class="ss">replace: </span><span class="s1">'send'</span><span class="p">},</span>
  <span class="p">{</span><span class="ss">target: </span><span class="s1">'/6/52!/4/2/28/1,:61,:62'</span><span class="p">,</span> <span class="ss">operation: :remove</span><span class="p">},</span>
  <span class="p">{</span><span class="ss">target: </span><span class="s1">'/6/68!/4/2/44/1:267'</span><span class="p">,</span> <span class="ss">operation: :add</span><span class="p">,</span> <span class="ss">add: </span><span class="s1">'が'</span><span class="p">},</span>
  <span class="p">{</span><span class="ss">target: </span><span class="s1">'/6/98!/4/2/12/9:7'</span><span class="p">,</span> <span class="ss">operation: :add</span><span class="p">,</span> <span class="ss">add: </span><span class="s1">'*10'</span><span class="p">},</span>
  <span class="p">{</span><span class="ss">target: </span><span class="s1">'/6/118!/4/2/50/3,:45,:46'</span><span class="p">,</span> <span class="ss">operation: :remove</span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div><p>という定数で使っている。<code class=highlighter-rouge>target</code>プロパティのところがそれだ。</p><p>カンマで区切られているやつが「範囲」で、区切られていないのが「一点」を表す。削除や差し替えは「どこを」という情報が必要だから範囲を使っているし、文字の追加は不要なので一点を使っている。</p><p>このCFI、おもしろい特徴があって、CFI同士、順番をつけることができるのだ。まあ、（始めから終わりまで一次元に続く）本の一点や範囲を示しているんだから、数直線上の点や範囲と同じで、考えてみれば順序が付くのは当たり前なのだが。この順番を、<strong>XHTML文書その物は参照せずに</strong>決められるところがおもしろい。他に何も見ないでも、</p><div class=highlighter-rouge><pre class=highlight><code>epubcfi(/6/36!/4/2/16/5:25)
</code></pre></div><p>と</p><div class=highlighter-rouge><pre class=highlight><code>epubcfi(/6/36!/4/2/18/7:33)
</code></pre></div><p>なら前者（<code class=highlighter-rouge>epubcfi(/6/36!/4/2/16/5:25)</code>）のほうが「先」にあるということが分かる。正誤表適用前に、適用箇所が後ろの方から前の方に並ぶように、正誤表を並び替えているのだが、その時に、この順番の機能を使った（Rubyの<code class=highlighter-rouge>sort_by</code>メソッドのブロックから返している）。なぜ後ろから前なのかと言うと、もし前からやってしまうと、適用の結果DOMツリーの構造が変わって、その後の操作の適用対象がずれてしまうことがあるからだ（DOMのNodeSetの中から複数ノードを消すときなんかと同じ）。</p><p>これは同じくDOMツリー上の場所を示すのによく使われるCSSセレクターやXPathにはない特徴で、パッチ適用箇所の表現に（渋々ながら）EPUB CFIを採用した理由になっている（CSSセレクターやXPathでも一定の制限を掛けてみんな守るようにすれば順番付けはできる）。</p><p>余談だけど、<code class=highlighter-rouge>insert</code>じゃなくて<code class=highlighter-rouge>add</code>、<code class=highlighter-rouge>delete</code>じゃなくて<code class=highlighter-rouge>remove</code>といった用語は<a href="https://tools.ietf.org/html/rfc5261">XML Patch</a>と<a href="https://tools.ietf.org/html/rfc6902">JSON Patch</a>（<a href="http://www.hcn.zaq.ne.jp/___/WEB/RFC6902-ja.html">日本語訳</a>）から拝借した。</p><h3 id=nokogirixmlrange>Nokogiri::XML::Range</h3><p><a href="http://www.rubydoc.info/gems/nokogiri-xml-range">Nokogiri::XML::Range</a>については以前にも書いた（<a href="http://apehuci-kitaitimakoto.sqale.jp/apehuci/?date=20150907">NokogiriでHTML（XML）内の範囲を操作するgem作った</a>）。DOMツリー上の範囲を扱うgemだ。ウェブブラウザーではJavaScript向けのAPIである<a href="https://developer.mozilla.org/ja/docs/Web/API/range">Rangeオブジェクト</a>として見ることができる。</p><p>EPUB CFIで正誤表適用箇所を指定できたとしても、そこに対して操作ができなければまるで意味がない。CFIから<a href="http://www.nokogiri.org/">Nokogiri</a> gemで表現されたDOMツリー上の範囲へ変換し、それに対して追加・削除・差し替えを実施するのにNokogiri::XML::Rangeを使っている（長さ0の範囲に対する操作として、追加にも範囲を使っている）。</p><p>こう使っている。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="n">range</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">XML</span><span class="o">::</span><span class="no">Range</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"CPUB CFIから変換した「始点」と「終点」の情報"</span><span class="p">)</span>

<span class="c1">## 追加操作 ##</span>
<span class="c1"># rangeは追加するべき場所を示している</span>
<span class="n">text_to_insert</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">XML</span><span class="o">::</span><span class="no">Text</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"追加する文字列"</span><span class="p">,</span> <span class="s2">"ドキュメントオブジェクト"</span><span class="p">)</span>
<span class="n">range</span><span class="p">.</span><span class="nf">insert_node</span> <span class="n">text_to_insert</span>

<span class="c1">## 削除操作 ##</span>
<span class="c1"># rangeは削除するべき範囲（「をを」の「を」一つとか）を示している</span>
<span class="n">range</span><span class="p">.</span><span class="nf">delete_contents</span>

<span class="c1">## 差し替え操作 ##</span>
<span class="c1"># rangeは差し替えるべき範囲（誤字「wirte」の「ir」とか）を示している</span>
<span class="n">range</span><span class="p">.</span><span class="nf">delete_contents</span>
<span class="n">text_to_replace</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">XML</span><span class="o">::</span><span class="no">Text</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"差し替え後の文字列"</span><span class="p">,</span> <span class="s2">"ドキュメントオブジェクト"</span><span class="p">)</span>
<span class="n">range</span><span class="p">.</span><span class="nf">insert_node</span> <span class="n">text_to_replace</span>
</code></pre></div><p><code class=highlighter-rouge>delete_contents</code>や<code class=highlighter-rouge>insert_contents</code>がやっていることは実装すると結構めんどうなのだけど、きちんと仕様の存在する挙動なので、gemに切り出しておけば安心して使える。</p><p>これも正に「差分アップデートやるなら必要になるはずだな」と思って作ったgemなので、狙い通りに役立って嬉しい。</p><h3 id=epub-maker>EPUB Maker</h3><p><a href="http://www.rubydoc.info/gems/epub-maker">EPUB Maker</a>は<a href="http://www.rubydoc.info/gems/epub-parser/0.2.4/file/docs/Home.markdown">EPUB Parser</a>の拡張で、その名の通りEPUBを作成するためのgem……というのは表の顔で、これを作った一番の動機はEPUBのインプレース編集にあった（EPUBを作るなら<a href="https://github.com/kmuto/review">Re:VIEW</a>や<a href="https://github.com/skoji/gepub">gepub</a>など他のgemのほうがいいと思う）。</p><p>冒頭でちょっと触れたDocker本のシンタックスハイライトでも使っているが、EPUBファイルの中身を、Nokogiriを使ったDOM操作などで直接書き換えることができる。</p><p><a href="http://www.rubydoc.info/gems/nokogiri-xml-range">Nokogiri::XML::Range</a>で正誤表を適用したあとは、単に<a href="http://www.rubydoc.info/gems/epub-maker">EPUB Maker</a>の保存用メソッドを呼べば、それでEPUBファイルに適用される。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="n">item</span><span class="p">.</span><span class="nf">content</span> <span class="o">=</span> <span class="n">document</span><span class="p">.</span><span class="nf">to_xml</span>
<span class="n">item</span><span class="p">.</span><span class="nf">save</span>
</code></pre></div><p>べんり。</p><p>こうして、兼ねてから用意しておいたgemの組み合わせで、今回のパッチプログラムは比較的すんなり書くことができた。気持ちがいい（とは言え、今回の本に特化した方法ならもっとずっと簡単に書ける。<code class=highlighter-rouge>unzip</code>、<code class=highlighter-rouge>zip</code>、<code class=highlighter-rouge>sed</code>くらいで充分だ。明らかにオーバーエンジニアリング）。</p><p>今回足りなくて自分で書かないといけなかった汎用パーツは「EPUB CFIからNokgiri::XML::Rangeに変換する」という処理だったので、これは一般化して<a href="http://www.rubydoc.info/gems/epub-parser/0.2.4/file/docs/Home.markdown">EPUB Parser</a>に入れておきたい。</p><h2 id=epub>EPUBパッチの試み</h2><p>こうして、ある程度アドホックに、ある程度一般的にEPUBのパッチプログラムを書いてみた。書いてみて一番大変だったのは、正誤表のEPUB CFIを作るところだった。</p><p>本の中から、適用対象のXHTMLファイルを探して、その中の適用箇所を探すまでは簡単だ（<code class=highlighter-rouge>grep</code>などでできる）。でもその場所を表現するための要素の順番などを数えるのが面倒くさい。そして間違える。</p><p>あと、複数の操作を一つのプログラムで行うときの順番の扱いは、色んなケースを集めて検討する必要があると感じた。今回は正誤表を逆順に並べて適用していったけど、前の方から順番でも、そうと決まっていれば別にいい。ある処理でDOM構造が変わるとしても、「ずれた」後のDOMツリーに対してその後の操作のCFIが書かれていればいいからだ。</p><p>もう少し引いた視点で、パッチの適用対象のバージョンや順番も、取り決めを作ってみんなに周知する必要があると感じた。今回のパッチプログラムの後に正誤表が追加されたとする。すると、</p><ul><li>gihyo.jpからダウンロードしたファイルには、今回分と追加分がまとまったパッチを適用したい</li><li>今回のパッチを適用して楽しんでいたファイルには、追加分だけ適用したい</li></ul><p>ということになる。この辺、「二つをまとめたパッチ」を作るかどうか、作るにはどういう手順で作るか、それとも必ず一つずつ順番に適用することにするか（「久し振りに開いた本」は、「パッチの適用待ち」の時間が非常に長くなるかも知れない）、決めないといけない。</p><p>また、サードパーティ製のパッチについても検討できると素晴らしい。識者による注釈や、出版社を通さない作者によるコメンタリーなど（小説へのコメンタリーは、吉野茉莉さんがやっていた）用意して配布できるといい。そうした物は「どのバージョンのパッチ適用後なら適用していいか」「それより後のパッチも適用した後だった場合、どうしたらいいのか」といった難しい検討が必要になる。</p><p>差分アップデートも同様だけど、「（本文を参照しない）CFIだけでの演算」でいろいろ解決できると便利なのだけど、そういったことはできるのだろうか……（というか、これができるかどうか見てみたいので差分アップデートをやりたいのだ）。</p><h2 id=epub-cfi>EPUB CFIについて思うこと</h2><p>EPUB CFI、あまり好きではないのだけど、今回のようなことをやるには、順番が付くという性質が役に立った。</p><p>今回分かった難点というか、改善点になるのかな、は、『APIデザインケーススタディ』では（XHTMLの）<code class=highlighter-rouge>id</code>属性を全然使っていないこともあって、ぱっと見、どのトピックに対する操作なのか全然分からない（<code class=highlighter-rouge>id</code>がある場合はその値がCFIに現れる仕様になっている）。<code class=highlighter-rouge>id</code>に限らず、<code class=highlighter-rouge>class</code>など色んな属性についてもCFI表現に出せるようになってるといいのかなあ。乱用される危険も出るが。</p><h2 id=section>差分アップデートの仕組みに足りていない物</h2><p>今回一番大変だったこととしてCFIの作成を挙げたが、そこが、差分アップデートの仕組みに足りていない。</p><p>（iBooks Authorなど）オーサリングツールで何か操作をして保存したりアイコンをタップすると、自動でパッチを書き出すようになっているとすごく便利だが、僕にはGUIは理解が追い付かない……。</p><p>別の方法としてEPUB用の<code class=highlighter-rouge>diff</code>コマンドを作るというのがある、と言うか、目指している。旧EPUB、新EPUBを並べて差分を計算し、パッチの形で書き出してくれるツールだ。これでネックになるのはDOMツリーの差分計算だ。調べたところ「NP困難」と呼ばれる類の問題らしく、一般的に解決するのは非常に難しいらしい。でも、DOMの差分が作れると、ウェブ開発者一般にもとても役立つと思うので、何か、妥当でうまく利く制約があるといい。アルゴリズムとしてはBULDアルゴリズムというのが速いらしい。C++の実装はあるけれど、僕には敷居が高いので、これのポーティングを目的として今Goを勉強している（速い言語がいい）。仮想DOM方面から何か出てきたりしないかな。</p><h2 id=section-1>終わりに</h2><p>なんだか、実現できているのは小さなことだし、書いているコードは少ないのに、長く話してしまった。お恥ずかしい。</p><p>最後に大事なことを一つ、たださんと同じく声を大にしてこう言いたい。</p><blockquote><p>ともあれ、<strong>こんなことができるのも、ちゃんと正誤表を公表してくれる著者と、DRMをかけない素のEPUBファイルを配信してくれる出版社があればこそ</strong>。感謝したい。</p></blockquote><h2 id=section-2>追記</h2><p>なんか間違えてた。上で何度か「差分アップデートをやりたい」と言っているが、差分アップデートは、正に今回やったこれだ（パッチ作成の部分は今は人間がやってるのでそこは将来の話ではある）。やりたいけど遠いのは、「EPUBの差分アップデート時に、ブックマークやハイライト、メモ書きなども同時にアップデートする（EPUBアップデートによって場所が動いても追従する）」ということだった。</p></paper-card></article><article><paper-card elevation=2><a href="../../2015/12/30.html"><h1>『RESTful Webサービス』でRailsを覚える</h1><time pubdate>2015-12-30</time></a><ul class=tags><li><a href="../../tags/.html" rel=tag>ウェブアプリケーション</a></li><li><a href="../../tags/ruby-on-rails.html" rel=tag>Ruby on Rails</a></li></ul><p>今日はちょっと思い出話でも。</p><p><a href="https://sapporoonga.doorkeeper.jp/events/36441">Groongaもくもく会＠札幌 2015-12-30</a>に参加して来た。帰札した翌日から熱を出して寝込んでいたのだが、直前で治って本当によかった。</p><p>もくもく会では<a href="https://github.com/droonga/droonga-http-server/blob/master/install.sh">Droonga HTTP Serverのインストールスクリプト</a>の修正を試みていた。進捗はこんな感じ：<a href="https://github.com/droonga/droonga-http-server/compare/master...KitaitiMakoto:centos-systemd">https://github.com/droonga/droonga-http-server/compare/master…KitaitiMakoto:centos-systemd</a></p><p>その後は<a href="https://atnd.org/events/73363">忘年会＠Sinatra札幌＆Sapporoonga 2015-12-30</a>。そこで話題になった一つに、Railsの躓きポイントの話があった。既にうろ覚えだがこんな感じだったと思う。</p><p>ウェブアプリケーションを作ったことがない状態でRailsに入門すると、どこで何が起こっているか分からない。scaffoldしてアプリケーションが動くようにはできる。でも何がどうなっているか分からない。その後Sinatraをちょっと勉強して、</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
<span class="c1"># ...</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/entries'</span> <span class="k">do</span>
<span class="c1"># ...</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/entries/1'</span> <span class="k">do</span>
<span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div><p>みたいなのに触れてみて初めて、「Railsはroutesをまず見るべきなんだ」と分かった、という話。そこから、Rails（のようなフルスタックのフレームワーク）に触れる前に、ウェブの基本的な仕組みを学ぶべきだ、という話になった。その場には<a href="https://www.djangoproject.com/">Django</a>をやっている人もいて、やり始めはやはり同じような分からなさを感じていたらしい。</p><p>僕は、自分のRailsの覚え方は普通ではないし人に勧めるような物ではないと感じていたのだけど、この話を聞いていると意外とよかったのかも知れないと思えてきた。僕がRailsを覚えたのは、Railsの本でも勉強会でもなくて（当時はプログラミングの話をする相手すらいなかった）、『<a href="http://www.oreilly.co.jp/books/9784873113531/">RESTful Webサービス</a>』だった（今はPDF版もあるようだ）。</p><div class=booklog_html><table><tr><td class=booklog_html_image><a href="http://www.amazon.co.jp/RESTful-Web%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9-Leonard-Richardson/dp/4873113539%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4873113539" target=_blank><img src="http://ecx.images-amazon.com/images/I/51Su2Ger2sL._SL160_.jpg" width=116 height=150 style="border:0;border-radius:0;"/></a></td><td class=booklog_html_info style="padding-left:20px;"><div class=booklog_html_title style="margin-bottom:10px;font-size:14px;font-weight:bold;"><a href="http://www.amazon.co.jp/RESTful-Web%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9-Leonard-Richardson/dp/4873113539%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4873113539" target=_blank>RESTful Webサービス</a></div><div style="margin-bottom:10px;"><div class=booklog_html_author style="margin-bottom:15px;font-size:12px;;line-height:1.2em">著者 : <a href="http://booklog.jp/author/Leonard+Richardson" target=_blank>Leonard Richardson</a></div><div class=booklog_html_manufacturer style="margin-bottom:5px;font-size:12px;;line-height:1.2em">オライリー・ジャパン</div><div class=booklog_html_release style="font-size:12px;;line-height:1.2em">発売日 : 2007-12-21</div></div><div class=booklog_html_link_amazon><a href="http://booklog.jp/item/1/4873113539" style="font-size:12px;" target=_blank>ブクログでレビューを見る»</a></div></td></tr></table></div><p>この本は、勿論Railsの入門書ではない。書名の通り、RESTful Webサービスの解説書だ。前半で、ウェブとは何か、HTTPとは、URIとは、アドレス可能性とは、<abbr title="Representational State Transfer">REST</abbr>とは、といった基礎的な考え方と、実例として、Google Mapsのような地図サービスのサーバーサイドのリソース設計が紹介される。今実家にいて手元に実物が無いので記憶頼りだが（こういう時電子本だったら……）、どういうXMLにするべきか（当時はWeb APIはXMLを返すのが普通だった。そしてWeb APIでなくWebサービスと呼ばれていた）、どういうURIにするべきか、地図の拡大・縮小はURIとしてどのように表現するといいか、といったことが紹介される。</p><p>そうしてみっちりと理論的なことを叩きこまれた後で後半、ようやくサンプルウェブアプリケーションとして、<a href="https://delicious.com/">del.icio.us</a>クローンのブックマークサービスを作ることになる。この時に採用されたフレームワークが、<a href="http://rubyonrails.org/">Ruby on Rails</a>だったのだ。Railsのバージョンは2で、ようやくRESTfulルーティングが入ったような頃だったと思う。Rackはまだ入っていなかった。</p><p>僕はこれを読みながら、HTTPメソッドとRailsのアクション名との対応表を何度も見返しながら、サンプルアプリケーションを写経することでRailsを覚えていった（Railsアプリケーションの作り方の簡単な解説もあった）。上で言っていた「ウェブアプリケーションの基本的な仕組み」を散々解説された後でRailsに触れることになったし、しかもこの本の順番だとURI設計をし、<code class=highlighter-rouge>config/routes.rb</code>に反映させて確認してからようやくコントローラーやモデルの実装に入った。期しないで、上で挙げた落とし穴に嵌らなかったわけだ。</p><p><a href="http://guides.rubyonrails.org/">Rails Guides</a>（<a href="http://railsguides.jp/">日本語</a>）や<a href="https://www.railstutorial.org/">Rails Tutorial</a>（<a href="http://railstutorial.jp/">日本語</a>）、またはRails用の本を使ったわけではないので、正当な覚え方ではないのだろうと思っていた（その後Railsの本も何冊か読んではいる）し、何より人に勧めるような覚え方ではないと感じていたのだが、意外とそうでもないのかも知れない。しかし、この本は多少古い（XML、del.icio.us、Rails 2……）ので、やっぱり人には勧めにくい。そこで、『<a href="https://gihyo.jp/dp/ebook/2014/978-4-7741-7074-9">Webを支える技術</a>』の実践編という位置付けで、Railsを使ったハンズオンチュートリアルを書いてみるのはどうだろう。</p><div class=booklog_html><table><tr><td class=booklog_html_image><a href="http://www.amazon.co.jp/Web%E3%82%92%E6%94%AF%E3%81%88%E3%82%8B%E6%8A%80%E8%A1%93-HTTP%E3%80%81URI%E3%80%81HTML%E3%80%81%E3%81%9D%E3%81%97%E3%81%A6REST-WEB-PRESS-plus/dp/4774142042%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4774142042" target=_blank><img src="http://ecx.images-amazon.com/images/I/51qo6pgjaSL._SL160_.jpg" width=107 height=150 style="border:0;border-radius:0;"/></a></td><td class=booklog_html_info style="padding-left:20px;"><div class=booklog_html_title style="margin-bottom:10px;font-size:14px;font-weight:bold;"><a href="http://www.amazon.co.jp/Web%E3%82%92%E6%94%AF%E3%81%88%E3%82%8B%E6%8A%80%E8%A1%93-HTTP%E3%80%81URI%E3%80%81HTML%E3%80%81%E3%81%9D%E3%81%97%E3%81%A6REST-WEB-PRESS-plus/dp/4774142042%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4774142042" target=_blank>Webを支える技術 -HTTP、URI、HTML、そしてREST (WEB+DB PRESS plus)</a></div><div style="margin-bottom:10px;"><div class=booklog_html_author style="margin-bottom:15px;font-size:12px;;line-height:1.2em">著者 : <a href="http://booklog.jp/author/%E5%B1%B1%E6%9C%AC%E9%99%BD%E5%B9%B3" target=_blank>山本陽平</a></div><div class=booklog_html_manufacturer style="margin-bottom:5px;font-size:12px;;line-height:1.2em">技術評論社</div><div class=booklog_html_release style="font-size:12px;;line-height:1.2em">発売日 : 2010-04-08</div></div><div class=booklog_html_link_amazon><a href="http://booklog.jp/item/1/4774142042" style="font-size:12px;" target=_blank>ブクログでレビューを見る»</a></div></td></tr></table></div><p>そこまでいかなくても、いきなりRailsで手を動かすのではなくて、先にこの本を読んでおくことにするのはどうだろう。</p><p>なお、当たり前の断りとして、適した覚え方は人それぞれだ。特に、人は自分の習得方法がいい物だと思いがちなので、そういったバイアスもある。何より僕は今のRails 4、5は殆ど触っていないので、今でも通用する考え方かは分からない。</p></paper-card></article><footer><ul><li class=next><a href="../13/" rel=next><paper-button raised>前3日分</paper-button></a></li><li class=prev><a href="../15/" rel=prev><paper-button raised>次3日分</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></app-header-layout></main><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>