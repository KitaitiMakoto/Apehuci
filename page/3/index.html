<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta name=description content="北市真の日記"><meta content="width=device-width,initial-scale=1.0" name=viewport><title>アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:description content="北市真の日記"><meta name=og:title content="アペフチ"><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"><meta name=robots content="noindex,follow"></head><body class="page page_3 page_3_index"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed condenses effects=waterfall slot=header><app-toolbar></app-toolbar><app-toolbar sticky><h1 class=site-title><a href="../../">アペフチ</a></h1></app-toolbar></app-header><article><paper-card elevation=2><a href="../../2016/12/11.html"><h1>Polymerを2.0 Previewに上げた</h1><time pubdate>2016-12-11</time></a><ul class=tags><li><a href="../../tags/polymer.html" rel=tag>Polymer</a></li><li><a href="../../tags/web.html" rel=tag>Webコンポーネント</a></li></ul><p>この日記では<a href="https://www.polymer-project.org/">Polymer</a>を使っているのだけど、1.xから<a href="https://www.polymer-project.org/2.0/docs/about_20">2.0</a> Previewに上げた。その時にやったことやはまったことなど。</p><h2 id=section>目次</h2><ol><li><a href="#heading-2016-12-11-assumption">前提</a><ol><li><a href="#heading-2016-12-11-references">参考ドキュメント</a></li></ol></li><li><a href="#heading-2016-12-11-upgrading-libraries">ライブラリーのアップグレード</a><ol><li><a href="#heading-2016-12-11-upgrading-paper-elements">Paper Elements</a></li></ol></li><li><a href="#heading-2016-12-11-modifying-existing-code">コードの修正</a><ol><li><a href="#heading-2016-12-11-changing-file-webcomponentsjs">webcomponentsjsなど</a></li><li><a href="#heading-2016-12-11-upgrading-paper-header-panel">paper-header-panel</a></li><li><a href="#heading-2016-12-11-removing-is-from-dom-module">dom-module</a></li><li><a href="#heading-2016-12-11-styling-dynamic-inserted-elements">動的に挿入される要素のスタイリング</a></li><li><a href="#heading-2016-12-11-fixing-paper-card-paper-button-error">paper-cardとpaper-buttonのエラー</a></li></ol></li></ol><h2 id=heading-2016-12-11-assumption>前提</h2><p>まず、Polymerを使っていると言うけど、<a href="http://webcomponents.org/">Webコンポーネント</a>用ライブラリー（フレームワーク）としての他、Googleが提唱するUIデザインであるマテリアルデザイン用のコンポーネント（<a href="https://elements.polymer-project.org/browse?package=paper-elements">Paper Elements</a>）なども使っていた。そのうち<a href="https://elements.polymer-project.org/elements/paper-card">Paper Card</a>ではまったりしたのでまずここで断っておく。</p><p>また、自分で作ったコンポーネントは一つだけで、フッターに置いてある検索ボックス用の<code class=highlighter-rouge>blog-search</code>という要素のみ。これの書き換えについても触れる。</p><h3 id=heading-2016-12-11-references>参考ドキュメント</h3><dl><dt><a href="https://www.polymer-project.org/2.0/docs/about_20">https://www.polymer-project.org/2.0/docs/about_20</a></dt><dd>Polymer 2.0になって変わったことの概要。</dd><dt><a href="https://www.polymer-project.org/2.0/docs/upgrade">https://www.polymer-project.org/2.0/docs/upgrade</a></dt><dd>Polymer 1.xから2.0へアップグレードする時のガイド。</dd><dt><a href="https://codelabs.developers.google.com/codelabs/polymer-2-carousel/">https://codelabs.developers.google.com/codelabs/polymer-2-carousel/</a></dt><dd>Polymer 2.0でコンポーネントを作るチュートリアル。</dd></dl><h2 id=heading-2016-12-11-upgrading-libraries>ライブラリーのアップグレード</h2><p><a href="https://github.com/KitaitiMakoto/apehuci/commit/8bd0c722cdeea984948ee4ebc89f5a3dfd5c74ca">https://github.com/KitaitiMakoto/apehuci/commit/8bd0c722cdeea984948ee4ebc89f5a3dfd5c74ca</a></p><h3 id=heading-2016-12-11-upgrading-paper-elements>Paper Elements</h3><p><a href="https://www.polymer-project.org/2.0/docs/about_20#installing">概要ページのインストールの項目</a>にあるように、Polymerは</p><div class="language-shell highlighter-rouge"><pre class=highlight><code>bower install --save Polymer/polymer#2.0-preview
</code></pre></div><p>でアップグレードできる。 この時に選択肢が出てくるが、Polymerは2.0、webcomponentsjsは1.0を選んでおけばよい。</p><p>各コンポーネントをインストールするにも同様に、各コンポーネントの<code class=highlighter-rouge>2.0-preview</code>ブランチをインストールすればいい。これまでは<code class=highlighter-rouge>paper-elements</code>という全体をまとめたコンポーネントがあって、それをインストールするだけで全Paper Elementがインストールできたのだけど、なぜか<code class=highlighter-rouge>2.0-preview</code>ブランチはないので、自分が使っている物を個別にインストール必要があった。めんどくさい（イシューは上がってる、と思ったのだけど、今探したら無いな、幻か知ら）。</p><p>あと、</p><div class="language-shell highlighter-rouge"><pre class=highlight><code>bower install --save paper-input#2.0-preview
</code></pre></div><p>みたいに、既存の物を<code class=highlighter-rouge>2.0-preview</code>にアップグレードすればいいコンポーネントと、</p><div class="language-shell highlighter-rouge"><pre class=highlight><code>bower install --save PaperElements/paper-card#2.0-preview
</code></pre></div><p>みたいに、GitHubのオーガニゼーションも明示しないといけないコンポーネントがある。<a href="https://github.com/Polymer/paper-card">Polymer/paper-card</a>を見てみて、<code class=highlighter-rouge>2.0-preview</code>ブランチがなければ<a href="https://github.com/PolymerElements/paper-card">PolymerElements/paper-card</a>を見る、ということをしなくてはならず、これもめんどくさい。</p><h3 id=heading-2016-12-11-changing-file-webcomponentsjs>webcomponentsjsなど</h3><p>webcomponentsjsなどは、パッケージその物はPolymerアップグレードの時に一緒に自動でアップグレードされるのだけど、Polymerが使うファイルが変わっていることがある。例えば<code class=highlighter-rouge>webcomponents.min.js</code>というファイルを使っていたのが<code class=highlighter-rouge>webcomponents-lite.js</code>に変わっていたりするので、コンソールのエラーメッセージを見ながら参照先を変えていく。</p><h2 id=heading-2016-12-11-modifying-existing-code>コードの修正</h2><p>アップグレードに伴って、いくつか既存のコードを修正する必要があった。大体は<a href="https://www.polymer-project.org/2.0/docs/upgrade">アップグレードガイド</a>に従えばいいが、幾つか嵌った所。</p><h3 id=heading-2016-12-11-upgrading-paper-header-panel>paper-header-panel</h3><p>コンポーネントをアップグレードしたら画面が真っ白になってしまった。</p><p>この日記の大部分は<a href="https://elements.polymer-project.org/elements/paper-header-panel">paper-header-panel</a>の中に入っているのだけど、これの使い方が変わっていて、そのせいだった。子要素を配置するための<a href="https://www.polymer-project.org/2.0/docs/upgrade#replace-content-elements">slot</a>（従来はcontent）に<code class=highlighter-rouge>name</code>属性で名前が付くようになって、ユーザー（＝僕）が配置する子要素にも、対応する名前を付けておかなければいけなくなっていた。一応、<code class=highlighter-rouge>paper-header-panel</code>のソースコードコメントにはそのことが書いてある： <a href="https://github.com/PolymerElements/paper-header-panel/blob/226e265f151dfd229c68780626342dd2b6295f6f/paper-header-panel.html#L32-L37">paper-header-panel.html#L32-L37</a></p><p>これに合わせてテンプレートを修正した（<code class=highlighter-rouge>slot</code>属性を足しているのに注目）：</p><p>Before：</p><div class="language-html highlighter-rouge"><pre class=highlight><code><span class="nt">&lt;paper-header-panel</span> <span class="na">mode=</span><span class="s">waterfall-tall</span><span class="nt">&gt;</span>
  <span class="nt">&lt;paper-toolbar&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;/paper-toolbar&gt;</span>
  <span class="nt">&lt;main&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;/main&gt;</span>
  <span class="nt">&lt;footer&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;/footer&gt;</span>
<span class="nt">&lt;/paper-header-panel&gt;</span>
</code></pre></div><p>After：</p><div class="language-html highlighter-rouge"><pre class=highlight><code><span class="nt">&lt;paper-header-panel</span> <span class="na">mode=</span><span class="s">waterfall-tall</span><span class="nt">&gt;</span>
  <span class="nt">&lt;paper-toolbar</span> <span class="na">slot=</span><span class="s">header</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;/paper-toolbar&gt;</span>
  <span class="nt">&lt;main</span> <span class="na">slot=</span><span class="s">content</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;/main&gt;</span>
  <span class="nt">&lt;footer</span> <span class="na">slot=</span><span class="s">content</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;/footer&gt;</span>
<span class="nt">&lt;/paper-header-panel&gt;</span>
</code></pre></div><h3 id=heading-2016-12-11-removing-is-from-dom-module>dom-module</h3><p>カスタム要素を定義するのに使う<a href="https://www.polymer-project.org/1.0/docs/devguide/local-dom#template-stamping">dom-module</a>という要素（メタ要素？）をPolymerは提供している。カスタム要素の定義は本来JavaScriptでやるのだけど、<code class=highlighter-rouge>dom-module</code>を使うとHTMLを使ってある程度宣言的にできて、僕はこのアプローチを気に入っている。</p><p>自分で作ったカスタム要素である<code class=highlighter-rouge>blog-search</code>はこの<code class=highlighter-rouge>dom-module</code>で定義しているのだけど、その時に、<code class=highlighter-rouge>dom-module</code>に<code class=highlighter-rouge>is</code>属性を付けていた。</p><div class="language-html highlighter-rouge"><pre class=highlight><code><span class="nt">&lt;dom-module</span> <span class="na">is=</span><span class="s">blog-search</span> <span class="na">id=</span><span class="s">blog-search</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;/dom-module&gt;</span>
</code></pre></div><p><code class=highlighter-rouge>is</code>というのは、その要素（ここでは<code class=highlighter-rouge>dom-module</code>）を更に拡張したバージョンの要素を使う、という時に使う物で、例えばオートコンプリート機能を追加した検索インプットを作って</p><div class="language-html highlighter-rouge"><pre class=highlight><code><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">search</span> <span class="na">is=</span><span class="s">auto-complete</span><span class="nt">&gt;</span>
</code></pre></div><p>などとして使う（ちなみにブラウザーベンダー間で要不要の意見が割れているらしいので、この仕様はなくなるかも）。</p><p><code class=highlighter-rouge>dom-module</code>を使う時には<code class=highlighter-rouge>is</code>属性は不要なので、ここでは使い方が間違っているのだけど、問題なく動いていた。単に無視されていたのだろうと思う。2.0 Previewに上げても同様に動いていたのだけど、Chromeで全く動かない（<code class=highlighter-rouge>blog-search</code>の定義自体が失敗している）ことに気が付いた。<code class=highlighter-rouge>is</code>を外すと動いたので、ChromeがネイティブでWebコンポーネントに対応しているのと関係していそうだが調べていない（他のブラウザーでは、現在のところ、Webコンポーネントの多くの機能がpolyfillやshimで動いている）。</p><h4 id=section-1>追記</h4><p><code class=highlighter-rouge>is</code>は、Polymer 1.xの頃には必要（正確には<code class=highlighter-rouge>name</code>または<code class=highlighter-rouge>is</code>が必要）だったので、<code class=highlighter-rouge>is</code>を使っていたのは正しかった。単に、2.0にする時に外し、<code class=highlighter-rouge>id</code>を付与する必要がるということだった。</p><h3 id=heading-2016-12-11-styling-dynamic-inserted-elements>動的に挿入される要素のスタイリング</h3><p>この日記の検索機能では、<code class=highlighter-rouge>XMLHttpRequest</code>で<a href="http://groonga.org/ja/docs/reference/executables/groonga-httpd.html">groonga-httpd</a> （NginxのGroongaモジュール）から検索結果を取得し、DOMツリー内に挿入している（参考：<a href="../02/07.html">日記に検索機能をつけた</a>）。Groongaが検索キーワードに<code class=highlighter-rouge>keyword</code>というクラスを付けてくれるので、赤い太字になるようスタイリングしていた。</p><div class="language-css highlighter-rouge"><pre class=highlight><code><span class="nc">.keyword</span> <span class="p">{</span>
  <span class="nl">color</span><span class="p">:</span> <span class="no">red</span><span class="p">;</span>
  <span class="nl">font-weight</span><span class="p">:</span> <span class="nb">bolder</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>Chromeでスタイリングされなくなった。これは、ChromeがShadow DOMを実装していて、Polymerもそのネイティブ実装を活かしている、つまり外部でのスタイル宣言がShadow DOM内に影響を及ぼしていないからだと思う。Webコンポーネントの大きな特長がこのカプセル化なのでむしろ歓迎すべき変更。というわけで、喜んで、Shadow DOMに閉じたスタイリングに変更した。</p><div class="language-html highlighter-rouge"><pre class=highlight><code><span class="nt">&lt;dom-module</span> <span class="na">id=</span><span class="s">blog-search</span><span class="nt">&gt;</span>
  <span class="nt">&lt;template&gt;</span>
    <span class="nt">&lt;style&gt;</span>
      <span class="c">/* ... */</span>

      <span class="nc">.keyword</span> <span class="p">{</span>
        <span class="nl">color</span><span class="p">:</span> <span class="n">var</span><span class="p">(</span><span class="n">--keyword-color</span><span class="p">,</span> <span class="no">red</span><span class="p">);</span>
        <span class="nl">font-weight</span><span class="p">:</span> <span class="n">var</span><span class="p">(</span><span class="n">--keyword-font-weight</span><span class="p">,</span> <span class="nb">bolder</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>
  <span class="nt">&lt;/template&gt;</span>
  <span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;/dom-module&gt;</span>
</code></pre></div><p>すると、今度はFirefoxでスタイルが外れてしまった。</p><p>FirefoxではShadow DOMが実装されておらずshimを使っている。具体的にはHTMLの<code class=highlighter-rouge>style</code>要素に、Shadow DOM内に閉じているのとある程度同等のスタイル宣言をして、それを持ってスコープ付きのスタイリングとしている。</p><div class="language-html highlighter-rouge"><pre class=highlight><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
    <span class="nt">&lt;style&gt;</span>
      <span class="c">/* ... */</span>

      <span class="nc">.keyword.blog-search</span> <span class="p">{</span>
        <span class="nl">color</span><span class="p">:</span> <span class="n">var</span><span class="p">(</span><span class="n">--keyword-color</span><span class="p">,</span> <span class="no">red</span><span class="p">);</span>
        <span class="nl">font-weight</span><span class="p">:</span> <span class="n">var</span><span class="p">(</span><span class="n">--keyword-font-weight</span><span class="p">,</span> <span class="nb">bolder</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
</code></pre></div><p>このスタイル宣言を活かすために行われるのが、「要素名と同じクラスを追加する」という処理だ。</p><div class="language-html highlighter-rouge"><pre class=highlight><code> <span class="nt">&lt;blog-search&gt;</span>
  <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;paper-input</span> <span class="err">...</span> <span class="na">class=</span><span class="s">"style-scope blog-search"</span> <span class="err">...</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;/paper-input&gt;</span>
  <span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;/blog-search&gt;</span>
</code></pre></div><p>（<code class=highlighter-rouge>class</code>に<code class=highlighter-rouge>blog-search</code>が追加されている）</p><p>元々HTML内に書かれているタグであれば、このようにPolymerが自動でクラスを追加してくれるのだが、検索結果のように、動的に挿入される要素ではそうはいかない。仕方がないので、挿入する時に自分でクラスを追加するようにした。</p><div class="language-javascript highlighter-rouge"><pre class=highlight><code><span class="c1">// ...</span>
<span class="nl">snippetHtml</span><span class="p">:</span> <span class="nx">article</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">"&lt;br&gt;"</span><span class="p">).</span>
  <span class="nx">replace</span><span class="p">(</span><span class="s1">'&lt;span class="keyword"&gt;'</span><span class="p">,</span> <span class="s1">'&lt;span class="keyword style-scope blog-search"&gt;'</span><span class="p">),</span>
<span class="c1">// ...</span>
</code></pre></div><p>文字列処理なので乱暴だが、この場合はセキュリティホールにはならない（はず）。</p><p>「Firefoxはカスタムプロパティには対応しているんだからそっち使ってくれればいいんだけどなあ」とちょっと釈然としないが、まあ、過渡期ということで仕方ないのだろう。</p><h3 id=heading-2016-12-11-fixing-paper-card-paper-button-error>paper-cardとpaper-buttonのエラー</h3><p><code class=highlighter-rouge>paper-card</code>と<code class=highlighter-rouge>paper-button</code>が（例によって）Chromeでだけ動かない。</p><blockquote><p>Uncaught DOMException: Failed to construct 'CustomElement': The result must not have attributes</p></blockquote><p>というエラーが出てしまっている。</p><p>ググるとStack Overflowがヒットして（<a href="http://stackoverflow.com/questions/40181683/failed-to-execute-createelement-on-document-the-result-must-not-have-childr">Failed to execute 'createElement' on 'Document': The result must not have children</a>）、見ると<code class=highlighter-rouge>created</code>（新しくは<code class=highlighter-rouge>constructor</code>）コールバックの使い方が、新しいCustom Elements仕様としては不正なようだ。しようがないのでフォークしてここを<code class=highlighter-rouge>ready</code>コールバックに書き換えて対応とした。イシューも上げた（<a href="https://github.com/PolymerElements/paper-card/issues/90">2.0-preview throw an error Uncaught DOMException: Failed to construct 'CustomElement': The result must not have attributes #90</a>）。</p><p><code class=highlighter-rouge>ready</code>はCustom Elements標準にはなく、Polymer独自のコールバック。1.xの時代から存在していて、2.0でも残るようなので（<a href="https://www.polymer-project.org/2.0/docs/about_20#lifecycle-changes">Lifecycle changes</a>）、<code class=highlighter-rouge>blog-search</code>でも使っていたがそのままにしてある。</p><h4 id=section-2>追記</h4><p>これは<code class=highlighter-rouge>paper-card</code>や<code class=highlighter-rouge>paper-button</code>ではなく、<a href="https://github.com/Polymer/vulcanize">vulcanize</a>の問題だということが分かった（<a href="https://github.com/PolymerElements/paper-card/issues/90">PolymerElements/paper-card/issues/90</a>）。どうもJavaScriptのclass構文で定義した物ををvulcanizeがうまく扱えないということみたい。なので2.0でclass構文使う際には注意されたい。</p><hr/><p>こんなところかな。あとは公式の<a href="https://www.polymer-project.org/2.0/docs/upgrade">アップグレードガイド</a>に従えばいいことばかりだった。</p><p>コミットログを見るとコードレベルで何をやっているかが分かると思う： <a href="https://github.com/KitaitiMakoto/apehuci/commits/master">https://github.com/KitaitiMakoto/apehuci/commits/master</a></p></paper-card></article><article><paper-card elevation=2><a href="../../2016/12/02.html"><h1>アドカレ #コルクおすすめ2016 二日目 おすすめファンタジーまんが五選</h1><time pubdate>2016-12-02</time></a><ul class=tags><li><a href="../../tags/.html" rel=tag>ファンタジー</a></li><li><a href="../../tags/.html" rel=tag>まんが</a></li></ul><p>これはアドベントカレンダー「<a href="http://www.adventar.org/calendars/1885">年末年始おすすめ作品　BY.CORK Advent Calendar 2016</a>」の二日目です。</p><p>本当は二日目の僕が書く必要はないと思うのですが、初日がまさかのツイッター投稿（<a href="https://twitter.com/boogie_go/status/804517137784008704">https://twitter.com/boogie_go/status/804517137784008704</a>）だったので、「アドベントカレンダーとは何か」ということも一緒にご説明しますね。</p><h2 id=section>アドベントカレンダーとは</h2><p>アドベントカレンダーは、元々は、クリスマスまでの日数を数える日めくり（？）カレンダーだそうです（参考：<a href="https://ja.wikipedia.org/wiki/%E3%82%A2%E3%83%89%E3%83%99%E3%83%B3%E3%83%88%E3%82%AB%E3%83%AC%E3%83%B3%E3%83%80%E3%83%BC">ウィキペディア</a>）。</p><p>ただ、ここでのアドベントカレンダーは日本の（主にウェブ・スマホアプリの）エンジニアの慣習を指していて、「12月1日からスタートし、クリスマスまで、ある話題を決めて、それについて持ち回りでブログ記事などを書いていく」という物です。一箇所に色んなサービスや会社の知見が集まるので読む側としては毎日楽しみだし、後から見ても、一通り情報が手に入るので便利です。</p><p>これを、僕が所属する<a href="https://corkagency.com/">コルク</a>で、（技術情報でなく）おすすめ作品でやろう、ということになりました。経緯を把握していないんだけど、たぶん、「コルクはクリエイターのエージェンシーだが、ITにも力を入れている（入れていきたい）」というところからIT業界のノウハウとか取り入れようとしているので、そこからの派生なのかな。内輪褒めになっちゃうけど、みんな僕よりもずっと色々な物を見ているし、さすが編集担当なんかはそれを言語化するのもうまいので、僕自身が楽しみ。</p><p>僕の担当分「おすすめファンタジーまんが五選」は次の通り。</p><h2 id=section-1>諸星大二郎「妖怪ハンター」シリーズ</h2><div class=booklog_html><table><tr><td class=booklog_html_image><a href="https://www.amazon.co.jp/%E5%A6%96%E6%80%AA%E3%83%8F%E3%83%B3%E3%82%BF%E3%83%BC-%E5%9C%B0%E3%81%AE%E5%B7%BB-%E9%9B%86%E8%8B%B1%E7%A4%BE%E6%96%87%E5%BA%AB-%E8%AB%B8%E6%98%9F-%E5%A4%A7%E4%BA%8C%E9%83%8E/dp/4086183900%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4086183900" target=_blank><img src="http://ecx.images-amazon.com/images/I/51TmXXBItiL._SL160_.jpg" width=104 height=150 style="border:0;border-radius:0;"/></a></td><td class=booklog_html_info style="padding-left:20px;"><div class=booklog_html_title style="margin-bottom:10px;font-size:14px;font-weight:bold;"><a href="https://www.amazon.co.jp/%E5%A6%96%E6%80%AA%E3%83%8F%E3%83%B3%E3%82%BF%E3%83%BC-%E5%9C%B0%E3%81%AE%E5%B7%BB-%E9%9B%86%E8%8B%B1%E7%A4%BE%E6%96%87%E5%BA%AB-%E8%AB%B8%E6%98%9F-%E5%A4%A7%E4%BA%8C%E9%83%8E/dp/4086183900%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4086183900" target=_blank>妖怪ハンター 地の巻 (集英社文庫)</a></div><div style="margin-bottom:10px;"><div class=booklog_html_author style="margin-bottom:15px;font-size:12px;;line-height:1.2em">著者 : <a href="http://booklog.jp/author/%E8%AB%B8%E6%98%9F%E5%A4%A7%E4%BA%8C%E9%83%8E" target=_blank>諸星大二郎</a></div><div class=booklog_html_manufacturer style="margin-bottom:5px;font-size:12px;;line-height:1.2em">集英社</div><div class=booklog_html_release style="font-size:12px;;line-height:1.2em">発売日 : 2005-11-18</div></div><div class=booklog_html_link_amazon><a href="http://booklog.jp/item/1/4086183900" style="font-size:12px;" target=_blank>ブクログでレビューを見る»</a></div></td></tr></table></div><p>考古学者とされる稗田礼二郎が、フィールドワークで訪れた先々で、色々な怪異を体験するという話。シリーズ名に「ハンター」が含まれていますが、特にハントはしません。</p><p>怪異の元となっているのが宗教。舞台が日本ではあるのですが、特に土地土地の信仰を重視しているところが面白い。「神道はこういう宗教で、こういう神様がいて……」「仏教のこの宗派はこういう教えなので……」みたいなことは焦点ではなく、その上で、「この土地では古来の巨石への信仰と仏教がこう結び付いて……」など「生きた信仰」を描き出し、その可視化として、化け物が出てきます。（そして倒さず、去るのを待ちます……。）</p><p>それまでは大体ライトファンタジー、それも異世界ファンタジーばかり読んでいたので、ファンタジー観が変わりました。と同時に、宗教や信仰というのは、本来（？）小さなコミュニティの物であって、現代でも適応して形を変えていく物なんだ、と、世界観まで変わる体験でした。諸星大二郎を読んでから、神社を巡るのが楽しくなりました。</p><h2 id=section-2>五十嵐大介『はなしっぱなし』</h2><div class=booklog_html><table><tr><td class=booklog_html_image><a href="https://www.amazon.co.jp/%E3%81%AF%E3%81%AA%E3%81%97%E3%81%A3%E3%81%B1%E3%81%AA%E3%81%97-%E4%B8%8A-%E4%B9%9D%E9%BE%8DCOMICS-%E4%BA%94%E5%8D%81%E5%B5%90-%E5%A4%A7%E4%BB%8B/dp/4309728405%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4309728405" target=_blank><img src="http://ecx.images-amazon.com/images/I/419DCGKFDZL._SL160_.jpg" width=104 height=150 style="border:0;border-radius:0;"/></a></td><td class=booklog_html_info style="padding-left:20px;"><div class=booklog_html_title style="margin-bottom:10px;font-size:14px;font-weight:bold;"><a href="https://www.amazon.co.jp/%E3%81%AF%E3%81%AA%E3%81%97%E3%81%A3%E3%81%B1%E3%81%AA%E3%81%97-%E4%B8%8A-%E4%B9%9D%E9%BE%8DCOMICS-%E4%BA%94%E5%8D%81%E5%B5%90-%E5%A4%A7%E4%BB%8B/dp/4309728405%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4309728405" target=_blank>はなしっぱなし 上 (九龍COMICS)</a></div><div style="margin-bottom:10px;"><div class=booklog_html_author style="margin-bottom:15px;font-size:12px;;line-height:1.2em">著者 : <a href="http://booklog.jp/author/%E4%BA%94%E5%8D%81%E5%B5%90%E5%A4%A7%E4%BB%8B" target=_blank>五十嵐大介</a></div><div class=booklog_html_manufacturer style="margin-bottom:5px;font-size:12px;;line-height:1.2em">河出書房新社</div><div class=booklog_html_release style="font-size:12px;;line-height:1.2em">発売日 : 2004-02-18</div></div><div class=booklog_html_link_amazon><a href="http://booklog.jp/item/1/4309728405" style="font-size:12px;" target=_blank>ブクログでレビューを見る»</a></div></td></tr></table></div><p>これも現代の日本を舞台にしたファンタジーですが（いわゆる現代ファンタジーとは違う）、よりライトと言うか、「事件」ではなくて、日常的な「気が付かないけれど起こっていること」というのを描いています。話に山や谷があまりないのですが、そのファンタジー世界に浸ることができる短編集です。</p><p>五十嵐大介は、読むと感性の一部を譲り受けることができるような作家で、読んだ後しばらくは日常の見方が変わる、本当に彼が見ているように見える気分になるようなパワーを持った人だと思います。理屈先行の僕はその減退が割と早いので、一時期は毎日『はなしっぱなし』を読んでファンタジー的感覚を補充していました。</p><h2 id=section-3>ニール ゲイマン「サンドマン」シリーズ</h2><div class=booklog_html><table><tr><td class=booklog_html_image><a href="https://www.amazon.co.jp/%E3%82%B5%E3%83%B3%E3%83%89%E3%83%9E%E3%83%B3-1-DC-COMICS-VERTIGO/dp/4924914061%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4924914061" target=_blank><img src="http://ecx.images-amazon.com/images/I/51KMRRKBRYL._SL160_.jpg" width=97 height=150 style="border:0;border-radius:0;"/></a></td><td class=booklog_html_info style="padding-left:20px;"><div class=booklog_html_title style="margin-bottom:10px;font-size:14px;font-weight:bold;"><a href="https://www.amazon.co.jp/%E3%82%B5%E3%83%B3%E3%83%89%E3%83%9E%E3%83%B3-1-DC-COMICS-VERTIGO/dp/4924914061%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4924914061" target=_blank>サンドマン (1) (DC COMICS VERTIGO)</a></div><div style="margin-bottom:10px;"><div class=booklog_html_author style="margin-bottom:15px;font-size:12px;;line-height:1.2em">著者 : <a href="http://booklog.jp/author/%E3%83%8B%E3%83%BC%E3%83%AB%E3%83%BB%E3%82%B2%E3%82%A4%E3%83%9E%E3%83%B3" target=_blank>ニール・ゲイマン</a></div><div class=booklog_html_manufacturer style="margin-bottom:5px;font-size:12px;;line-height:1.2em">インターブックス</div><div class=booklog_html_release style="font-size:12px;;line-height:1.2em">発売日 : 1998-04-08</div></div><div class=booklog_html_link_amazon><a href="http://booklog.jp/item/1/4924914061" style="font-size:12px;" target=_blank>ブクログでレビューを見る»</a></div></td></tr></table></div><p>どう紹介したものか……。</p><p>主人公は「<a href="https://ja.wikipedia.org/wiki/%E3%82%B6%E3%83%B3%E3%83%88%E3%83%9E%E3%83%B3">サンドマン</a>」「モルフェウス」などの呼び名を持つ超常の存在ドリーム。文字通り夢（そして眠り）を司る存在で、宇宙の始まりから存在し、人間が滅んでも（夢を見る知性体がいる限り）あり続ける存在です（同様の存在が他にも何人がいて、その一つ、ドリームの姉であるデス（もちろん、死を司る）とは仲がいいのが読んでいて感じられます）。例えば、物語の冒頭で、魔術師に彼が捕えられてしまうのですが、そうすると世界の眠りがめちゃくちゃになり、ある人は永久に夢を見続けることに、また別の人は眠ることができなくなったりしてしまうほどで、本当に夢その物なのです。</p><p>まんがはその彼のアドベンチャーを描いた物。始め二巻は捕えられてから出るまでと、捉えられている間に奪われてしまった三つのアイテムを見付け出すまで。次の二巻は、「渦」と呼ぶ、夢に関するおかしな現象が、アメリカのある少女を中心に（というか、彼女が渦その物となって）国中を巻き込む規模で起こり、その解決まで。第五巻は完全に独立した短編集で、猫が夢を見る話などがある。そして、六巻以降は、残念ながら邦訳されていない。</p><p>上手く感想を言葉にできないのだけど、伏線の扱いが上手とかも技術的な点もありますが、とにかくその発想と、夢に対する解釈の深さに圧倒されっぱなしのまんがでした。</p><h2 id=section-4>萱島雄太『西遊少女』</h2><div class=booklog_html><table><tr><td class=booklog_html_image><a href="http://p.booklog.jp/book/54478" target=_blank><img src="http://img.p.booklog.jp/393D6F56-DC31-11E1-B1E1-2928058D85C2_m.gif" width=105 height=150 style="border:0;border-radius:0;"/></a></td><td class=booklog_html_info style="padding-left:20px;"><div class=booklog_html_title style="margin-bottom:10px;font-size:14px;font-weight:bold;"><a href="http://p.booklog.jp/book/54478" target=_blank>西遊少女 #01 -無料サンプル号-</a></div><div style="margin-bottom:10px;"><div class=booklog_html_author style="margin-bottom:15px;font-size:12px;;line-height:1.2em">著者 : <a href="http://booklog.jp/author/%E8%90%B1%E5%B3%B6%E9%9B%84%E5%A4%AA" target=_blank>萱島雄太</a></div><div class=booklog_html_manufacturer style="margin-bottom:5px;font-size:12px;;line-height:1.2em">パブー</div><div class=booklog_html_release style="font-size:12px;;line-height:1.2em">発売日 : 2012-08-02</div></div><div class=booklog_html_link_amazon><a href="http://booklog.jp/item/3/54478" style="font-size:12px;" target=_blank>ブクログでレビューを見る»</a></div></td></tr></table></div><p>[disclosure]僕はかつて、『西遊少女』が連載されていたパブーの開発をしていました。</p><p>有名な『西遊記』をモチーフに、少女になった三蔵、沙悟浄、八戒、悟空が天竺を目指す……向かう話。主人公の三蔵はそもそも天竺に行きたくなくて、何とか離脱しようとするところを他の連中が頑張って連れ戻すスラップスティックです。<a href="http://p.booklog.jp/">パブー</a>では非公開になっており、<a href="http://mavo.takekuma.jp/title.php?title=67">電脳マヴォ</a>で公開されています。</p><p>当時（2012年）としては非常に珍しい、ウェブの縦スクロールを意識した、というか、その特徴を使ってのびのびと遊んでいるまんが。</p><p>単に「スクロールを活かす」というのだと「あーはいはい『実験的』まんがね、はいはい」となりがちだと思うんですが、『西遊少女』はお話自体が面白いので、そういう「技術に偏った奴らが何かやってる」というネガティブイメージを生まないという意味でもおすすめです。パブーの頃は第九話で連載がストップしてしまったのですが、マヴォでは最後まで描かれるんだろうか……。</p><h2 id=section-5>曽田正人『テンプリズム』</h2><div class=booklog_html><table><tr><td class=booklog_html_image><a href="https://www.amazon.co.jp/%E3%83%86%E3%83%B3%E3%83%97%E3%83%AA%E3%82%BA%E3%83%A0-1-%E3%83%93%E3%83%83%E3%82%B0%E3%82%B3%E3%83%9F%E3%83%83%E3%82%AF%E3%82%B9-%E6%9B%BD%E7%94%B0-%E6%AD%A3%E4%BA%BA/dp/4091864104%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4091864104" target=_blank><img src="http://ecx.images-amazon.com/images/I/61u7E-vwJHL._SL160_.jpg" width=105 height=150 style="border:0;border-radius:0;"/></a></td><td class=booklog_html_info style="padding-left:20px;"><div class=booklog_html_title style="margin-bottom:10px;font-size:14px;font-weight:bold;"><a href="https://www.amazon.co.jp/%E3%83%86%E3%83%B3%E3%83%97%E3%83%AA%E3%82%BA%E3%83%A0-1-%E3%83%93%E3%83%83%E3%82%B0%E3%82%B3%E3%83%9F%E3%83%83%E3%82%AF%E3%82%B9-%E6%9B%BD%E7%94%B0-%E6%AD%A3%E4%BA%BA/dp/4091864104%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4091864104" target=_blank>テンプリズム 1 (ビッグコミックス)</a></div><div style="margin-bottom:10px;"><div class=booklog_html_author style="margin-bottom:15px;font-size:12px;;line-height:1.2em">著者 : <a href="http://booklog.jp/author/%E6%9B%BD%E7%94%B0%E6%AD%A3%E4%BA%BA" target=_blank>曽田正人</a></div><div class=booklog_html_manufacturer style="margin-bottom:5px;font-size:12px;;line-height:1.2em">小学館</div><div class=booklog_html_release style="font-size:12px;;line-height:1.2em">発売日 : 2014-08-29</div></div><div class=booklog_html_link_amazon><a href="http://booklog.jp/item/1/4091864104" style="font-size:12px;" target=_blank>ブクログでレビューを見る»</a></div></td></tr></table></div><p>[disclosure]僕は現在、『テンプリズム』の編集を担当しているコルクに所属しています。</p><p>曽田正人初めての異世界ファンタジー。伝説の力を有するツナシが、魔力と呼ばれる力を持ち、どんどん国を拡大して世界を侵略していっている<ruby>骨<rt>グゥ</rt></ruby>の国と戦う物語。</p><p>曽田正人と言えば僕は『昴』から入り、それ以外の作品も読んでいった、という流れなのですが、どれも共通するのは、主人公が天才であること。特に、自分の力で成長することのできる天才。ファンタジーになってもそれは健在なのですが、変わったのが天才性が目に見えるようになったことです。</p><p>作中で「オロメテオールの力」と呼ばれるその力はツナシの眼に宿り、自分の意図ではその発動を制御できない。思わぬ時にその力が使えたり、望んだ時に使えなかったりする。こう書くと分かりやすいですが、結構、これまでの主人公の天才性と似ていますね。そして、ここが、さすが曽田正人という感じなんですが、「目に見える」「名前がある」という、「自分の外にある物である」と認識する条件が満たされているので、天才 vs 天才性という軸で主人公を眺める楽しみも出てきています。その上で、「それでも自分なのだし、責任を引き受ける」という決断を描くまでの成長があるところが、ファンタジーにして生まれた曽田正人の新しさだと感じました。</p></paper-card></article><article><paper-card elevation=2><a href="../../2016/09/12.html"><h1>Intersection Observerによるモバイル用スクロールスパイ</h1><time pubdate>2016-09-12</time></a><ul class=tags><li><a href="../../tags/javascript.html" rel=tag>JavaScript</a></li><li><a href="../../tags/css.html" rel=tag>CSS</a></li></ul><p><a href="https://jxck.io/">Jxck</a>さんによる<a href="https://blog.jxck.io/entries/2016-06-25/intersection-observer.html">Intersection Observer を用いた要素出現検出の最適化</a>という記事を読んで、Intersection Observerを使ってみたくなった。そこで、これを使ってモバイル用のスクロールスパイを実装してみた：<a href="https://kitaitimakoto.github.io/scrollspy-example/">Scrollspy example</a>（iOS以外のFirefoxが一番綺麗に動く。次点でSafari。）</p><h2 id=intersection-observer>Intersection Observer</h2><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API">Intersection Observer</a>を使うと<code class=highlighter-rouge>scroll</code>イベントの監視が不要になるケースがあり、その際に動作が軽快になるというのが主なメリットで、ユースケースとしてはデータや（画像などの）リソースの遅延読み込みが想定されているようだ。<code class=highlighter-rouge>img</code>要素が画面に入ってくる直前のタイミングで画像読み込みを開始する、という用途だ。</p><p>ところが<code class=highlighter-rouge>scroll</code>イベントの出番は他にもあり、最近出くわしたのが画面上部固定のナビゲーションとスクロールスパイだった。</p><h2 id=section>固定ナビゲーション</h2><p>固定のナビゲーションというのは、 この言い方だったら「<code class=highlighter-rouge>position: fixed</code>使えば？」という感じだが、</p><ul><li>最初はナビゲーションが普通にスクロールで移動するようになっている</li><li>スクロールによってナビゲーションが画面最上部に来たら、その位置で固定する</li></ul><p>という物で、「ナビゲーションが画面最上部に到達しているかどうか」を判定するのに、<code class=highlighter-rouge>scroll</code>イベントを監視しなくてはならない。これについてはIntersection Observerではなく、<a href="https://github.com/WICG/EventListenerOptions/blob/gh-pages/explainer.md">Passive Event Listener</a>の出番なのだが（これもJxckさんの記事<a href="https://blog.jxck.io/entries/2016-06-09/passive-event-listeners.html">Passive Event Listeners によるスクロールの改善</a>が素晴らしい）、今回はブラウザーを絞って、CSSの<code class=highlighter-rouge>position: sticky</code>で解決した（参考：<a href="http://unformedbuilding.com/articles/css-position-sticky/">素敵な position: sticky; Unformed Building</a>）。</p><h2 id=section-1>スクロールスパイ</h2><p>残ったスクロールスパイを、Intersection Observerで実装してみた。それもモバイル用にしてみた。</p><p>別にモバイルに絞らなくても、Intersection Observerによるスクロールスパイの実装というのは妥当な選択ではあるのだが、別所で「モバイルでもスクロールスパイのようなナビゲーションが欲しい」という話をしていたこともあって、その解決策の例示と併せた。</p><p>モバイルでスクロールスパイがあまり見られないのは、やはり「常時サイドバーなどでナビゲーションを表示する」というのが、画面の狭い環境では受け入れ難いから。ただ、一般にヘッダーとフッターくらいは常時表示が許容されているので、ここをスクロールスパイに使ってしまおうというのがアイディアだった。スクロールスパイの目的は</p><ul><li>全体のナビゲーションを表示すること</li><li>その中で現在位置を示すこと</li></ul><p>だが、後者に特にフォーカスして、「現在位置が変わる度に表示を切り替えて、その場所の名前にする」という方法をとった。前者については、タップするとナビゲーションの全メニューを表示することで解決とした。</p><p>あと、巷のスクロールスパイでは、現在位置が変わった時に</p><ol><li>一旦ナビゲーション中の全部を「選択されていない」状態にする</li><li>その後、現在位置に対応するメニューだけを「選択」状態にする</li></ol><p>となっているのが多いのだが、Intersection Observerによって注目すべき対象が絞れるので、不要なループを削れたのも嬉しい。</p><h2 id=firefoxcss>FirefoxのCSS対応</h2><p>スムーススクロールやカスタムプロパティ、<code class=highlighter-rouge>position: sticky;</code>、<code class=highlighter-rouge>text-decoration-style</code>など、Firefoxが、意外と色々なCSSの機能に対応していて驚いた。</p><p>特にスムーススクロールはお気に入りで、JavaScriptでスムーススクロールを実装する場合には、自動で<code class=highlighter-rouge>location</code>のフラグメント部が変わらないし、何より<code class=highlighter-rouge>:target</code>擬似クラスの対象が変わらない。その点、ブラウザーネイティブのスムーススクロールなら<code class=highlighter-rouge>:target</code>を使ったスタイリングもできるので非常にいい（今回は使わなかったが）。</p><p>最後に、改めてリンクを：</p><ul><li><a href="https://kitaitimakoto.github.io/scrollspy-example/">Scrollspy example</a></li><li><a href="https://github.com/KitaitiMakoto/scrollspy-example">KitaitiMakoto/scrollspy-example</a></li></ul></paper-card></article><footer><ul><li class=next><a href="../2/" rel=next><paper-button raised>前3日分</paper-button></a></li><li class=prev><a href="../4/" rel=prev><paper-button raised>次3日分</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></app-header-layout></main><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>