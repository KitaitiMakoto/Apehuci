<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>[Action Cable][Ruby][Ruby on Rails]Action Cableが便利そう | アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:title content="[Action Cable][Ruby][Ruby on Rails]Action Cableが便利そうAction Cableが便利そう"><meta name=twitter:description content="とても久し振りにSendagaya.rbに参加して来た。 第128回の今日は、三十分くらい雑談した後、QiitaのAction Cableの記事[Rails5]Action Cableのサンプルを読み解いてみるを読みながらああだこうだ言っていた。一通り見ての感想は「便利そう」「使いたい」。 Action CableはRails 5から入るらしい新機能で、Web..."><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"></head><body class="x2015 x2015_11 x2015_11_30"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed shadow slot=header><app-toolbar><h2 class=site-title><a href="../../"> アペフチ <paper-ripple></paper-ripple></a></h2></app-toolbar></app-header><article><header><paper-card><h1>Action Cableが便利そう</h1><time pubdate>2015-11-30</time><ul class=tags><li><a href="../../tags/action-cable.html" rel=tag>Action Cable</a></li><li><a href="../../tags/ruby.html" rel=tag>Ruby</a></li><li><a href="../../tags/ruby-on-rails.html" rel=tag>Ruby on Rails</a></li></ul></paper-card></header><paper-card><p>とても久し振りに<a href="https://sendagayarb.doorkeeper.jp/">Sendagaya.rb</a>に参加して来た。</p><p><a href="https://sendagayarb.doorkeeper.jp/events/35276">第128回</a>の今日は、三十分くらい雑談した後、QiitaのAction Cableの記事<a href="http://qiita.com/bisque33/items/1360477c2260b361ec03">[Rails5]Action Cableのサンプルを読み解いてみる</a>を読みながらああだこうだ言っていた。一通り見ての感想は「便利そう」「使いたい」。</p><p><a href="https://github.com/rails/actioncable">Action Cable</a>はRails 5から入るらしい新機能で、WebSocketをRailsに統合した形で扱える物らしい。まともに記事など読んだのは今日が初めてで、これがRais界隈でどれくらい認知されているかは分からない。僕が「RailsでWebSocket」と聞いて漠然と思い浮かべたのが<code class=highlighter-rouge>ActionController::Live</code>だったのだけど全然違う（<code class=highlighter-rouge>ActionController::Live</code>については<a href="http://tenderlovemaking.com/2012/07/30/is-it-live.html">Is It Live?</a>がよい紹介記事だ）。</p><p>Action Cableでは、Railsのプロセスの他にAction Cable用のプロセスを立ち上げる。こいつがブラウザーとWebSocketで通信する。普通だ。Action Cableのいい所はここからで、Railsとセッション用のクッキー情報を共有できる（電子署名が付いているあれだ）。だから、WebSocketを使ってAction Cableに接続してきたクライアントが、Rails（のデータベース）で管理しているどのユーザーに相当するのか、見付けることができるのだ。</p><p>更に、Railsのプロセスからブラウザーに、WebSocket経由でメッセージを送ることができる。例えば、フォームなどから普通にコメントを投稿した時に、そのことをWebSocketで繋がっている全ユーザーに通知できる。だがRailsがWebSocketを使ってAction Cableに接続しているわけではない。Active Jobを使ってRedisにメッセージを送信するのだ。Action CableはRedisのpubsub機能を使っていて、Rails（Active Job実装のワーカープロセス）がパブリッシャー、Action Cableプロセスがサブスクライバーになっている。Action Cableはサブスクライブしたメッセージを、予めAction Cable用に書かれたコードに従って、必要なクライアントに流す。もちろん、クライアント同士WebSocket経由での通信もできる。（そう言えば、はて、クライアントからDBのレコードを弄るような場合、Action Cableプロセスがやるのだろうか、Railsプロセスがやるのだろうか。後者はフォームなりAjaxなりでやることが自然に思い浮かべられるが、前者は逆方向のpubsubになる？　と考えると、そういうことはなさそうだなと思う。）</p><div class=highlighter-rouge><pre class=highlight><code>Rails --(Active Job)--&gt; Worker --(Redis pubsub)--&gt; Cable --(WebSocket)--&gt; Clients
</code></pre></div><p>副産物として、始めからRedisのpubsubでWebSocketサーバーをつなぐのが前提なので、プロセスを増やすだけで簡単にスケールアウトさせられそうだ。これは悪いことではない、というかむしろいいことだが、Railsはモノリシックなのが特徴の一つという印象を持っていたので、結構変わり種のコンポーネントだな、と感じた。繰り返すが悪いことではない。</p><p>と、便利なところだったが、実は半分くらいは推測で書いている。件の記事の内容からは内部の動きは分からないからだ。だから今度はAction Cableのソースコードを読みたいと思っているし、もしかしたら次回のSendagaya.rbでソースコードリーディングができるかも知れない。</p><p>余談。「RailsからRedisにパブリッシュするためにはSidekiqなどが必要で、更に別のプロセスを立てないといけない」といった話をしている時に、<a href="https://twitter.com/tkawa">@tkawa</a>さんに<a href="https://github.com/brandonhilkert/sucker_punch">Sucker Punch</a>を教えてもらった。Railsプロセス内にCelluloidを使ってアクタースレッドを立て、それを使ってActive Jobのジョブを実行する物のようだ。ぱっと見本番で使っていいかは不安に思ったが、開発環境で使う分には便利だろう。</p></paper-card><footer><ul><li class=next><a href="../12/03.html" rel=next><paper-button raised>Firefox for AndroidでもPolymerが動作するようにする</paper-button></a></li><li class=prev><a href="29.html" rel=prev><paper-button raised>Rubyでプラグインを作れる分散全文検索エンジンDroonga</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></article></app-header-layout></main><script defer async src="//hypothes.is/embed.js"></script><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>