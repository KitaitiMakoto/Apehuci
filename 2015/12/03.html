<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>[Webコンポーネント][Polymer]Firefox for AndroidでもPolymerが動作するようにする | アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:title content="[Webコンポーネント][Polymer]Firefox for AndroidでもPolymerが動作するようにするFirefox for AndroidでもPolymerが動作するようにする"><meta name=twitter:description content="この日記はPolymer 1.2.1で作っているのだが、この前まで僕のメインブラウザーであるFirefox for Androidでは読めなかった。今でもPolymer Element Catalogのサイトを見るとそれが体験できる。Firefox for PCでは問題ない。Firefox for iOSは知らない。 webcomponentsjsやPolym..."><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"></head><body class="x2015 x2015_12 x2015_12_03"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed shadow slot=header><app-toolbar><h2 class=site-title><a href="../../"> アペフチ <paper-ripple></paper-ripple></a></h2></app-toolbar></app-header><article><header><paper-card><h1>Firefox for AndroidでもPolymerが動作するようにする</h1><time pubdate>2015-12-03</time><ul class=tags><li><a href="../../tags/web.html" rel=tag>Webコンポーネント</a></li><li><a href="../../tags/polymer.html" rel=tag>Polymer</a></li></ul></paper-card></header><paper-card><p>この日記は<a href="https://www.polymer-project.org/">Polymer</a> 1.2.1で作っているのだが、この前まで僕のメインブラウザーであるFirefox for Androidでは読めなかった。今でも<a href="https://elements.polymer-project.org/">Polymer Element Catalog</a>のサイトを見るとそれが体験できる。Firefox for PCでは問題ない。Firefox for iOSは知らない。</p><p><a href="http://webcomponents.org/polyfills/">webcomponentsjs</a>やPolymerに<code class=highlighter-rouge>console.log()</code>を仕込みながらプリントデバッグを頑張って原因を突き止めたところ、webcomponentsjsでの<a href="http://www.w3.org/TR/html-imports/">HTMLインポート</a>の検出に問題があることが分かった。現時点でのwebcomponentsjsでは、ブラウザーにHTMLインポートの機能があるかどうかを、<code class=highlighter-rouge>link</code>要素の（JavaScriptの）オブジェクトに<code class=highlighter-rouge>import</code>プロパティ（あれば関数）が存在するかどうか、<code class=highlighter-rouge>in</code>演算子で確認してチェックして判断している（<a href="https://github.com/webcomponents/webcomponentsjs/blob/fedfe0210aa853a9531bd976f6d161d585cc22fb/src/HTMLImports/base.js#L28">該当箇所</a>）。HTMLインポートをサポートしていないブラウザー（Firefox for PCなど）では<code class=highlighter-rouge>import</code>プロパティが存在せず、その場合はshimを使う。ところがFirefox for Androidでは、「<code class=highlighter-rouge>link</code>要素に<code class=highlighter-rouge>import</code>プロパティが存在する」「しかしHTMLインポート機能はサポートしていない」ということになっている。<code class=highlighter-rouge>link.import</code>が、<code class=highlighter-rouge>null</code>になっているのだ。たとえ<code class=highlighter-rouge>null</code>であっても、値が存在すれば<code class=highlighter-rouge>in</code>演算子は<code class=highlighter-rouge>true</code>を返す。従ってFirefox for AndroidにはHTMLインポート機能が存在する、とwebcomponentsjsは判断しているわけだ。</p><p>一応、<a href="https://github.com/webcomponents/webcomponentsjs/issues/452">バグレポート</a>はした。プルリクエストはリクエストしなかった。<a href="https://github.com/webcomponents/webcomponentsjs/blob/master/CONTRIBUTING.md">コントリビューションページ</a>によると、コントリビュートするにはライセンスに同意する必要がある。それは構わなかったのだが、同意手続きの過程で住所を入力欄が現れた。それも必須項目として。漠然と不安を覚えてプルリクエストは躊躇ってしまった。</p><p>webcomponentsjsでこの問題が対応されるかは分からない。だから今この日記ではこんなワークアラウンドを入れている。</p><div class="language-javascript highlighter-rouge"><pre class=highlight><code><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">ua</span> <span class="o">=</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ua</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"Android"</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
    <span class="nx">ua</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"Firefox"</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"link"</span><span class="p">).</span><span class="kr">import</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="nx">HTMLLinkElement</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="kr">import</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">})();</span>
</code></pre></div><p>これを、webcomponentsjsをロードする<code class=highlighter-rouge>script</code>タグの<strong>前</strong>に置いている。<code class=highlighter-rouge>if</code>節の条件は<code class=highlighter-rouge>null</code>のチェックだけでよさそうだが、そうするとなぜかChromiumやChromeでページが読めなくなってしまったので、プラットフォームも判断している。なぜ読めなくなったかは調べていない。</p></paper-card><footer><ul><li class=next><a href="05.html" rel=next><paper-button raised>DroongaをインストールするItamaeレシピ</paper-button></a></li><li class=prev><a href="../11/30.html" rel=prev><paper-button raised>Action Cableが便利そう</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></article></app-header-layout></main><script defer async src="//hypothes.is/embed.js"></script><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>