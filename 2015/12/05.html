<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>[Droonga][Itamae]DroongaをインストールするItamaeレシピ | アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:title content="[Droonga][Itamae]DroongaをインストールするItamaeレシピDroongaをインストールするItamaeレシピ"><meta name=twitter:description content="今日の日記はGroonga Advent Calendar 2015の五日目です。昨日はcosmo0920さんのGroonga族のHomebrewの変遷を振り返るでした。やっぱりコマンド一つで簡単にインストールできるのはよい。しかし、そのためには陰で誰かが苦労しているということも伺える記事だった。 今日は、Homebrewなどで一発インストールのできないGro..."><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"></head><body class="x2015 x2015_12 x2015_12_05"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed shadow slot=header><app-toolbar><h2 class=site-title><a href="../../"> アペフチ <paper-ripple></paper-ripple></a></h2></app-toolbar></app-header><article><header><paper-card><h1>DroongaをインストールするItamaeレシピ</h1><time pubdate>2015-12-05</time><ul class=tags><li><a href="../../tags/droonga.html" rel=tag>Droonga</a></li><li><a href="../../tags/itamae.html" rel=tag>Itamae</a></li></ul></paper-card></header><paper-card><p>今日の日記は<a href="http://qiita.com/advent-calendar/2015/groonga">Groonga Advent Calendar 2015</a>の五日目です。昨日は<a href="http://qiita.com/cosmo0920">cosmo0920</a>さんの<a href="http://qiita.com/cosmo0920/items/ed7e071d111c533e217c">Groonga族のHomebrewの変遷を振り返る</a>でした。やっぱりコマンド一つで簡単にインストールできるのはよい。しかし、そのためには陰で誰かが苦労しているということも伺える記事だった。</p><p>今日は、Homebrewなどで一発インストールのできないGroonga族の一員、<a href="http://droonga.org/ja/">Droonga</a>のインストールについて書く。</p><p>Groongaにはレプリケーション機能がない。DroongaはGroongaを複数のマシンにレプリケーションさせるプロダクトだ。公式サイトのほか、<a href="http://qiita.com/advent-calendar/2014/groonga">去年のGroonga Advent Calendar</a>にも記事があって、とても面白く読んだ。Droongaが何かということはこれらを見てほしい。</p><p>公式サイトには勿論<a href="http://droonga.org/ja/install/">インストール手順</a>も書かれているのだが、今日時点でこれはうまくいかない。そこで僕は、サーバーの構成管理ツールである<a href="http://itamae.kitchen/">Itamae</a>のレシピを作ってインストールしている。今日はそれを使ったインストール方法を書こうと思う。以下、<a href="https://www.vagrantup.com/">Vagrant</a>を使ってUbuntu 15.04の環境で実行している。マシンイメージは<a href="https://atlas.hashicorp.com/boxes/search?utm_source=vagrantcloud.com&amp;vagrantcloud=1">Vagrant Cloud</a>から<a href="https://atlas.hashicorp.com/ubuntu/boxes/vivid64">公式のイメージ</a>を持って来た。</p><p>Droongaのインストール時にはメモリーが必要なので、<code class=highlighter-rouge>Vagrantfile</code>に設定を書いて2GiBくらい確保しておく。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="ss">:ubuntu1504</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="o">|</span>
    <span class="n">node</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="s2">"ubuntu/vivid64"</span>
    <span class="n">node</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="o">|</span>
      <span class="n">provider</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">2048</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># :</span>
  <span class="c1"># :</span>
<span class="k">end</span>
</code></pre></div><p>バーチャルマシンを起動したら、まずログインして環境を更新する。</p><div class=highlighter-rouge><pre class=highlight><code>[host]$ vagrant up ubuntu1504
[host]$ vagrant ssh ubuntu1504
[vm]$ sudo apt-get update
[vm]$ sudo apt-get upgrade -y
</code></pre></div><p>ここでようやくレシピの登場。GitHubに上げている（<a href="https://github.com/KitaitiMakoto/itamae-plugin-recipe-droonga">https://github.com/KitaitiMakoto/itamae-plugin-recipe-droonga</a>）。gemまたはItamaeプラグインの形をしているがrubygems.orgには上げていないので、<code class=highlighter-rouge>git clone</code>で持って来る必要がある。もっと一般的にしてからリリースしたいなと思って、そのまま時間が過ぎてしまっているのだ……。</p><div class=highlighter-rouge><pre class=highlight><code>[host]$ git clone https://github.com/KitaitiMakoto/itamae-plugin-recipe-droonga.git
</code></pre></div><p>リポジトリーをクローンしたら、Itamaeのレシピファイル（ここでは<code class=highlighter-rouge>recipe.rb</code>）を用意して、以下のように一行書く。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="n">include_recipe</span> <span class="s2">"./itamae-plugin-recipe-droonga
/lib/itamae/plugin/recipe/droonga/default.rb"</span>

</code></pre></div><p>そうしたらItamaeを実行すればよい。簡単だ。但し時間は掛かる。</p><div class=highlighter-rouge><pre class=highlight><code>[host]$ itamae ssh --vagrant --host ubuntu1504 recipe.rb
</code></pre></div><p>（上のイメージだとこれでいいが、DigitalOceanだと依存パッケージが足りなくてうまくいかなかったかも知れない。エラーメッセージを見ながら必要な物をインストールしてほしい。）</p><p>Droongaは二つのコンポーネントからなっている。Groongaデータベースを操作したり、他ノードと連携してレプリケーションを実現する<a href="https://github.com/droonga/droonga-engine">Droonga Engine</a>と、そこへのHTTPインターフェイスを提供する<a href="https://github.com/droonga/droonga-http-server">Droonga HTTP Server</a>だ。それぞれそれ用のプロセスを起動する必要がある。</p><p>公式サイトの記事では<code class=highlighter-rouge>service</code>コマンドを使ってこれをコントロールすることになっているが、Ubuntuでは15.04からUpstartに代わってsystemdが導入されたので、レシピでは<code class=highlighter-rouge>systemctl</code>コマンドを使うようにしている。</p><div class=highlighter-rouge><pre class=highlight><code>[vm]$ sudo systemctl status droong-engine
● droonga-engine.service - Droonga Engine
Loaded: loaded (/lib/systemd/system/droonga-engine.service; enabled; vendor preset: enabled)
Active: active (running) since Fri 2015-12-04 20:09:56 UTC; 37s ago
Main PID: 30190 (droonga-engine)
CGroup: /system.slice/droonga-engine.service
(snip)
[vm]$ sudo systemctl status droonga-http-server
● droonga-http-server.service - Droonga HTTP Server
Loaded: loaded (/lib/systemd/system/droonga-http-server.service; enabled; vendor preset: enabled)
Active: active (running) since Fri 2015-12-04 20:09:57 UTC; 2min 11s ago
Main PID: 30228 (node)
CGroup: /system.slice/droonga-http-server.service
(snip)
</code></pre></div><p>これでDroongaが動くはずだし、実際<a href="http://epub-searcher-demo.kitaitimakoto.net/">EPUB Searcherデモサイト</a>ではこの方法でインストールして、現在でも動作している。</p><p>尚、Droongaを動かすには、内部・外部から、<code class=highlighter-rouge>hostname</code>で返って来るホスト名で名前解決できる必要がある。<code class=highlighter-rouge>hostname</code>と違うホスト名を使いたい場合は、レシピのインストールの箇所（<a href="https://github.com/KitaitiMakoto/itamae-plugin-recipe-droonga/blob/87c7c9015b626a84b14bfa226d399eb02839bd84/lib/itamae/plugin/recipe/droonga/default.rb#L28">Droonga Engine該当箇所</a>、<a href="https://github.com/KitaitiMakoto/itamae-plugin-recipe-droonga/blob/87c7c9015b626a84b14bfa226d399eb02839bd84/lib/itamae/plugin/recipe/droonga/default.rb#L36">Droonga HTTP Server該当箇所</a>）の最後の<code class=highlighter-rouge>bash</code>実行時に<code class=highlighter-rouge>HOST</code>環境を設定し、また<code class=highlighter-rouge>/etc/hosts</code>でも設定する必要があるので書き換えること。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="c1"># :</span>
<span class="c1"># :</span>
<span class="n">execute</span> <span class="s2">"curl -sL https://deb.nodesource.com/setup_0.12 | bash HOST=..."</span> <span class="k">do</span>
  <span class="n">not_if</span> <span class="s2">"test -e /etc/apt/sources.list.d/nodesource.list"</span>
<span class="k">end</span>
<span class="c1"># :</span>
<span class="c1"># :</span>
<span class="n">execute</span> <span class="s2">"curl https://raw.githubusercontent.com/droonga/droonga-engine/master/install.sh | bash HOST=..."</span> <span class="k">do</span>
  <span class="n">not_if</span> <span class="s2">"type droonga-engine"</span>
<span class="k">end</span>
<span class="c1"># :</span>
<span class="c1"># :</span>
</code></pre></div></paper-card><footer><ul><li class=next><a href="18.html" rel=next><paper-button raised>ドリルダウン（ファセット検索）の仕組み</paper-button></a></li><li class=prev><a href="03.html" rel=prev><paper-button raised>Firefox for AndroidでもPolymerが動作するようにする</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></article></app-header-layout></main><script defer async src="//hypothes.is/embed.js"></script><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>