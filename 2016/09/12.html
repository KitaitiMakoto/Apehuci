<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>[JavaScript][CSS]Intersection Observerによるモバイル用スクロールスパイ | アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:title content="[JavaScript][CSS]Intersection Observerによるモバイル用スクロールスパイIntersection Observerによるモバイル用スクロールスパイ"><meta name=twitter:description content="JxckさんによるIntersection Observer を用いた要素出現検出の最適化という記事を読んで、Intersection Observerを使ってみたくなった。そこで、これを使ってモバイル用のスクロールスパイを実装してみた：Scrollspy example（iOS以外のFirefoxが一番綺麗に動く。次点でSafari。） Intersecti..."><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"></head><body class="x2016 x2016_09 x2016_09_12"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed shadow slot=header><app-toolbar><h2 class=site-title><a href="../../"> アペフチ <paper-ripple></paper-ripple></a></h2></app-toolbar></app-header><article><header><paper-card><h1>Intersection Observerによるモバイル用スクロールスパイ</h1><time pubdate>2016-09-12</time><ul class=tags><li><a href="../../tags/javascript.html" rel=tag>JavaScript</a></li><li><a href="../../tags/css.html" rel=tag>CSS</a></li></ul></paper-card></header><paper-card><p><a href="https://jxck.io/">Jxck</a>さんによる<a href="https://blog.jxck.io/entries/2016-06-25/intersection-observer.html">Intersection Observer を用いた要素出現検出の最適化</a>という記事を読んで、Intersection Observerを使ってみたくなった。そこで、これを使ってモバイル用のスクロールスパイを実装してみた：<a href="https://kitaitimakoto.github.io/scrollspy-example/">Scrollspy example</a>（iOS以外のFirefoxが一番綺麗に動く。次点でSafari。）</p><h2 id=intersection-observer>Intersection Observer</h2><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API">Intersection Observer</a>を使うと<code class=highlighter-rouge>scroll</code>イベントの監視が不要になるケースがあり、その際に動作が軽快になるというのが主なメリットで、ユースケースとしてはデータや（画像などの）リソースの遅延読み込みが想定されているようだ。<code class=highlighter-rouge>img</code>要素が画面に入ってくる直前のタイミングで画像読み込みを開始する、という用途だ。</p><p>ところが<code class=highlighter-rouge>scroll</code>イベントの出番は他にもあり、最近出くわしたのが画面上部固定のナビゲーションとスクロールスパイだった。</p><h2 id=section>固定ナビゲーション</h2><p>固定のナビゲーションというのは、 この言い方だったら「<code class=highlighter-rouge>position: fixed</code>使えば？」という感じだが、</p><ul><li>最初はナビゲーションが普通にスクロールで移動するようになっている</li><li>スクロールによってナビゲーションが画面最上部に来たら、その位置で固定する</li></ul><p>という物で、「ナビゲーションが画面最上部に到達しているかどうか」を判定するのに、<code class=highlighter-rouge>scroll</code>イベントを監視しなくてはならない。これについてはIntersection Observerではなく、<a href="https://github.com/WICG/EventListenerOptions/blob/gh-pages/explainer.md">Passive Event Listener</a>の出番なのだが（これもJxckさんの記事<a href="https://blog.jxck.io/entries/2016-06-09/passive-event-listeners.html">Passive Event Listeners によるスクロールの改善</a>が素晴らしい）、今回はブラウザーを絞って、CSSの<code class=highlighter-rouge>position: sticky</code>で解決した（参考：<a href="http://unformedbuilding.com/articles/css-position-sticky/">素敵な position: sticky; Unformed Building</a>）。</p><h2 id=section-1>スクロールスパイ</h2><p>残ったスクロールスパイを、Intersection Observerで実装してみた。それもモバイル用にしてみた。</p><p>別にモバイルに絞らなくても、Intersection Observerによるスクロールスパイの実装というのは妥当な選択ではあるのだが、別所で「モバイルでもスクロールスパイのようなナビゲーションが欲しい」という話をしていたこともあって、その解決策の例示と併せた。</p><p>モバイルでスクロールスパイがあまり見られないのは、やはり「常時サイドバーなどでナビゲーションを表示する」というのが、画面の狭い環境では受け入れ難いから。ただ、一般にヘッダーとフッターくらいは常時表示が許容されているので、ここをスクロールスパイに使ってしまおうというのがアイディアだった。スクロールスパイの目的は</p><ul><li>全体のナビゲーションを表示すること</li><li>その中で現在位置を示すこと</li></ul><p>だが、後者に特にフォーカスして、「現在位置が変わる度に表示を切り替えて、その場所の名前にする」という方法をとった。前者については、タップするとナビゲーションの全メニューを表示することで解決とした。</p><p>あと、巷のスクロールスパイでは、現在位置が変わった時に</p><ol><li>一旦ナビゲーション中の全部を「選択されていない」状態にする</li><li>その後、現在位置に対応するメニューだけを「選択」状態にする</li></ol><p>となっているのが多いのだが、Intersection Observerによって注目すべき対象が絞れるので、不要なループを削れたのも嬉しい。</p><h2 id=firefoxcss>FirefoxのCSS対応</h2><p>スムーススクロールやカスタムプロパティ、<code class=highlighter-rouge>position: sticky;</code>、<code class=highlighter-rouge>text-decoration-style</code>など、Firefoxが、意外と色々なCSSの機能に対応していて驚いた。</p><p>特にスムーススクロールはお気に入りで、JavaScriptでスムーススクロールを実装する場合には、自動で<code class=highlighter-rouge>location</code>のフラグメント部が変わらないし、何より<code class=highlighter-rouge>:target</code>擬似クラスの対象が変わらない。その点、ブラウザーネイティブのスムーススクロールなら<code class=highlighter-rouge>:target</code>を使ったスタイリングもできるので非常にいい（今回は使わなかったが）。</p><p>最後に、改めてリンクを：</p><ul><li><a href="https://kitaitimakoto.github.io/scrollspy-example/">Scrollspy example</a></li><li><a href="https://github.com/KitaitiMakoto/scrollspy-example">KitaitiMakoto/scrollspy-example</a></li></ul></paper-card><footer><ul><li class=next><a href="../12/02.html" rel=next><paper-button raised>アドカレ #コルクおすすめ2016 二日目 おすすめファンタジーまんが五選</paper-button></a></li><li class=prev><a href="../08/26.html" rel=prev><paper-button raised>全文検索とスコアリングの仕組み</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></article></app-header-layout></main><script defer async src="//hypothes.is/embed.js"></script><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>