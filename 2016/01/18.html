<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>[Ruby][Ruby On Rails][Action Cable]Sendagaya.rb #133 | アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:title content="[Ruby][Ruby On Rails][Action Cable]Sendagaya.rb #133Sendagaya.rb #133"><meta name=twitter:description content="Sendagaya.rb #133に行って来た。今日は、前半『メタプログラミングRuby 第2版』を読んで、後半はAction Cableを読んだ。 メタプログラミングRuby 第2版 メタプログラミングRuby 第2版著者 : Paolo Perrottaオライリージャパン発売日 : 2015-10-10ブクログでレビューを見る» fukajunさんが「本を..."><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"></head><body class="x2016 x2016_01 x2016_01_18"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed shadow slot=header><app-toolbar><h2 class=site-title><a href="../../"> アペフチ <paper-ripple></paper-ripple></a></h2></app-toolbar></app-header><article><header><paper-card><h1>Sendagaya.rb #133</h1><time pubdate>2016-01-18</time><ul class=tags><li><a href="../../tags/ruby.html" rel=tag>Ruby</a></li><li><a href="../../tags/ruby-on-rails.html" rel=tag>Ruby On Rails</a></li><li><a href="../../tags/action-cable.html" rel=tag>Action Cable</a></li></ul></paper-card></header><paper-card><p><a href="https://sendagayarb.doorkeeper.jp/events/37324">Sendagaya.rb #133</a>に行って来た。今日は、前半『<a href="https://www.oreilly.co.jp/books/9784873117430/">メタプログラミングRuby 第2版</a>』を読んで、後半は<a href="https://github.com/rails/rails/tree/master/actioncable">Action Cable</a>を読んだ。</p><h2 id=ruby-2>メタプログラミングRuby 第2版</h2><div class=booklog_html><table><tr><td class=booklog_html_image><a href="http://www.amazon.co.jp/%E3%83%A1%E3%82%BF%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0Ruby-%E7%AC%AC2%E7%89%88-Paolo-Perrotta/dp/4873117437%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4873117437" target=_blank><img src="http://ecx.images-amazon.com/images/I/5102wwx0VzL._SL160_.jpg" width=117 height=150 style="border:0;border-radius:0;"/></a></td><td class=booklog_html_info style="padding-left:20px;"><div class=booklog_html_title style="margin-bottom:10px;font-size:14px;font-weight:bold;"><a href="http://www.amazon.co.jp/%E3%83%A1%E3%82%BF%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0Ruby-%E7%AC%AC2%E7%89%88-Paolo-Perrotta/dp/4873117437%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3Dbooklog.jp-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4873117437" target=_blank>メタプログラミングRuby 第2版</a></div><div style="margin-bottom:10px;"><div class=booklog_html_author style="margin-bottom:15px;font-size:12px;;line-height:1.2em">著者 : <a href="http://booklog.jp/author/Paolo+Perrotta" target=_blank>Paolo Perrotta</a></div><div class=booklog_html_manufacturer style="margin-bottom:5px;font-size:12px;;line-height:1.2em">オライリージャパン</div><div class=booklog_html_release style="font-size:12px;;line-height:1.2em">発売日 : 2015-10-10</div></div><div class=booklog_html_link_amazon><a href="http://booklog.jp/item/1/4873117437" style="font-size:12px;" target=_blank>ブクログでレビューを見る»</a></div></td></tr></table></div><p><a href="http://fukajun.org/">fukajun</a>さんが「本を読むってどうやってやるんですかねえ？」って言ったけど誰も答えを持ち合わせていなかった。十五分みんな黙読し、その後気になったことを話すというスタイルになった。範囲は「2章 月曜日：オブジェクトモデル」の始めから「2.2.4 オブジェクトとクラスのまとめ」まで。みんなRubyを書けるので特に問題がなく、字が汚いとか</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="k">module</span> <span class="nn">Rake</span>
  <span class="k">class</span> <span class="nc">Task</span>
    <span class="c1"># ...</span>
</code></pre></div><p>を</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="k">class</span> <span class="nc">Rake</span><span class="o">::</span><span class="no">Task</span>
  <span class="c1"># ...</span>
</code></pre></div><p>って書いたら<a href="https://houndci.com/">HoundCI</a>に怒られるんだけどなんでだろう？　といったことを話していた。</p><p>次回は「2.2.5 ネームスペースを使う」から。毎週ちょっとずつは読むとのこと。</p><p>また、ここのところ本にシンタックスハイライトを入れるのをやっていたので、この本も帰ったらやろうと思っていたが、始めからハイライトされていた。 <a href="https://gyazo.com/bcd51dd81e50c33c4b8fe5d714ca8887"><img src="https://gyazo.com/bcd51dd81e50c33c4b8fe5d714ca8887.png" alt="『メタプログラミングRuby 第2版』は始めからシンタックスハイライトされている" style="max-width: 80%;"/></a></p><h2 id=action-cable>Action Cable</h2><p><code class=highlighter-rouge>ApplicationCable::Channel</code>のユーザー定義のメソッドのスタックトレースを遡って、どこから呼ばれるのかを見ていった。</p><p>fukajunさんがプロジェクターで映しながらエディターを開いてソースを追い掛け、みんなで横からああだこおだと言っていた。読んだのはだいたいこの辺。</p><ul><li><a href="https://github.com/rails/rails/blob/39f383bad01e52c217c9007b5e9d3b239fe6a808/actioncable/lib/action_cable/connection/subscriptions.rb">action_cable/connection/subscriptions.rb</a></li><li><a href="https://github.com/rails/rails/blob/39f383bad01e52c217c9007b5e9d3b239fe6a808/actioncable/lib/action_cable/connection/message_buffer.rb">action_cable/connection/message_buffer.rb</a></li><li><a href="https://github.com/rails/rails/blob/39f383bad01e52c217c9007b5e9d3b239fe6a808/actioncable/lib/action_cable/server/worker.rb">action_cable/server/worker.rb</a></li></ul><p>一度<a href="https://github.com/celluloid/celluloid">Celluloid</a>をやめて<a href="https://github.com/ruby-concurrency/concurrent-ruby">Concurrent Ruby</a>にしたところ（<a href="https://github.com/rails/rails/commit/3b7ccadfc1c8dfec61af898167e1300b17f5cf25">3b7ccad</a>）、それを巻き戻し（<a href="https://github.com/rails/rails/commit/d0393fccffc118a5de37654aa222774b66123393">d0393fc</a>）、更にまた巻き戻す（<a href="https://github.com/rails/rails/commit/01c320001bcce617196270f3d398d48a89a6ea2a">01c3200</a>）ということをしていて、この辺の扱い大変なんだなあという話をした。使いたいのはCelluloidの方であるようだ（<a href="https://github.com/rails/rails/pull/22977">#22977</a>）。</p><p>ここを読んだおかげで、<a href="http://necojackarc.hatenablog.com/entry/2015/12/20/043612">Rails5.0.0-beta1のActionCableを使って超簡易チャットを実装してみた</a>にある</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="k">class</span> <span class="nc">MessagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="no">ActionCable</span><span class="p">.</span><span class="nf">server</span><span class="p">.</span><span class="nf">broadcast</span> <span class="s2">"messages"</span><span class="p">,</span>
      <span class="ss">message: </span><span class="n">params</span><span class="p">[</span><span class="ss">:message</span><span class="p">][</span><span class="ss">:body</span><span class="p">],</span>
      <span class="ss">username: </span><span class="n">cookies</span><span class="p">.</span><span class="nf">signed</span><span class="p">[</span><span class="ss">:username</span><span class="p">]</span>

    <span class="n">head</span> <span class="ss">:ok</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>みたいなコードを見ても驚かずに「なるほど<code class=highlighter-rouge>ActionCable.server.broadcast</code>に渡している<code class=highlighter-rouge>"messages"</code>コマンドは別スレッドで実行されるからここはブロックせずに、即座にブラウザーに応答することができるんだな」と考えることができるようになった（でも、僕は気にならないけど、コントローラー内でこういうことするのに違和感を覚える人もいた）。</p><h2 id=electronrails-assetsjavascript>electron、rails-assets、JavaScript生態系</h2><p>なんかelectronが盛り上がってるらしく、夕食を頂きながら仕組みとかHTMLで作るのどうなの？　とか、rails-assetsとか派生してJavaScriptの開発環境って今どんな感じなの？　といった話をした。</p></paper-card><footer><ul><li class=next><a href="20.html" rel=next><paper-button raised>渋谷.rb[:20160120]</paper-button></a></li><li class=prev><a href="16.html" rel=prev><paper-button raised>『nginx実践入門』をシンタックスハイライトする</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></article></app-header-layout></main><script defer async src="//hypothes.is/embed.js"></script><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>