<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>[Groonga][全文検索]取り敢えずPDFを全文検索するシステムのための最少ステップ | アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:title content="[Groonga][全文検索]取り敢えずPDFを全文検索するシステムのための最少ステップ取り敢えずPDFを全文検索するシステムのための最少ステップ"><meta name=twitter:description content="Groongaで学ぶ全文検索 2016-03-25に行って来た。 今日は、仕事でPDFを全文検索できるようにしたいから話を聞きに来たという参加者がいたので、PDFを全文検索できるよう、Groongaのデータベースを作るまでをその場でやった。 まず、PDFを全文検索するために必要なことの概要を説明した。 全文検索できるようにするまでの概要 PDFを全文検索するに..."><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"></head><body class="x2016 x2016_03 x2016_03_25"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed shadow slot=header><app-toolbar><h2 class=site-title><a href="../../"> アペフチ <paper-ripple></paper-ripple></a></h2></app-toolbar></app-header><article><header><paper-card><h1>取り敢えずPDFを全文検索するシステムのための最少ステップ</h1><time pubdate>2016-03-25</time><ul class=tags><li><a href="../../tags/groonga.html" rel=tag>Groonga</a></li><li><a href="../../tags/.html" rel=tag>全文検索</a></li></ul></paper-card></header><paper-card><p><a href="https://groonga.doorkeeper.jp/events/41015">Groongaで学ぶ全文検索 2016-03-25</a>に行って来た。</p><p>今日は、仕事でPDFを全文検索できるようにしたいから話を聞きに来たという参加者がいたので、PDFを全文検索できるよう、Groongaのデータベースを作るまでをその場でやった。</p><p>まず、PDFを全文検索するために必要なことの概要を説明した。</p><h2 id=section>全文検索できるようにするまでの概要</h2><p>PDFを全文検索するには</p><ol><li>全文検索できるようにするための準備（データベースの構築）</li><li>データベースを使って全文検索をする</li></ol><p>という二段階が必要になる。</p><p>準備は、</p><ol><li>PDFからテキストを抜き出す</li><li>テキストをGroongaに突っ込む</li><li>Groongaが（勝手に）インデックスを作る</li></ol><p>という手順に分解できる。ここのところ僕が説明したのだけど、「テキストをGroongaに突っ込む」のところ、「どのような形で」というのが抜けていて、そこがぴんとこなかったようだ。あとで<a href="https://twitter.com/ktou">@ktou</a>さんとの質疑応答で「<strong>PDFのパスとかのメタデータと一緒に</strong>（JSONとかのフォーマットにして）突っ込む」と言ったところでぴんときたようだった。</p><p>手順に戻って、全文検索の実行のところ。</p><ol><li>検索語をGroongaに与える</li><li>Groongaがその語を含むPDFのパス（とか、ページ番号とかの付随的な物）を返す</li></ol><p>ということになる。</p><h2 id=pdf>PDFを全文検索できるようにする</h2><p>ここまで説明した所で、手元のPDFファイルを使って実際にデータベースの作成から検索してみるまでを@ktouさんがやって見せてくれた。時間も限られているので、「本文に関する検索をして、そのPDFのパスが得られるようにする」というのを目標にした。</p><h3 id=section-1>1. テーブルを作る</h3><p>コマンドラインでテーブルを作る（暗黙に、Groongaはテーブルの形でデータを表現しているということになる）。</p><div class=highlighter-rouge><pre class=highlight><code>table_create pdfs \
  TABLE_HASH_KEY \
  ShortText
</code></pre></div><p><code class=highlighter-rouge>ShortText</code>のところは、ハッシュテーブルのキーの型を決めている。</p><p>こんなファイルを作って、<code class=highlighter-rouge>groonga</code>コマンドに入力すると、<code class=highlighter-rouge>pdfs</code>テーブルが出来る。</p><p>まずデータベース（ファイル）を作る。</p><div class=highlighter-rouge><pre class=highlight><code>% groonga -n /tmp/grn
</code></pre></div><p>次にファイルに書いたコマンドを読み込ませる。</p><div class=highlighter-rouge><pre class=highlight><code>% groonga /tmp/grn &lt; /tmp/table-create.grn
</code></pre></div><p>これでテーブルが出来る。ただ、今はハッシュテーブルのキーのところにしかデータが保存できないので、PDF本文を保存する場所をこのテーブルのカラムとして作る。</p><div class=highlighter-rouge><pre class=highlight><code>column_create pdfs body \
  COLUMN_SCALAR \
  Text
</code></pre></div><p><code class=highlighter-rouge>COLUMN_SCALAR</code>の所は<code class=highlighter-rouge>COLUMN_SCALAR</code>か<code class=highlighter-rouge>COLUMN_VECTOR</code>かが選べて、このカラムに入るのが分割できない単位なのか、配列のようにその単位を複合させた物なのかで選ぶ。今回は、一つのキー（PDFファイルのパス）に複数の本文が入ることはないので、スカラーにしている。</p><h3 id=section-2>データを入れる</h3><p>で、実際にデータを入れる。</p><p>その前に、PDFからテキストの形式にしないといけない。更に、Groongaは（コマンドでは）JSONフォーマットでデータを入力するので、データを加工しなければならない。</p><p>ここでは、<a href="https://poppler.freedesktop.org/">Poppler</a>付属の<code class=highlighter-rouge>pdftotext</code>コマンドで抽出したテキストをファイルに保存して、それを使ってRubyで、ファイルのパス情報と一緒にJSONにしていた。本題ではないので割愛。以下のようなファイルをRubyで作って、<code class=highlighter-rouge>groonga</code>コマンドに読み込ませる。</p><div class=highlighter-rouge><pre class=highlight><code>load --table pdfs
[
  {
    "_key": "path/to/pdf"
    "body": "でかい本文"
  }
]
</code></pre></div><h3 id=section-3>インデックス無しでの検索</h3><p>Groongaはインデックスを作らないでも検索できる。</p><div class=highlighter-rouge><pre class=highlight><code>select --table pdfs \
  --query body:@API
</code></pre></div><p><code class=highlighter-rouge>@API</code>の所が、（その前にある<code class=highlighter-rouge>body</code>カラムに対して）<code class=highlighter-rouge>API</code>で検索する、という指定になっている。インデックスが無い時は、ただの線形検索になる。@ktouさんの手元のPDF、手元のGroongaで試したところ、この検索には60ミリ秒くらい掛かった。インデックスを作って使うとこれより速いはずなので後で試してみる。</p><h3 id=section-4>インデックスを作る</h3><p>RDBMSでは、インデックスを張るには単に張りたいカラムを指定すればよかったが、Groongaではより検索方法に合わせた柔軟なインデックスが作れるように、色々パラーターを指定しながら自分でインデックスを作る。そのインデックスは、上でやったようなテーブルとして作る。</p><p>が、初めての時などはおすすめの設定があるので取り敢えずテンプレとしてそれを使えばよい。</p><div class=highlighter-rouge><pre class=highlight><code>table_create terms \
  TABLE_PAT_KEY \
  ShortText \
  --default_tokenizer TokenBigram \
  --normalzer NormalizarAuto
</code></pre></div><p>全文検索する時は、（<code class=highlighter-rouge>pdfs</code>テーブルでハッシュテーブルにしていたところに相当するところが）パトリシアトライというのがおすすめなので、<code class=highlighter-rouge>TABLE_PAT_KEY</code>と書く。これはこのまま使っておけばよい。「<code class=highlighter-rouge>terms</code>」というのがテーブル名なので、ここだけ気分によって変えればよい。</p><p>次はカラム。</p><div class=highlighter-rouge><pre class=highlight><code>column_create terms body_index \
  COLUMN_INDEX|WITH_POSITION \
  pdfs \
  body
</code></pre></div><p>これもテンプレで、「<code class=highlighter-rouge>body_index</code>」は変えてよい。名前から想像付くように、<code class=highlighter-rouge>pdfs</code>テーブルの<code class=highlighter-rouge>body</code>カラムのためのインデックスだからこの名前になっている。分かりやすいのがいいだろう。「<code class=highlighter-rouge>pdfs</code>」は、<code class=highlighter-rouge>pdfs</code>テーブルに対するインデックスということを意味し、「<code class=highlighter-rouge>body</code>」はその中の<code class=highlighter-rouge>body</code>カラムへのインデックスだということをGroongaに教えている。</p><p>これでさっきのように</p><div class=highlighter-rouge><pre class=highlight><code>select --table pdfs \
  --query body:@API
</code></pre></div><p>すると、今度は0.2ミリ秒程度で検索結果が返って来た。二桁の差が付いたことになる（PDF結構でかくて、1MiBくらいあった）。</p><p>あとは、アプリケーションの要件に合わせてウェブUIを付けたりすると出来上がりだ。</p><p>参考までに既にGroongaを使ったPDF検索アプリケーションとして<a href="http://honyomi.nagoya/ja/">honyomi</a>があって、検索結果からそのまま読み始めたりできるので便利。</p></paper-card><footer><ul><li class=next><a href="../04/10.html" rel=next><paper-button raised>日記のコメント用にHypothes.isを埋め込んでみた</paper-button></a></li><li class=prev><a href="16.html" rel=prev><paper-button raised>渋谷.rb[:20160316]</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></article></app-header-layout></main><script defer async src="//hypothes.is/embed.js"></script><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>