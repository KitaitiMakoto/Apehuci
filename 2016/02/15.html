<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>[Ruby][Ruby on Rails]Sendagaya.rb #137 | アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:title content="[Ruby][Ruby on Rails]Sendagaya.rb #137Sendagaya.rb #137"><meta name=twitter:description content="Sendagaya.rb #137に参加して来た。『メタプログラミングRuby 第2版』と、Active Record enumsの話をして来た。 メタプログラミングRuby 3章 メソッド 今回もメタプログラミングRubyを読んだ。「3章 メソッド」から（こういう時、章にもリンクを貼りたいものだ）。 同じようなメソッドの定義を繰り返すのではなく、動的に定義す..."><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"></head><body class="x2016 x2016_02 x2016_02_15"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed shadow slot=header><app-toolbar><h2 class=site-title><a href="../../"> アペフチ <paper-ripple></paper-ripple></a></h2></app-toolbar></app-header><article><header><paper-card><h1>Sendagaya.rb #137</h1><time pubdate>2016-02-15</time><ul class=tags><li><a href="../../tags/ruby.html" rel=tag>Ruby</a></li><li><a href="../../tags/ruby-on-rails.html" rel=tag>Ruby on Rails</a></li></ul></paper-card></header><paper-card><p><a href="https://sendagayarb.doorkeeper.jp/events/39087">Sendagaya.rb #137</a>に参加して来た。『メタプログラミングRuby 第2版』と、Active Record enumsの話をして来た。</p><h2 id=ruby-3->メタプログラミングRuby 3章 メソッド</h2><p>今回も<a href="https://www.oreilly.co.jp/books/9784873117430/">メタプログラミングRuby</a>を読んだ。「3章 メソッド」から（こういう時、章にもリンクを貼りたいものだ）。</p><p>同じようなメソッドの定義を繰り返すのではなく、動的に定義することで、重複した記述を減らす方法が紹介される。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="k">class</span> <span class="nc">Computer</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">computer_id</span><span class="p">,</span> <span class="n">data_source</span><span class="p">)</span>
    <span class="vi">@id</span> <span class="o">=</span> <span class="n">computer_id</span>
    <span class="vi">@data_source</span> <span class="o">=</span> <span class="n">data_source</span>
  <span class="k">end</span>

   <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">define_component</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="n">define_method</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">info</span> <span class="o">=</span> <span class="vi">@data_source</span><span class="p">.</span><span class="nf">send</span> <span class="s2">"get_</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_info"</span><span class="p">,</span> <span class="vi">@id</span>
      <span class="n">price</span> <span class="o">=</span> <span class="vi">@data_source</span><span class="p">.</span><span class="nf">send</span> <span class="s2">"get_</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_price"</span><span class="p">,</span> <span class="vi">@id</span>
      <span class="n">result</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="p">.</span><span class="nf">capitalize</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">info</span><span class="si">}</span><span class="s2"> ($</span><span class="si">#{</span><span class="n">price</span><span class="si">}</span><span class="s2">)"</span>
      <span class="k">return</span> <span class="s2">"* </span><span class="si">#{</span><span class="n">result</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">price</span> <span class="o">&gt;=</span> <span class="mi">100</span>
      <span class="n">result</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">define_component</span> <span class="ss">:mouse</span>
  <span class="n">define_component</span> <span class="ss">:cpu</span>
  <span class="n">define_component</span> <span class="ss">:keyboard</span>
<span class="k">end</span>
</code></pre></div><p>これで</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code>  <span class="k">def</span> <span class="nf">mouse</span>
    <span class="n">info</span> <span class="o">=</span> <span class="vi">@data_source</span><span class="p">.</span><span class="nf">get_mouse_info</span><span class="p">(</span><span class="vi">@id</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="vi">@data_source</span><span class="p">.</span><span class="nf">get_mouse_price</span><span class="p">(</span><span class="vi">@id</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s2">"Mouse: </span><span class="si">#{</span><span class="n">info</span><span class="si">}</span><span class="s2"> ($</span><span class="si">#{</span><span class="n">price</span><span class="si">}</span><span class="s2">)"</span>
    <span class="k">return</span> <span class="s2">"* </span><span class="si">#{</span><span class="n">result</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">price</span> <span class="o">&gt;=</span> <span class="mi">100</span>
    <span class="n">result</span>
  <span class="k">end</span>
</code></pre></div><p>みたいなメソッドを幾つも書く作業から開放される。例によってふんふんなるほどと読んでいたが、例によって甘かった。十五分読んだ後にみんなで話している時に、このコードの「危なさ」を指摘する声が上がった。</p><p>「<code class=highlighter-rouge>initialize</code>で<code class=highlighter-rouge>data_source</code>を引数に受け取っているが、別々のインスタンス初期化時に別々の<code class=highlighter-rouge>data_source</code>を受け取り得るから、クラス全体が和集合のような不要なメソッドも持った物になる」とのことだった。僕にはぴんとこなかった。その後、コードを使って説明してくれた。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="nb">methods</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:moge</span><span class="p">,</span> <span class="ss">:hoge</span><span class="p">]</span>
<span class="n">methods2</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:moge</span><span class="p">,</span> <span class="ss">:hoge</span><span class="p">,</span> <span class="ss">:age</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">Computer</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">methods</span><span class="p">)</span>
    <span class="nb">methods</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">method</span><span class="o">|</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">define_kick</span> <span class="nb">method</span>
      <span class="nb">puts</span> <span class="nb">method</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">define_kick</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="n">define_method</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_kick"</span><span class="p">)</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">'name'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="n">c1</span> <span class="o">=</span> <span class="no">Computer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">methods</span><span class="p">)</span>         <span class="c1"># =&gt; "moge"、"hoge"を出力</span>
<span class="nb">p</span> <span class="n">c1</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">instance_methods</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span> <span class="c1"># =&gt; [:moge_kick, :hoge_kick]</span>
<span class="n">c2</span> <span class="o">=</span> <span class="no">Computer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">methods2</span><span class="p">)</span>        <span class="c1"># =&gt; "moge"、"hoge"、"age"を出力</span>
<span class="nb">p</span> <span class="n">c2</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">instance_methods</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span> <span class="c1"># =&gt; [:moge_kick, :hoge_kick, :age_kick]</span>
<span class="nb">p</span> <span class="n">c1</span><span class="p">.</span><span class="nf">class</span> <span class="o">==</span> <span class="n">c2</span><span class="p">.</span><span class="nf">class</span>             <span class="c1"># =&gt; true</span>
<span class="nb">p</span> <span class="n">c1</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">instance_methods</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span> <span class="c1"># =&gt; [:moge_kick, :hoge_kick, :age_kick]</span>
</code></pre></div><p>（少しコメントを足し、改変した）</p><p>最後の行、<code class=highlighter-rouge>c1</code>でも期待しないメソッド<code class=highlighter-rouge>#age_kick</code>が使えることを示している（その前の行からも明らかだが）。こういう危なさがあることに、僕は気が付かなかった。勿論、これが「危ない」かどうかは作るアプリケーション次第だ。別にこれで構わないということも理論上ある。それは何かと話していて、「サンプル」かなとなった。</p><h2 id=activerecord-enumsdb>ActiveRecord enumsのDB内での値を文字列にする</h2><p>その後、今日は何を話そうかと話していると、Rails 4.1から入った<a href="http://edgeguides.rubyonrails.org/4_1_release_notes.html#active-record-enums">ActiveRecord enums</a>の機能についての相談が上がった。</p><p>この機能はRDBMSなんかでも実装されているenum（列挙型）の機能をRailsのレイヤーで実装した物で、ユーザー（Railsを使うプログラマー）はモデルオブジェクトが提供する、人間が読みやすいインターフェイスだけ扱っていればいいようになる。バックエンドではActiveRecordが数値に変換してDBに格納し、ユーザーとの間を取り持ってくれる。</p><p>今回の相談は、この機能ではDBに格納する値も文字列にすることができるが、それは普通ではないのだろうか？　という物。</p><p>始め、「何となく気持ち悪いですね」くらいしか言うことができなかった。一応、データサイズが増えるというのもあるが、このご時世、そこは気にするポイントではないだろうとのこと。しばらく話しながら思い付いたのは、文字列にするとインデックスを張ることになるだろうから、インサート時にインデックスを更新するコストが掛かって（遅くなって）しまうということだった。これはそれなりに妥当だと受け取られて、「じゃあ、やっぱり（ActiveRecordの）enumのバックエンドは数値にしておくのが普通なんですね」ということになった。</p><p>ちなみに相談者が文字列を使いたい一番の背景は、Railsは分からないがSQLなら分かるという人のいる場（に、今いるらしい）では、値が数値で返って来ると人間の方で対応する文字列を参照しないといけないので、嫌だ、ということだった。これは勿論妥当だと思うので、この人のケースでは、文字列を使うのは正解だと思う（が、<a href="https://github.com/sferik/rails_admin">RailsAdmin</a>がエラーになるという問題があるらしかった）。それは置いておいても割と一般的に文字列を使いたいこだわりがありそうだったが、そこは深く話さなかった。今思うともったいなかったかも知れない。</p><p>「そう言えば、Railsを使うとマスターテーブルを作ることをしなくなるな」という話もした。『<a href="https://www.oreilly.co.jp/books/9784873114163/">エンタープライズRails</a>』には「アプリケーションのフレームワークや言語よりも、データベースのデータのほうが長く残るから、データだけで完結できるようにしておくべきだ」と書いてあったように思うのだけど、時代も違うし、エンタープライズだとウェブのコンシューマー向けサービスとは領域も違うということだろうか。</p></paper-card><footer><ul><li class=next><a href="21.html" rel=next><paper-button raised>A Tour of Goのエクササイズをやってみた</paper-button></a></li><li class=prev><a href="12.html" rel=prev><paper-button raised>実例を元にした全文検索エンジン（Groonga）のテーブル設計</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></article></app-header-layout></main><script defer async src="//hypothes.is/embed.js"></script><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>