<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>[Groonga][Polymer][Middleman]日記に検索機能をつけた | アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:title content="[Groonga][Polymer][Middleman]日記に検索機能をつけた日記に検索機能をつけた"><meta name=twitter:description content="この日記に検索機能を付けてフッターに置いた。軽快にインクリメンタルサーチができていて、なかなかいい。 Groongaを使った全文検索 この際に、二つやったことのない作業があって、その一つは検索エンジンを使った検索機能の作成。正直、静的サイトの検索なんてGoogle Custom SearchやSwiftypeを使えばいいと思うが、自分で遊ぶための場所を持つとい..."><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"></head><body class="x2016 x2016_02 x2016_02_07"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed shadow slot=header><app-toolbar><h2 class=site-title><a href="../../"> アペフチ <paper-ripple></paper-ripple></a></h2></app-toolbar></app-header><article><header><paper-card><h1>日記に検索機能をつけた</h1><time pubdate>2016-02-07</time><ul class=tags><li><a href="../../tags/groonga.html" rel=tag>Groonga</a></li><li><a href="../../tags/polymer.html" rel=tag>Polymer</a></li><li><a href="../../tags/middleman.html" rel=tag>Middleman</a></li></ul></paper-card></header><paper-card><p>この日記に検索機能を付けてフッターに置いた。軽快にインクリメンタルサーチができていて、なかなかいい。</p><h2 id=groonga>Groongaを使った全文検索</h2><p>この際に、二つやったことのない作業があって、その一つは検索エンジンを使った検索機能の作成。正直、静的サイトの検索なんて<a href="https://developers.google.com/custom-search/">Google Custom Search</a>や<a href="https://swiftype.com/">Swiftype</a>を使えばいいと思うが、自分で遊ぶための場所を持つというのも日記を移行した目的の一つだったから、自分でやってみた。</p><p><a href="https://middlemanapp.com/jp/">Middleman</a>でサイトをビルドした後、<a href="http://docs.ruby-lang.org/ja/2.3.0/library/rake.html">Rake</a>タスクでビルド済みディレクトリーから日記本文を抽出して、<a href="http://groonga.org/ja/">Groonga</a>に投げ込んでインデックスを作っている。始め、Middlemanのビルド時のidentical、updated、created、removedという状態変化の情報を利用して、必要な分だけGroonga上のインデックスを更新しようかと思っていた（そのための調査結果はQiitaの<a href="http://qiita.com/KitaitiMakoto/items/ca3792f75270b533d37c">Middlemanで「変更なし」「作成」「削除」「変更」の状態を取る</a>という記事に書いた）。でも、実用上それで問題ないのだが、一応「ビルド環境が変わったらそういった状態変化の情報は変わる、ポータブルではない」ということに配慮して、毎回全日記の分をGroongaに投げるようにしている。今のところ、パフォーマンスが問題になったりということは全然ない。</p><p>そのように毎回全部作り直すことにしたので、ローカルでインデックス構築済み<a href="http://groonga.org/ja/docs/reference/executables/groonga-httpd.html">groonga-httpd</a>の<a href="https://www.docker.com/">Docker</a>イメージを作って、それをデプロイするようにしようかとも思った。実際イメージを作るまではやっていた。が、せっかくGroongaがなるべくOSの機能を引き出すように作られているのに、仮想環境で動かすのはもったいないと思って「普通」にインストールして<a href="http://www.freedesktop.org/wiki/Software/systemd/">systemd</a>で起動して使っている（<a href="https://www.linode.com/">Linode</a>を使っているから、まあ、仮想環境ではあるが）。</p><p>何故か<code class=highlighter-rouge>snippet_html()</code>関数がうまく動いていないので、別途調査が必要だ。</p><p>そう言えば、記事を削除した時の対応もRakeタスクにない。消すことがあったら考えよう。記事データをGroongaを投げる時に削除できるよう自動化するのでなく、PostgreSQLの<code class=highlighter-rouge>VACUUM</code>みたいに、ユーザー側で明示的に実行するのでいいと思う。</p><h2 id=polymer>Polymerコンポーネントの作成</h2><p>もう一つは、検索エリアを作るのに、<a href="https://www.polymer-project.org/1.0/">Polymer</a>を使って検索用のコンポーネントを作った（HTMLソースを見れば<code class=highlighter-rouge>&lt;blog-search&gt;</code>というタグが見付かるはずだ）こと。</p><p>作り始め、全く何も表示できず、Polymerに慣れてもいないので自分が何か間違っているかと色々試しすごい時間を費したが、内部で使っているコンポーネントを読み込む<code class=highlighter-rouge>&lt;link&gt;</code>要素の<code class=highlighter-rouge>import</code>属性を<code class=highlighter-rouge>ipmort</code>と書き間違えていただけだった。分かった時には脱力した。</p><p>ユーザー入力（<code class=highlighter-rouge>&lt;paper-input&gt;</code>）、Groongaとの通信（<code class=highlighter-rouge>&lt;iron-ajax&gt;</code>）、その二つの繋ぎ（<code class=highlighter-rouge>&lt;blog-search&gt;</code>）という構成で作ったが、<code class=highlighter-rouge>&lt;blog-search&gt;</code>は昔ながらのjQueryを使った素朴な同期処理のようになってしまった。Polymerにはデータバインディングの仕組みがあるのにもったいない。もう少しすっきりするよう書き換えたい。</p><p>しかし、他のコンポーネント指向のライブラリーもそうだと思うが、閉じたスコープのことだけを考えてHTML、CSS、JavaScriptを書けばよいというのは大分ストレスフリーだ。</p><hr/><p>前からずっと、「あの記事はどこだっけ」と思った時に<code class=highlighter-rouge>git grep</code>してURIを調べてからページを表示していたので、それが無くなって自分が嬉しい機能だ。</p><h2 id=section>追記</h2><p>と思いきや、このサイトは外にリンクを置く時はHTTPSで置いているのだけどgroonga-httpdのdebパッケージにはTLSモジュールが組み込まれていなかった。取り敢えずNginxを前に立てたけど、groonga-httpdのウェブサーバー機能もNginxなので、こちらのビルド時にTLSモジュールを組み込むのが正しいと思う。後でメーリングリストに送って入れてもらうか自分でビルドするかしよう。</p></paper-card><footer><ul><li class=next><a href="12.html" rel=next><paper-button raised>実例を元にした全文検索エンジン（Groonga）のテーブル設計</paper-button></a></li><li class=prev><a href="02.html" rel=prev><paper-button raised>Sendagaya.rb #135</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></article></app-header-layout></main><script defer async src="//hypothes.is/embed.js"></script><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>