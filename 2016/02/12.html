<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>[全文検索][Groonga]実例を元にした全文検索エンジン（Groonga）のテーブル設計 | アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:title content="[全文検索][Groonga]実例を元にした全文検索エンジン（Groonga）のテーブル設計実例を元にした全文検索エンジン（Groonga）のテーブル設計"><meta name=twitter:description content="Groongaで学ぶ全文検索 2016-02-12に行って来た。今日は、参加者が勉強にと国立国会図書館の書誌情報データを取って来てGroongaに入れてみている、だが今のテーブル設計がいいのか分からないということだったので、それをまず説明してもらって、@ktouさんが各テーブル作成時のオプションなどを説明してくれた。 インデックスを作る前と後で検索結果を比較し..."><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"></head><body class="x2016 x2016_02 x2016_02_12"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed shadow slot=header><app-toolbar><h2 class=site-title><a href="../../"> アペフチ <paper-ripple></paper-ripple></a></h2></app-toolbar></app-header><article><header><paper-card><h1>実例を元にした全文検索エンジン（Groonga）のテーブル設計</h1><time pubdate>2016-02-12</time><ul class=tags><li><a href="../../tags/.html" rel=tag>全文検索</a></li><li><a href="../../tags/groonga.html" rel=tag>Groonga</a></li></ul></paper-card></header><paper-card><p><a href="https://groonga.doorkeeper.jp/events/38529">Groongaで学ぶ全文検索 2016-02-12</a>に行って来た。今日は、参加者が勉強にと国立国会図書館の書誌情報データを取って来てGroongaに入れてみている、だが今のテーブル設計がいいのか分からないということだったので、それをまず説明してもらって、<a href="https://twitter.com/ktou">@ktou</a>さんが各テーブル作成時のオプションなどを説明してくれた。</p><p>インデックスを作る前と後で検索結果を比較していて、インデックス作ってそっちで検索すると20倍速くなったということで、インデックスの有用性が証明されてた。</p><p>そんなわけで個別に色々説明してくれたのだが、まとまっているわけではないので、幾つか取り上げることにする。</p><h2 id=withposition>WITH_POSITIONの活躍</h2><p>今回はインデックステーブルを作る時に、タイトルに対応するインデックスカラムを作る時に<code class=highlighter-rouge>COLUMN_INDEX|WITH_POSITION</code>と、<code class=highlighter-rouge>WITH_POSITION</code>が指定されていた。これがうまく活きる状況の話があった。</p><p>『一、二年生の基礎英作文』というタイトルの本があった。これに対して「一年生」で検索した時に、この本はヒットするだろうか。但し、実際のトークナイザーは<code class=highlighter-rouge>TokenBigram</code>が選ばれていたが、仮に<code class=highlighter-rouge>TokenMecab</code>にしたとする。</p><p>タイトルは「一」「、」「二」「年生」「の」……とMeCabはトークナイズした。検索クエリーは「一」「年生」になる。とすると、このタイトルはクエリーのトークン「一」にも「年生」にもヒットするので、ヒットしそうだ。しかししない。なぜならGroongaはこのタイトルカラムではキーワードの位置情報も持っていて、「一」と「年生」がこの順番で隣り合っていないことを知っているからだ。同様の理由で、仮に『二年生の基礎英作文（一）』みたいなタイトルの本があったとしてもヒットしない。このように、「キーワードが文書中でどの位置にあるか」という情報も持たせるオプションが<code class=highlighter-rouge>WITH_POSITION</code>。なので逆に、これを指定していなければ上のクエリーでこの文書はヒットするだろう。</p><p>MeCabみたいな形態素解析をせずbi-gramで<code class=highlighter-rouge>WITH_POSITION</code>なし、みたいなカラムを作ると、色々な物がヒットし過ぎて検索には使い物にならないカラムになったりもする。</p><h2 id=bi-gram>bi-gramでトークナイズしている時は、一文字では検索できないのか？</h2><p>bi-gramでトークナイズしている時は、インデックスのキーには二文字の文字列が入っている（文末など場合によっては一文字もある）。そういう時に、検索クエリーが一文字の時には、何もヒットしなくなるのでは？　という疑問が出た。</p><p>答えはヒットする。今回の実例では、インデックスキーをパトリシリアトライで作っていた（＝ハッシュにしていなかった）から。パトリシアトライなら前方一致検索ができるので、一文字のクエリーでも探すことができる。なぜパトリシアトライなら前方一致検索ができるのか？　忘れた。もうパトリシアトライの構造を忘れたので後で見ておく……。</p><p>尚、MySQL 5.7から入ったInnoDBの全文検索機能では、bi-gramでトークナイズする設定にすると、実際に一文字での検索ではヒットしなくなるらしい。</p><h2 id=section>テーブルのキーに選ぶべき物</h2><p>今回は、国会図書館から提供されているTSVのうち、URL、タイトル、著者、出版社をGroongaに入れていた。テーブルとしてはハッシュテーブルを選び、キーにURIを入れていた。これは正しい設計だろうか？</p><p>具体的なアプリケーションの要件によって、考慮するべきことがある。</p><ul><li>ハッシュテーブルでいいだろうか？</li><li>いいとして、キーはURLでいいだろうか？</li></ul><p>ハッシュテーブルのいい所は、キーが存在していて、そのキーを使ってレコードを一意に特定できる所。逆に言うと特定する必要がない、つまり後からレコードを探して更新や削除をすることが無いのであれば、ハッシュテーブルを使う必要はない。追加しか無いのなら、配列を使ってもいい。</p><p>ハッシュテーブルを選んだとして、そのキーカラムのサイズは（現在のGroongaでは）4KiBになっている。普通それならURLを入れても大丈夫だろうと思うが、溢れることがあると@ktouさんは主張していた（何か嫌な思い出がありそうだった）。ので、今回の場合だと、選択したカラムにはなかったが、ISBNを使うのがよさそうとのこと。また、そういう一意かつ短めの物が選べない時は、一意な物のハッシュ値を計算してキーとして入れるといいとのこと。</p></paper-card><footer><ul><li class=next><a href="15.html" rel=next><paper-button raised>Sendagaya.rb #137</paper-button></a></li><li class=prev><a href="07.html" rel=prev><paper-button raised>日記に検索機能をつけた</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></article></app-header-layout></main><script defer async src="//hypothes.is/embed.js"></script><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>