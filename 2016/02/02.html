<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>[Ruby][Ruby on Rails]Sendagaya.rb #135 | アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:title content="[Ruby][Ruby on Rails]Sendagaya.rb #135Sendagaya.rb #135"><meta name=twitter:description content="Sendagaya.rb #135に行って来た。今日も前半は『メタプログラミングRuby 第2版』を読んで、後半はRails 5のチェンジログからActive Record 5.0.0.beta1のチェンジログを眺めていた。 メタプログラミングRuby Refinements 今日は「2.4.2 メソッドの実行」から「2.4.3 Refinements」まで。..."><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"></head><body class="x2016 x2016_02 x2016_02_02"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed shadow slot=header><app-toolbar><h2 class=site-title><a href="../../"> アペフチ <paper-ripple></paper-ripple></a></h2></app-toolbar></app-header><article><header><paper-card><h1>Sendagaya.rb #135</h1><time pubdate>2016-02-02</time><ul class=tags><li><a href="../../tags/ruby.html" rel=tag>Ruby</a></li><li><a href="../../tags/ruby-on-rails.html" rel=tag>Ruby on Rails</a></li></ul></paper-card></header><paper-card><p><a href="https://sendagayarb.doorkeeper.jp/events/38208">Sendagaya.rb #135</a>に行って来た。今日も前半は『<a href="https://www.oreilly.co.jp/books/9784873117430/">メタプログラミングRuby 第2版</a>』を読んで、後半はRails 5のチェンジログから<a href="https://github.com/rails/rails/blob/v5.0.0.beta1/activerecord/CHANGELOG.md">Active Record 5.0.0.beta1のチェンジログ</a>を眺めていた。</p><h2 id=ruby-refinements>メタプログラミングRuby Refinements</h2><p>今日は「2.4.2 メソッドの実行」から「2.4.3 Refinements」まで。</p><p>メソッドの実行では他の言語から来ると<code class=highlighter-rouge>private</code>とかに戸惑うよねとか、<code class=highlighter-rouge>protected</code>って何に使うんだろうねという話をした。</p><p>お次はいよいよ<a href="http://magazine.rubyist.net/?0041-200Special-refinement">Refinements</a>。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="k">class</span> <span class="nc">MyClass</span>
  <span class="k">def</span> <span class="nf">my_method</span>
    <span class="s2">"original my_method"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">anothor_method</span>
    <span class="n">my_method</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">MyClassRefinements</span>
  <span class="n">refine</span> <span class="no">MyClass</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">my_method</span>
      <span class="s2">"refined my_method"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">using</span> <span class="no">MyClassRefinements</span>
<span class="no">MyClass</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">my_method</span>      <span class="c1"># =&gt; "refined my_method"</span>
<span class="no">MyClass</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">another_method</span> <span class="c1"># =&gt; "original my_method"</span>
</code></pre></div><p>この最後の行は驚かないだろうか。僕は驚いた。</p><p>この挙動を本では</p><blockquote><p>Refinementsが有効になっているコードは、（略）インクルードやプリペンドしたモジュールのコードよりも優先される。</p></blockquote><p>と説明している。しかしこれだけで、メソッド探索の順番を覚えられるだろうか。<a href="https://twitter.com/tkawa">@tkawa</a>さんの説明が素晴らしかった。</p><ol><li>クラスやインクルードやプリペンドを考慮するより先に、まずRefinementsを探す</li><li>次に通常のメソッド探索手順に従って、プリペンドされた物、インクルードした物、特異クラス、クラス……とメソッドを探す</li></ol><p>ということだ。上の例で言うと、まず<code class=highlighter-rouge>my_methodを呼ぶ場合</code></p><ol><li>Refinementsを探す</li><li><code class=highlighter-rouge>MyClassRefinements</code>が見付かる</li><li><code class=highlighter-rouge>my_method</code>が定義されている</li><li><code class=highlighter-rouge>MyClassRefinements#my_method</code>を呼ぶ</li></ol><p>で、結果は<code class=highlighter-rouge>"refined my_method"</code>になる。一方<code class=highlighter-rouge>another_method</code>は</p><ol><li>Refinementsを探す</li><li><code class=highlighter-rouge>MyClassRefinements</code>が見付かる</li><li><code class=highlighter-rouge>another_method</code>は定義されていない</li><li>Refinementsの探索は終わり、今後二度と探索されない</li><li>プリペンドされたモジュールやインクルードされたモジュールを探すが、ない</li><li>クラスを見る</li><li><code class=highlighter-rouge>MyClass</code>である</li><li><code class=highlighter-rouge>another_method</code>が定義されている</li><li><code class=highlighter-rouge>another_method</code>を実行する</li><li><code class=highlighter-rouge>my_method</code>が呼ばれている</li><li>Refinementsの探索は終わっているので、クラスの<code class=highlighter-rouge>my_method</code>が見付かる</li><li><code class=highlighter-rouge>MyClass#my_method</code>を実行する</li></ol><p>ということで、結果が<code class=highlighter-rouge>"original my_method"</code>になる、というわけだ。</p><p>子の説明を聞いて僕は「あ。」と声が漏れるくらい腹に落ちた。</p><h2 id=active-record-500beta1>Active Record 5.0.0.beta1チェンジログ</h2><p>その後もちょいちょいRefinementsと遊んでからは<a href="https://github.com/rails/rails/blob/v5.0.0.beta1/activerecord/CHANGELOG.md">Active Record 5.0.0.beta1のチェンジログ</a>をざっと流しながら気になった所で止めて、あーだこーだ言っていた。結構RDBMSの個別機能に対応していたり、細かなユースケースを拾ったりしていて、「Active Recordは基本は既に成熟しているんだろうなあ」という感想を持った。</p><p>次回は『メタプログラミングRuby』読むほか、fukajunさんがElectronについての発表をしたいということなのでそれは聞けるはずだ。あとはその場で決まるんだろう。その場で決まるので、聞きたいことを持って行けば、聞けると思う。</p><p>次回分もすぐさまイベントが作られて、申し込める。<br/><a href="https://sendagayarb.doorkeeper.jp/events/38655">https://sendagayarb.doorkeeper.jp/events/38655</a></p></paper-card><footer><ul><li class=next><a href="07.html" rel=next><paper-button raised>日記に検索機能をつけた</paper-button></a></li><li class=prev><a href="../01/29.html" rel=prev><paper-button raised>ノーマライズと形態素解析</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></article></app-header-layout></main><script defer async src="//hypothes.is/embed.js"></script><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>