<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>[Ruby on Rails][Groonga]Railsでの検索機能にgroonga-client-railsを使う（後編） | アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:title content="[Ruby on Rails][Groonga]Railsでの検索機能にgroonga-client-railsを使う（後編）Railsでの検索機能にgroonga-client-railsを使う（後編）"><meta name=twitter:description content="アドベントカレンダー「Groonga Advent Calendar 2016」の21日目です、書いているのは25日ですが……済みません 前回のRailsでの検索機能にgroonga-client-railsを使う（前編）では、groonga-client-rails gemを使って Groongaのデータベースを作ること Railsのモデル操作とGroong..."><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"></head><body class="x2016 x2016_12 x2016_12_21"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed shadow slot=header><app-toolbar><h2 class=site-title><a href="../../"> アペフチ <paper-ripple></paper-ripple></a></h2></app-toolbar></app-header><article><header><paper-card><h1>Railsでの検索機能にgroonga-client-railsを使う（後編）</h1><time pubdate>2016-12-21</time><ul class=tags><li><a href="../../tags/ruby-on-rails.html" rel=tag>Ruby on Rails</a></li><li><a href="../../tags/groonga.html" rel=tag>Groonga</a></li></ul></paper-card></header><paper-card><p>アドベントカレンダー「<a href="http://qiita.com/advent-calendar/2016/groonga">Groonga Advent Calendar 2016</a>」の21日目です、書いているのは25日ですが……済みません</p><p>前回の<a href="18.html">Railsでの検索機能にgroonga-client-railsを使う（前編）</a>では、<a href="https://github.com/ranguba/groonga-client-rails">groonga-client-rails</a> gemを使って</p><ul><li>Groongaのデータベースを作ること</li><li>Railsのモデル操作とGroongaデータベースの同期を取ること</li></ul><p>をやりました。</p><p>後編の今日は、Groongaデータベースを使って、Railsアプリに検索機能を付けてみようと思います。</p><p>引き続きアプリケーションのリポジトリーをGitHubに置いています：<a href="https://github.com/KitaitiMakoto/groonga-client-rails-sample">KitaitiMakoto/groonga-client-rails-sample</a></p><h2 id=heading-2016-12-21-table-of-contents>目次</h2><ol><li><a href="#heading-2016-12-21-adding-route">ルーティングの追加</a></li><li><a href="#heading-2016-12-21-adding-search-action">検索アクションの追加</a></li><li><a href="#heading-2016-12-21-showing-search-result">検索結果の表示</a></li><li><a href="#heading-2016-12-21-adding-search-form">検索フォームの作成</a></li><li><a href="#heading-2016-12-21-highlighting-query">検索語のハイライト</a></li><li><a href="#heading-2016-12-21-advanced-search">高度な検索（カラムの指定、並び替え、ページネーション）</a></li></ol><h2 id=heading-2016-12-21-adding-route>ルーティングの追加</h2><p>検索用のルーティングを追加します。</p><ul><li><code class=highlighter-rouge>posts?q=xxx</code>と既存のコレクションリソースを使ってクエリーで検索機能を呼び出す</li><li><code class=highlighter-rouge>posts/search</code>と検索専用のリソースを追加する</li></ul><p>の二通りあり、アプリケーション全体のデザインで選ぶべき物だと思いますが、ここでは後者にします。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="c1"># config/routes.rb</span>

<span class="n">resources</span> <span class="ss">:posts</span> <span class="k">do</span>
  <span class="n">collection</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:search</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><h2 id=heading-2016-12-21-adding-search-action>検索アクションの追加</h2><p><code class=highlighter-rouge>PostsController</code>に検索アクションを追加します。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="c1"># app/controllers/posts_controller.rb</span>

<span class="k">def</span> <span class="nf">search</span>
  <span class="n">searcher</span> <span class="o">=</span> <span class="no">PostsSearcher</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">query</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:q</span><span class="p">]</span>
  <span class="k">if</span> <span class="n">query</span><span class="p">.</span><span class="nf">blank?</span>
    <span class="n">redirect_to</span> <span class="ss">action: </span><span class="s2">"index"</span>
    <span class="k">return</span>
  <span class="k">end</span>
  <span class="vi">@posts</span> <span class="o">=</span> <span class="n">searcher</span><span class="p">.</span><span class="nf">search</span><span class="p">.</span>
             <span class="nf">query</span><span class="p">(</span><span class="n">query</span><span class="p">).</span>
             <span class="nf">result_set</span><span class="p">.</span><span class="nf">records</span>
<span class="k">end</span>
</code></pre></div><p>（モデルの代わりに）サーチャークラスをインスタンス化し、クエリーを組み立てていきます。</p><p>検索の開始には<code class=highlighter-rouge>#search</code>メソッドを呼び出します。これでクエリー組み立ての準備が整います（クエリーオブジェクトが返されます）。</p><p><code class=highlighter-rouge>query</code>メソッドに文字列を渡すことで、検索語を認識させます。</p><p><code class=highlighter-rouge>result_set</code>を呼ぶとリモートのGroongaサーバーにHTTPリクエストを送って検索結果を取得します。</p><p><code class=highlighter-rouge>records</code>によって、それをRubyのオブジェクトに変換して返します。</p><h2 id=heading-2016-12-21-showing-search-result>検索結果の表示</h2><p>検索結果を表示します。<code class=highlighter-rouge>app/views/posts/index.html.erb</code>を<code class=highlighter-rouge>app/views/posts/search.html.erb</code>にコピーし、ActiveModel依存の所を書き換えます。</p><div class="language-erb highlighter-rouge"><pre class=highlight><code><span class="c">&lt;!-- app/views/posts/search.html.erb --&gt;</span>

<span class="nt">&lt;h1&gt;</span>Posts<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;table&gt;</span>
  <span class="nt">&lt;thead&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;th&gt;</span>Title<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;th&gt;</span>Body<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;th</span> <span class="na">colspan=</span><span class="s">"3"</span><span class="nt">&gt;&lt;/th&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/thead&gt;</span>

  <span class="nt">&lt;tbody&gt;</span>
    <span class="cp">&lt;%</span> <span class="vi">@posts</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="p">.</span><span class="nf">title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="p">.</span><span class="nf">body</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Show'</span><span class="p">,</span> <span class="n">post_path</span><span class="p">(</span><span class="n">extract_id</span><span class="p">(</span><span class="n">post</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Edit'</span><span class="p">,</span> <span class="n">edit_post_path</span><span class="p">(</span><span class="n">extract_id</span><span class="p">(</span><span class="n">post</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Destroy'</span><span class="p">,</span> <span class="n">post_path</span><span class="p">(</span><span class="n">extract_id</span><span class="p">(</span><span class="n">post</span><span class="p">)),</span> <span class="ss">method: :delete</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">confirm: </span><span class="s1">'Are you sure?'</span> <span class="p">}</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;/tr&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/tbody&gt;</span>
<span class="nt">&lt;/table&gt;</span>

<span class="nt">&lt;br&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'New Post'</span><span class="p">,</span> <span class="n">new_post_path</span> <span class="cp">%&gt;</span>
</code></pre></div><p><code class=highlighter-rouge>extract_id</code>は、レコードデータからIDを取り出すヘルパーです。これも自分で定義します。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="k">module</span> <span class="nn">PostsHelper</span>
  <span class="k">def</span> <span class="nf">extract_id</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
    <span class="n">post</span><span class="p">[</span><span class="s2">"_key"</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s2">"-"</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>Groongaでは、<code class=highlighter-rouge>_key</code>というカラムによって、レコードを一意に特定するのですが、groonga-client-rails（のデフォルト）では、「モデル名-連番」となる（<code class=highlighter-rouge>Post-1</code>）ので、そこからAcitiveRecordのIDに変換しています。</p><p>検索フォームはありませんが、これで一応機能はできました。http://localhost:3000/posts/search?q=Qiita などにアクセスすると、検索結果が見られると思います。</p><h2 id=heading-2016-12-21-adding-search-form>検索フォームの作成</h2><p>次にフォームです。<code class=highlighter-rouge>/posts/search</code>に<code class=highlighter-rouge>q</code>クエリー付きでGETアクセスを投げるだけなので簡単です。</p><div class="language-erb highlighter-rouge"><pre class=highlight><code><span class="c">&lt;!-- app/views/posts/_search_form.html.erb --&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_tag</span><span class="p">(</span><span class="n">search_posts_path</span><span class="p">,</span> <span class="ss">method: </span><span class="s2">"get"</span><span class="p">)</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">search</span> <span class="na">name=</span><span class="s">q</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:q</span><span class="p">]</span> <span class="cp">%&gt;</span><span class="s">"</span> <span class="na">required</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">submit_tag</span><span class="p">(</span><span class="s2">"Search"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div><p>これをそれぞれのテンプレートファイルに埋め込んでやります（省略）。</p><h2 id=heading-2016-12-21-highlighting-query>検索語のハイライト</h2><p>ただ、せっかくだから、検索語が分かりやすくなっていてほしいですよね。また、メモの全文をここで表示してしまうと、長過ぎるという場合もあると思います。両方をいっぺんに解決できる方法として、Groongaの<code class=highlighter-rouge>snippet_html</code>関数があります（<a href="http://groonga.org/ja/docs/reference/functions/snippet_html.html">7.14.17. snippet_html</a>）。</p><p>これは検索語の周辺数十文字（スニペット）を返してくれる関数です。更に、検索語を<code class=highlighter-rouge>&lt;span class="keyword"&gt;...&lt;/span&gt;</code>でマークアップしてくれます（HTML）。</p><p><code class=highlighter-rouge>snippet_html</code>を使うには、Groongaから取得するカラムにこれを指定します。groonga-client-railsはデフォルトで、モデルで設定したカラムを取得してくれます（なので<code class=highlighter-rouge>title</code>と<code class=highlighter-rouge>body</code>が取れていた）。これをカスタマイズするには、クエリーに<code class=highlighter-rouge>output_columns</code>というパラメーターを追加する必要があります（<a href="http://groonga.org/ja/docs/reference/commands/select.html#output-columns">7.3.54.4.4.1. output_columns</a>）。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="c1"># app/controllers/posts_controller.rb</span>

  <span class="vi">@posts</span> <span class="o">=</span> <span class="n">searcher</span><span class="p">.</span><span class="nf">search</span><span class="p">.</span>
             <span class="nf">query</span><span class="p">(</span><span class="n">query</span><span class="p">).</span>
             <span class="nf">output_columns</span><span class="p">(</span><span class="s1">'_key,title,snippet_html(body)'</span><span class="p">).</span>
             <span class="nf">result_set</span><span class="p">.</span><span class="nf">records</span>
</code></pre></div><p>これで、「<code class=highlighter-rouge>body</code>カラムでの検索結果にはスニペットを取得する」という意味になります。</p><p>これに合わせてビューも変えなくてはいけません。</p><div class="language-erb highlighter-rouge"><pre class=highlight><code>        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span><span class="o">=</span> <span class="n">post</span><span class="p">.</span><span class="nf">snippet_html</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"&lt;br&gt;"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
</code></pre></div><p>HTMLを埋め込むので<code class=highlighter-rouge>=</code>を<code class=highlighter-rouge>==</code>にしています。また、結果は配列になっているので（一つのメモの離れた所に検索語がある場合、それぞれの周辺を取得します）改行で接続します。</p><p>先述の通り、検索語はマークアップされるので、スタイリングしましょう。</p><div class="language-css highlighter-rouge"><pre class=highlight><code><span class="c">/* app/assets/stylesheets/posts.scss */</span>

<span class="nc">.keyword</span> <span class="p">{</span>
  <span class="nl">font-weight</span><span class="p">:</span> <span class="nb">bolder</span><span class="p">;</span>
  <span class="nl">color</span><span class="p">:</span> <span class="no">red</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>これで、検索語が赤い太字になりました。</p><p>何とか見られる結果になったんではないでしょうか。 <img src="https://gyazo.com/2cc4ffc1487555bbd51fe768f6c7fcac.png" alt=""/></p><h2 id=heading-2016-12-21-advanced-search>高度な検索（カラムの指定、並び替え、ページネーション）</h2><p>Groongaでは、検索の際に様々な条件を付け加えたり、結果を加工したりできます。機能の詳細はドキュメント（<a href="http://groonga.org/ja/docs/reference/commands/select.html">7.3.54. select</a>）に譲りますが、ここでは以下の三つに対応してみましょう。</p><dl><dt>match_columns</dt><dd>検索に使用するカラムを試定。例えば「検索語がタイトルに含まれる場合のみ表示する」など。</dd><dt>sortby</dt><dd>指定したカラムで並び替える。</dd><dt>paginate</dt><dd>検索結果が多過ぎる場合にページネーションします。</dd></dl><p>と言っても簡単で、クエリーオブジェクトから、それぞれのメソッドを呼び出すだけです。</p><div class="language-ruby highlighter-rouge"><pre class=highlight><code><span class="c1"># app/controllers/posts_controller.rb</span>

  <span class="vi">@posts</span> <span class="o">=</span> <span class="n">searcher</span><span class="p">.</span><span class="nf">search</span><span class="p">.</span>
             <span class="nf">query</span><span class="p">(</span><span class="n">query</span><span class="p">).</span>
             <span class="nf">output_columns</span><span class="p">(</span><span class="s1">'_key,title,snippet_html(body)'</span><span class="p">)</span>
  <span class="p">[</span><span class="ss">:match_columns</span><span class="p">,</span> <span class="ss">:sortby</span><span class="p">,</span> <span class="ss">:paginate</span><span class="p">].</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">param</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">].</span><span class="nf">present?</span>
      <span class="vi">@posts</span> <span class="o">=</span> <span class="vi">@posts</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="vi">@posts</span> <span class="o">=</span> <span class="vi">@posts</span><span class="p">.</span><span class="nf">result_set</span><span class="p">.</span><span class="nf">records</span>
</code></pre></div><p>これにフォームを対応させれば出来上がりです。</p><p>例えば、タイトルで並び替えした場合はこうなります。 <img src="https://gyazo.com/969feded70e51520aab4962369291908.png" alt=""/></p><p>並び順を逆にするには、カラム名の前にマイナス記号（<code class=highlighter-rouge>-</code>）を付けます。 <img src="https://gyazo.com/b117f1fc42863df60684437bcc2298c5.png" alt=""/></p><p>どうでしたか、groonga-client-railsは、無理にActiveModel風にしない所が気に入っていたりします……と言っている間に、開発者の<a href="https://github.com/kou">@kou</a>さんがよりちゃんとした記事を書いていました、締め切り破って済みませんでした……。</p><p>» <a href="http://www.clear-code.com/blog/2016/12/22.html">Ruby on RailsでMySQL・PostgreSQL・SQLite3とGroongaを使って日本語全文検索を実現する方法</a></p></paper-card><footer><ul><li class=next><a href="24.html" rel=next><paper-button raised>アドカレ #コルクおすすめ2016 24日目 センター試験直前に、三田紀房『ドラゴン桜』後半</paper-button></a></li><li class=prev><a href="18.html" rel=prev><paper-button raised>Railsでの検索機能にgroonga-client-railsを使う（前編）</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></article></app-header-layout></main><script defer async src="//hypothes.is/embed.js"></script><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>