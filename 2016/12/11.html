<!DOCTYPE html><html><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>[Polymer][Webコンポーネント]Polymerを2.0 Previewに上げた | アペフチ</title><script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script><link href="../../components/elements.vulcanized.html" rel=import /><link rel=alternate type="application/atom+xml" title="アペフチ" href="../../recent-days.atom"/><link href="../../bower_components/sanitize-css/sanitize.css" rel=stylesheet /><link href="../../stylesheets/highlight-81ca03d6.css" rel=stylesheet /><script src="../../javascripts/all-d7c52391.js"></script><link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/><link href="../../images/favicon-8d71db77.png" rel=icon type="image/png" size=60x60 /><link href="/apehuci/manifest.json" rel=manifest><meta name=theme-color content="#b71c1c"><meta name=og:title content="[Polymer][Webコンポーネント]Polymerを2.0 Previewに上げたPolymerを2.0 Previewに上げた"><meta name=twitter:description content="この日記ではPolymerを使っているのだけど、1.xから2.0 Previewに上げた。その時にやったことやはまったことなど。 目次 前提 参考ドキュメント ライブラリーのアップグレード Paper Elements コードの修正 webcomponentsjsなど paper-header-panel dom-module 動的に挿入される要素のスタイリン..."><meta name=twitter:card content=summary><meta name=twitter:site content=@KitaitiMakoto><meta name=twitter:image content="https://kitaitimakoto.github.io/apehuci/images/icon-bbe8ac52.png"></head><body class="x2016 x2016_12 x2016_12_11"><blog-router base-regex="^/apehuci/"></blog-router><main><app-header-layout><app-header fixed shadow slot=header><app-toolbar><h2 class=site-title><a href="../../"> アペフチ <paper-ripple></paper-ripple></a></h2></app-toolbar></app-header><article><header><paper-card><h1>Polymerを2.0 Previewに上げた</h1><time pubdate>2016-12-11</time><ul class=tags><li><a href="../../tags/polymer.html" rel=tag>Polymer</a></li><li><a href="../../tags/web.html" rel=tag>Webコンポーネント</a></li></ul></paper-card></header><paper-card><p>この日記では<a href="https://www.polymer-project.org/">Polymer</a>を使っているのだけど、1.xから<a href="https://www.polymer-project.org/2.0/docs/about_20">2.0</a> Previewに上げた。その時にやったことやはまったことなど。</p><h2 id=section>目次</h2><ol><li><a href="#heading-2016-12-11-assumption">前提</a><ol><li><a href="#heading-2016-12-11-references">参考ドキュメント</a></li></ol></li><li><a href="#heading-2016-12-11-upgrading-libraries">ライブラリーのアップグレード</a><ol><li><a href="#heading-2016-12-11-upgrading-paper-elements">Paper Elements</a></li></ol></li><li><a href="#heading-2016-12-11-modifying-existing-code">コードの修正</a><ol><li><a href="#heading-2016-12-11-changing-file-webcomponentsjs">webcomponentsjsなど</a></li><li><a href="#heading-2016-12-11-upgrading-paper-header-panel">paper-header-panel</a></li><li><a href="#heading-2016-12-11-removing-is-from-dom-module">dom-module</a></li><li><a href="#heading-2016-12-11-styling-dynamic-inserted-elements">動的に挿入される要素のスタイリング</a></li><li><a href="#heading-2016-12-11-fixing-paper-card-paper-button-error">paper-cardとpaper-buttonのエラー</a></li></ol></li></ol><h2 id=heading-2016-12-11-assumption>前提</h2><p>まず、Polymerを使っていると言うけど、<a href="http://webcomponents.org/">Webコンポーネント</a>用ライブラリー（フレームワーク）としての他、Googleが提唱するUIデザインであるマテリアルデザイン用のコンポーネント（<a href="https://elements.polymer-project.org/browse?package=paper-elements">Paper Elements</a>）なども使っていた。そのうち<a href="https://elements.polymer-project.org/elements/paper-card">Paper Card</a>ではまったりしたのでまずここで断っておく。</p><p>また、自分で作ったコンポーネントは一つだけで、フッターに置いてある検索ボックス用の<code class=highlighter-rouge>blog-search</code>という要素のみ。これの書き換えについても触れる。</p><h3 id=heading-2016-12-11-references>参考ドキュメント</h3><dl><dt><a href="https://www.polymer-project.org/2.0/docs/about_20">https://www.polymer-project.org/2.0/docs/about_20</a></dt><dd>Polymer 2.0になって変わったことの概要。</dd><dt><a href="https://www.polymer-project.org/2.0/docs/upgrade">https://www.polymer-project.org/2.0/docs/upgrade</a></dt><dd>Polymer 1.xから2.0へアップグレードする時のガイド。</dd><dt><a href="https://codelabs.developers.google.com/codelabs/polymer-2-carousel/">https://codelabs.developers.google.com/codelabs/polymer-2-carousel/</a></dt><dd>Polymer 2.0でコンポーネントを作るチュートリアル。</dd></dl><h2 id=heading-2016-12-11-upgrading-libraries>ライブラリーのアップグレード</h2><p><a href="https://github.com/KitaitiMakoto/apehuci/commit/8bd0c722cdeea984948ee4ebc89f5a3dfd5c74ca">https://github.com/KitaitiMakoto/apehuci/commit/8bd0c722cdeea984948ee4ebc89f5a3dfd5c74ca</a></p><h3 id=heading-2016-12-11-upgrading-paper-elements>Paper Elements</h3><p><a href="https://www.polymer-project.org/2.0/docs/about_20#installing">概要ページのインストールの項目</a>にあるように、Polymerは</p><div class="language-shell highlighter-rouge"><pre class=highlight><code>bower install --save Polymer/polymer#2.0-preview
</code></pre></div><p>でアップグレードできる。 この時に選択肢が出てくるが、Polymerは2.0、webcomponentsjsは1.0を選んでおけばよい。</p><p>各コンポーネントをインストールするにも同様に、各コンポーネントの<code class=highlighter-rouge>2.0-preview</code>ブランチをインストールすればいい。これまでは<code class=highlighter-rouge>paper-elements</code>という全体をまとめたコンポーネントがあって、それをインストールするだけで全Paper Elementがインストールできたのだけど、なぜか<code class=highlighter-rouge>2.0-preview</code>ブランチはないので、自分が使っている物を個別にインストール必要があった。めんどくさい（イシューは上がってる、と思ったのだけど、今探したら無いな、幻か知ら）。</p><p>あと、</p><div class="language-shell highlighter-rouge"><pre class=highlight><code>bower install --save paper-input#2.0-preview
</code></pre></div><p>みたいに、既存の物を<code class=highlighter-rouge>2.0-preview</code>にアップグレードすればいいコンポーネントと、</p><div class="language-shell highlighter-rouge"><pre class=highlight><code>bower install --save PaperElements/paper-card#2.0-preview
</code></pre></div><p>みたいに、GitHubのオーガニゼーションも明示しないといけないコンポーネントがある。<a href="https://github.com/Polymer/paper-card">Polymer/paper-card</a>を見てみて、<code class=highlighter-rouge>2.0-preview</code>ブランチがなければ<a href="https://github.com/PolymerElements/paper-card">PolymerElements/paper-card</a>を見る、ということをしなくてはならず、これもめんどくさい。</p><h3 id=heading-2016-12-11-changing-file-webcomponentsjs>webcomponentsjsなど</h3><p>webcomponentsjsなどは、パッケージその物はPolymerアップグレードの時に一緒に自動でアップグレードされるのだけど、Polymerが使うファイルが変わっていることがある。例えば<code class=highlighter-rouge>webcomponents.min.js</code>というファイルを使っていたのが<code class=highlighter-rouge>webcomponents-lite.js</code>に変わっていたりするので、コンソールのエラーメッセージを見ながら参照先を変えていく。</p><h2 id=heading-2016-12-11-modifying-existing-code>コードの修正</h2><p>アップグレードに伴って、いくつか既存のコードを修正する必要があった。大体は<a href="https://www.polymer-project.org/2.0/docs/upgrade">アップグレードガイド</a>に従えばいいが、幾つか嵌った所。</p><h3 id=heading-2016-12-11-upgrading-paper-header-panel>paper-header-panel</h3><p>コンポーネントをアップグレードしたら画面が真っ白になってしまった。</p><p>この日記の大部分は<a href="https://elements.polymer-project.org/elements/paper-header-panel">paper-header-panel</a>の中に入っているのだけど、これの使い方が変わっていて、そのせいだった。子要素を配置するための<a href="https://www.polymer-project.org/2.0/docs/upgrade#replace-content-elements">slot</a>（従来はcontent）に<code class=highlighter-rouge>name</code>属性で名前が付くようになって、ユーザー（＝僕）が配置する子要素にも、対応する名前を付けておかなければいけなくなっていた。一応、<code class=highlighter-rouge>paper-header-panel</code>のソースコードコメントにはそのことが書いてある： <a href="https://github.com/PolymerElements/paper-header-panel/blob/226e265f151dfd229c68780626342dd2b6295f6f/paper-header-panel.html#L32-L37">paper-header-panel.html#L32-L37</a></p><p>これに合わせてテンプレートを修正した（<code class=highlighter-rouge>slot</code>属性を足しているのに注目）：</p><p>Before：</p><div class="language-html highlighter-rouge"><pre class=highlight><code><span class="nt">&lt;paper-header-panel</span> <span class="na">mode=</span><span class="s">waterfall-tall</span><span class="nt">&gt;</span>
  <span class="nt">&lt;paper-toolbar&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;/paper-toolbar&gt;</span>
  <span class="nt">&lt;main&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;/main&gt;</span>
  <span class="nt">&lt;footer&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;/footer&gt;</span>
<span class="nt">&lt;/paper-header-panel&gt;</span>
</code></pre></div><p>After：</p><div class="language-html highlighter-rouge"><pre class=highlight><code><span class="nt">&lt;paper-header-panel</span> <span class="na">mode=</span><span class="s">waterfall-tall</span><span class="nt">&gt;</span>
  <span class="nt">&lt;paper-toolbar</span> <span class="na">slot=</span><span class="s">header</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;/paper-toolbar&gt;</span>
  <span class="nt">&lt;main</span> <span class="na">slot=</span><span class="s">content</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;/main&gt;</span>
  <span class="nt">&lt;footer</span> <span class="na">slot=</span><span class="s">content</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;/footer&gt;</span>
<span class="nt">&lt;/paper-header-panel&gt;</span>
</code></pre></div><h3 id=heading-2016-12-11-removing-is-from-dom-module>dom-module</h3><p>カスタム要素を定義するのに使う<a href="https://www.polymer-project.org/1.0/docs/devguide/local-dom#template-stamping">dom-module</a>という要素（メタ要素？）をPolymerは提供している。カスタム要素の定義は本来JavaScriptでやるのだけど、<code class=highlighter-rouge>dom-module</code>を使うとHTMLを使ってある程度宣言的にできて、僕はこのアプローチを気に入っている。</p><p>自分で作ったカスタム要素である<code class=highlighter-rouge>blog-search</code>はこの<code class=highlighter-rouge>dom-module</code>で定義しているのだけど、その時に、<code class=highlighter-rouge>dom-module</code>に<code class=highlighter-rouge>is</code>属性を付けていた。</p><div class="language-html highlighter-rouge"><pre class=highlight><code><span class="nt">&lt;dom-module</span> <span class="na">is=</span><span class="s">blog-search</span> <span class="na">id=</span><span class="s">blog-search</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;/dom-module&gt;</span>
</code></pre></div><p><code class=highlighter-rouge>is</code>というのは、その要素（ここでは<code class=highlighter-rouge>dom-module</code>）を更に拡張したバージョンの要素を使う、という時に使う物で、例えばオートコンプリート機能を追加した検索インプットを作って</p><div class="language-html highlighter-rouge"><pre class=highlight><code><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">search</span> <span class="na">is=</span><span class="s">auto-complete</span><span class="nt">&gt;</span>
</code></pre></div><p>などとして使う（ちなみにブラウザーベンダー間で要不要の意見が割れているらしいので、この仕様はなくなるかも）。</p><p><code class=highlighter-rouge>dom-module</code>を使う時には<code class=highlighter-rouge>is</code>属性は不要なので、ここでは使い方が間違っているのだけど、問題なく動いていた。単に無視されていたのだろうと思う。2.0 Previewに上げても同様に動いていたのだけど、Chromeで全く動かない（<code class=highlighter-rouge>blog-search</code>の定義自体が失敗している）ことに気が付いた。<code class=highlighter-rouge>is</code>を外すと動いたので、ChromeがネイティブでWebコンポーネントに対応しているのと関係していそうだが調べていない（他のブラウザーでは、現在のところ、Webコンポーネントの多くの機能がpolyfillやshimで動いている）。</p><h4 id=section-1>追記</h4><p><code class=highlighter-rouge>is</code>は、Polymer 1.xの頃には必要（正確には<code class=highlighter-rouge>name</code>または<code class=highlighter-rouge>is</code>が必要）だったので、<code class=highlighter-rouge>is</code>を使っていたのは正しかった。単に、2.0にする時に外し、<code class=highlighter-rouge>id</code>を付与する必要がるということだった。</p><h3 id=heading-2016-12-11-styling-dynamic-inserted-elements>動的に挿入される要素のスタイリング</h3><p>この日記の検索機能では、<code class=highlighter-rouge>XMLHttpRequest</code>で<a href="http://groonga.org/ja/docs/reference/executables/groonga-httpd.html">groonga-httpd</a> （NginxのGroongaモジュール）から検索結果を取得し、DOMツリー内に挿入している（参考：<a href="../02/07.html">日記に検索機能をつけた</a>）。Groongaが検索キーワードに<code class=highlighter-rouge>keyword</code>というクラスを付けてくれるので、赤い太字になるようスタイリングしていた。</p><div class="language-css highlighter-rouge"><pre class=highlight><code><span class="nc">.keyword</span> <span class="p">{</span>
  <span class="nl">color</span><span class="p">:</span> <span class="no">red</span><span class="p">;</span>
  <span class="nl">font-weight</span><span class="p">:</span> <span class="nb">bolder</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>Chromeでスタイリングされなくなった。これは、ChromeがShadow DOMを実装していて、Polymerもそのネイティブ実装を活かしている、つまり外部でのスタイル宣言がShadow DOM内に影響を及ぼしていないからだと思う。Webコンポーネントの大きな特長がこのカプセル化なのでむしろ歓迎すべき変更。というわけで、喜んで、Shadow DOMに閉じたスタイリングに変更した。</p><div class="language-html highlighter-rouge"><pre class=highlight><code><span class="nt">&lt;dom-module</span> <span class="na">id=</span><span class="s">blog-search</span><span class="nt">&gt;</span>
  <span class="nt">&lt;template&gt;</span>
    <span class="nt">&lt;style&gt;</span>
      <span class="c">/* ... */</span>

      <span class="nc">.keyword</span> <span class="p">{</span>
        <span class="nl">color</span><span class="p">:</span> <span class="n">var</span><span class="p">(</span><span class="n">--keyword-color</span><span class="p">,</span> <span class="no">red</span><span class="p">);</span>
        <span class="nl">font-weight</span><span class="p">:</span> <span class="n">var</span><span class="p">(</span><span class="n">--keyword-font-weight</span><span class="p">,</span> <span class="nb">bolder</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>
  <span class="nt">&lt;/template&gt;</span>
  <span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;/dom-module&gt;</span>
</code></pre></div><p>すると、今度はFirefoxでスタイルが外れてしまった。</p><p>FirefoxではShadow DOMが実装されておらずshimを使っている。具体的にはHTMLの<code class=highlighter-rouge>style</code>要素に、Shadow DOM内に閉じているのとある程度同等のスタイル宣言をして、それを持ってスコープ付きのスタイリングとしている。</p><div class="language-html highlighter-rouge"><pre class=highlight><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
    <span class="nt">&lt;style&gt;</span>
      <span class="c">/* ... */</span>

      <span class="nc">.keyword.blog-search</span> <span class="p">{</span>
        <span class="nl">color</span><span class="p">:</span> <span class="n">var</span><span class="p">(</span><span class="n">--keyword-color</span><span class="p">,</span> <span class="no">red</span><span class="p">);</span>
        <span class="nl">font-weight</span><span class="p">:</span> <span class="n">var</span><span class="p">(</span><span class="n">--keyword-font-weight</span><span class="p">,</span> <span class="nb">bolder</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
</code></pre></div><p>このスタイル宣言を活かすために行われるのが、「要素名と同じクラスを追加する」という処理だ。</p><div class="language-html highlighter-rouge"><pre class=highlight><code> <span class="nt">&lt;blog-search&gt;</span>
  <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;paper-input</span> <span class="err">...</span> <span class="na">class=</span><span class="s">"style-scope blog-search"</span> <span class="err">...</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;/paper-input&gt;</span>
  <span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;/blog-search&gt;</span>
</code></pre></div><p>（<code class=highlighter-rouge>class</code>に<code class=highlighter-rouge>blog-search</code>が追加されている）</p><p>元々HTML内に書かれているタグであれば、このようにPolymerが自動でクラスを追加してくれるのだが、検索結果のように、動的に挿入される要素ではそうはいかない。仕方がないので、挿入する時に自分でクラスを追加するようにした。</p><div class="language-javascript highlighter-rouge"><pre class=highlight><code><span class="c1">// ...</span>
<span class="nl">snippetHtml</span><span class="p">:</span> <span class="nx">article</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">"&lt;br&gt;"</span><span class="p">).</span>
  <span class="nx">replace</span><span class="p">(</span><span class="s1">'&lt;span class="keyword"&gt;'</span><span class="p">,</span> <span class="s1">'&lt;span class="keyword style-scope blog-search"&gt;'</span><span class="p">),</span>
<span class="c1">// ...</span>
</code></pre></div><p>文字列処理なので乱暴だが、この場合はセキュリティホールにはならない（はず）。</p><p>「Firefoxはカスタムプロパティには対応しているんだからそっち使ってくれればいいんだけどなあ」とちょっと釈然としないが、まあ、過渡期ということで仕方ないのだろう。</p><h3 id=heading-2016-12-11-fixing-paper-card-paper-button-error>paper-cardとpaper-buttonのエラー</h3><p><code class=highlighter-rouge>paper-card</code>と<code class=highlighter-rouge>paper-button</code>が（例によって）Chromeでだけ動かない。</p><blockquote><p>Uncaught DOMException: Failed to construct 'CustomElement': The result must not have attributes</p></blockquote><p>というエラーが出てしまっている。</p><p>ググるとStack Overflowがヒットして（<a href="http://stackoverflow.com/questions/40181683/failed-to-execute-createelement-on-document-the-result-must-not-have-childr">Failed to execute 'createElement' on 'Document': The result must not have children</a>）、見ると<code class=highlighter-rouge>created</code>（新しくは<code class=highlighter-rouge>constructor</code>）コールバックの使い方が、新しいCustom Elements仕様としては不正なようだ。しようがないのでフォークしてここを<code class=highlighter-rouge>ready</code>コールバックに書き換えて対応とした。イシューも上げた（<a href="https://github.com/PolymerElements/paper-card/issues/90">2.0-preview throw an error Uncaught DOMException: Failed to construct 'CustomElement': The result must not have attributes #90</a>）。</p><p><code class=highlighter-rouge>ready</code>はCustom Elements標準にはなく、Polymer独自のコールバック。1.xの時代から存在していて、2.0でも残るようなので（<a href="https://www.polymer-project.org/2.0/docs/about_20#lifecycle-changes">Lifecycle changes</a>）、<code class=highlighter-rouge>blog-search</code>でも使っていたがそのままにしてある。</p><h4 id=section-2>追記</h4><p>これは<code class=highlighter-rouge>paper-card</code>や<code class=highlighter-rouge>paper-button</code>ではなく、<a href="https://github.com/Polymer/vulcanize">vulcanize</a>の問題だということが分かった（<a href="https://github.com/PolymerElements/paper-card/issues/90">PolymerElements/paper-card/issues/90</a>）。どうもJavaScriptのclass構文で定義した物ををvulcanizeがうまく扱えないということみたい。なので2.0でclass構文使う際には注意されたい。</p><hr/><p>こんなところかな。あとは公式の<a href="https://www.polymer-project.org/2.0/docs/upgrade">アップグレードガイド</a>に従えばいいことばかりだった。</p><p>コミットログを見るとコードレベルで何をやっているかが分かると思う： <a href="https://github.com/KitaitiMakoto/apehuci/commits/master">https://github.com/KitaitiMakoto/apehuci/commits/master</a></p></paper-card><footer><ul><li class=next><a href="18.html" rel=next><paper-button raised>Railsでの検索機能にgroonga-client-railsを使う（前編）</paper-button></a></li><li class=prev><a href="02.html" rel=prev><paper-button raised>アドカレ #コルクおすすめ2016 二日目 おすすめファンタジーまんが五選</paper-button></a></li></ul><paper-card><blog-search url="https://search.apehuci.kitaitimakoto.net/d" base=/apehuci/ table=Apehuci debounce-duration=300></blog-search></paper-card><paper-card> &copy; <a class=copy href="https://twitter.com/KitaitiMakoto">北市真</a></paper-card></footer></article></app-header-layout></main><script defer async src="//hypothes.is/embed.js"></script><script async="" src="//platform.twitter.com/widgets.js" charset=utf-8></script></body></html>